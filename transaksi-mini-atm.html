<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Transaksi Mini-ATM | AMKO</title>
  <style>
    :root{
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --muted:#64748b; --txt:#0f172a;
      --shadow:0 6px 18px rgba(15,23,42,.08);
      --touch:48px; --radius:16px; --safe-bottom: env(safe-area-inset-bottom, 0);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);-webkit-tap-highlight-color: transparent}
    button,input,select,textarea{font-family:inherit}

    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px;line-height:1.2}
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--pri);color:#fff}

    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f9fafb;font-size:12px}

    .topbar{position:sticky;top:54px;z-index:9;background:linear-gradient(#fff,#fff 75%,transparent);padding:12px 16px;border-bottom:1px solid var(--bd)}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:12px 12px;font-size:16px;height:var(--touch);outline:none}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:var(--touch)}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-blue{background:#2563eb;color:#fff}
    .btn-gray{background:#eef2f6}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b}
    .btn-sm{height:36px;padding:6px 10px;border-radius:10px;font-weight:700}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--bd);padding:8px 10px;border-radius:999px;background:#fff;font-size:12px;cursor:pointer}
    .chip.active{background:#0b63f3;color:#fff;border-color:#0b63f3}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin:12px 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:22px;box-shadow:var(--shadow);padding:16px}
    .card h3{margin:0 0 6px 0}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--bd);font-size:14px;text-align:left;vertical-align:top}
    th{background:#f8fafc}

    .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
    .modal.show{display:flex}
    .dialog{width:min(820px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:92vh}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    .icon-input{display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff;min-height:var(--touch)}
    .icon-input input,.icon-input select,.icon-input textarea{border:none;outline:none;flex:1;font-size:16px;background:transparent}
    .icon-input textarea{min-height:96px;resize:vertical}
    .dlg-ft{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--bd);padding:12px 16px;display:flex;gap:8px;justify-content:flex-end}

    @media (max-width: 900px){
      .layout{grid-template-columns:1fr}
      .sidebar{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:11}
      .brand{margin:0}
      .topbar{top:56px;padding:10px 12px}
      header{padding:10px}
      .dialog{width:100%;height:100%;max-height:none;border-radius:0}
      .dlg-bd{padding:12px;gap:10px}
      .row{grid-template-columns:1fr}
    }

    .fab{position:fixed;right:14px;bottom:calc(14px + var(--safe-bottom));width:56px;height:56px;border-radius:999px;background:#0b63f3;color:#fff;display:none;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(11,99,243,.35);z-index:15;font-size:26px;font-weight:900}

    /* KPI cards */
    .kpi-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px}
    @media(min-width:560px){ .kpi-grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:900px){ .kpi-grid{grid-template-columns:repeat(5,1fr)} }
    .kpi-card{background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);padding:12px;display:flex;flex-direction:column;gap:6px}
    .kpi-title{font-size:12px;color:#475569}
    .kpi-value{font-size:18px;font-weight:800}
    .kpi-sub{font-size:11px;color:#6b7280}

    /* Highlight KPI Omset & Profit */
    .kpi-card.kpi-omset  { border-left:4px solid #6366f1; }
    .kpi-card.kpi-omset .kpi-value{ font-size:20px; }
    .kpi-card.kpi-profit { border-left:4px solid #16a34a; background:linear-gradient(180deg,#f0fdf4, #ffffff 55%); }
    .kpi-card.kpi-profit .kpi-title{ color:#166534; }
    .kpi-card.kpi-profit .kpi-value{ font-size:22px; }

    /* filter bar */
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 16px 0 16px}
    .date{height:40px;padding:8px 10px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    .sep{color:#94a3b8}
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="brand">AMKO</div>
    <nav class="nav" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="master-saldo-akun.html">üí≥ Master Akun</a>
      <a class="active" href="transaksi-mini-atm.html">üèß Mini ATM</a>
      <a href="#" id="lnk-logout">üö™ Logout</a>
    </nav>
  </aside>

  <div>
    <header>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Transaksi Mini-ATM</h2>
        <span class="pill" style="font-size:11px">Owner bisa pilih cabang ‚Ä¢ Non-owner terkunci cabang profil</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="me" class="pill">memuat‚Ä¶</div>
        <div id="roleBadge" class="pill">role: ‚Ä¶</div>
        <div id="branchBadge" class="pill">branch: ‚Ä¶</div>
      </div>
    </header>

    <div class="topbar">
      <!-- Dropdown cabang (owner only) -->
      <div id="branchRow" style="display:none; margin-bottom:10px; gap:8px; align-items:center; flex-wrap:wrap">
        <span style="font-size:12px;color:#475569;">Cabang</span>
        <select id="branchSelect" class="input" style="width:260px;max-width:100%">
          <option value="">Memuat cabang‚Ä¶</option>
        </select>
        <button id="btnTambah" class="btn btn-primary">+ Tambah Transaksi</button>
      </div>

      <!-- Filter Jenis -->
      <div class="chips">
        <div class="chip active" data-j="all">Semua</div>
        <div class="chip" data-j="tarik">Tarik Tunai</div>
        <div class="chip" data-j="transfer">Transfer</div>
        <div class="chip" data-j="pulsa">Pulsa</div>
        <div class="chip" data-j="jasa">Jasa</div>
      </div>
    </div>

    <!-- FILTER TANGGAL + EXPORT -->
    <div class="filters">
      <button class="btn-sm btn-ghost" id="presetToday">Hari ini</button>
      <button class="btn-sm btn-ghost" id="preset7">7H</button>
      <button class="btn-sm btn-ghost" id="preset30">30H</button>
      <span class="sep">|</span>
      <input type="date" id="dateFrom" class="date">
      <span>‚Äì</span>
      <input type="date" id="dateTo" class="date">
      <button class="btn-sm btn-blue" id="applyRange">Terapkan</button>
      <span class="pill" id="activeRangeLabel">Rentang: -</span>
      <div style="flex:1"></div>
      <button class="btn-sm btn-primary" id="btnExport">Export Excel</button>
    </div>

    <div class="grid">
      <!-- KPI Transaksi -->
      <div class="card">
        <h3 style="margin-bottom:10px">KPI Transaksi <span id="kpiTglLabel" class="pill" style="margin-left:8px">Hari ini</span></h3>
        <div class="kpi-grid">
          <div class="kpi-card kpi-omset">
            <div class="kpi-title">Omset</div>
            <div id="kpi_omset" class="kpi-value">Rp 0</div>
            <div class="kpi-sub">Œ£ nominal</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Tarik Tunai</div>
            <div id="kpi_tarik" class="kpi-value">Rp 0</div>
            <div class="kpi-sub">jenis=tarik</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Transfer</div>
            <div id="kpi_transfer" class="kpi-value">Rp 0</div>
            <div class="kpi-sub">jenis=transfer</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Fee Bank</div>
            <div id="kpi_fee" class="kpi-value">Rp 0</div>
            <div class="kpi-sub">Œ£ fee_bank</div>
          </div>
          <div class="kpi-card kpi-profit" id="kpi_profit_wrap" style="display:none">
            <div class="kpi-title">Profit <span class="kpi-sub">(owner only)</span></div>
            <div id="kpi_profit" class="kpi-value">Rp 0</div>
            <div class="kpi-sub">Œ£ (adm_dlm+adm_luar‚àífee)</div>
          </div>
        </div>
      </div>

      <!-- KPI Master Saldo Akun (DINAMIS) -->
      <div class="card">
        <h3 style="margin-bottom:10px">KPI Master Saldo Akun</h3>
        <div id="kpiSaldoWrap" class="kpi-grid"></div>
      </div>

      <!-- Riwayat -->
      <div class="card">
        <h3>Riwayat Transaksi</h3>
        <table>
          <thead>
            <tr>
              <th>No urut</th>
              <th>User & Tanggal</th>
              <th>id trx</th>
              <th>Sumber Dana</th>
              <th>Jenis</th>
              <th>Saldo Awal</th>
              <th>Nominal</th>
              <th>Admin Dalam</th>
              <th>Admin Luar</th>
              <th>Fee Bank</th>
              <th>Saldo Akhir</th>
              <th>Keterangan</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<button id="fabAdd" class="fab" title="Tambah">+</button>

<!-- MODAL PILIH JENIS -->
<div class="modal" id="modalJenis">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Pilih Jenis Transaksi</span>
      <button class="btn btn-ghost" id="xJenis" style="height:40px">‚úñ</button>
    </div>
    <div class="dlg-bd" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <button class="btn btn-blue" data-pilih="tarik">Tarik Tunai</button>
      <button class="btn btn-blue" data-pilih="transfer">Transfer</button>
      <button class="btn btn-blue" data-pilih="pulsa">Pulsa</button>
      <button class="btn btn-blue" data-pilih="jasa">Jasa</button>
    </div>
    <div class="dlg-ft">
      <button class="btn btn-gray" id="batalJenis">Batal</button>
    </div>
  </div>
</div>

<!-- MODAL FORM TRANSAKSI -->
<div class="modal" id="modalForm">
  <div class="dialog">
    <div class="dlg-hd">
      <span id="dlgTitle">Form Transaksi</span>
      <button class="btn btn-ghost" id="xForm" style="height:40px">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div id="msgErr" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px"></div>

      <div class="row">
        <div>
          <label>Jenis</label>
          <div class="icon-input"><span>üìÇ</span>
            <input id="f_jenis" readonly />
          </div>
        </div>
        <div>
          <label>Cabang</label>
          <div class="icon-input"><span>üè¨</span>
            <input id="f_branch" readonly />
          </div>
        </div>
      </div>

      <div class="row" id="rowSumber">
        <div>
          <label>Sumber Dana</label>
          <div class="icon-input"><span>‚ÜóÔ∏è</span>
            <select id="f_sumber"></select>
          </div>
        </div>
        <div>
          <label>Terima Dana</label>
          <div class="icon-input"><span>‚ÜòÔ∏è</span>
            <select id="f_terima"></select>
          </div>
        </div>
      </div>

      <!-- ROW NOMINAL -->
      <div class="row" id="rowNominal">
        <div>
          <label id="labelNominal">Nominal (Rp)</label>
          <div class="icon-input"><span>Rp</span>
            <input id="f_nom" inputmode="numeric" placeholder="0" />
          </div>
        </div>
      </div>

      <!-- ROW ADMIN DALAM & LUAR (dua kolom) -->
      <div class="row" id="rowAdminDua">
        <div>
          <label>Admin Dalam</label>
          <div class="icon-input"><span>üí∏</span>
            <input id="f_admin_dalam" inputmode="numeric" placeholder="0" />
          </div>
        </div>
        <div>
          <label>Admin Luar</label>
          <div class="icon-input"><span>üí∏</span>
            <input id="f_admin_luar" inputmode="numeric" placeholder="0" />
          </div>
        </div>
      </div>

      <!-- ROW ADMIN LUAR SAJA -->
      <div class="row" id="rowAdminLuarOnly" style="display:none">
        <div>
          <label>Admin Luar</label>
          <div class="icon-input"><span>üí∏</span>
            <input id="f_admin_luar_only" inputmode="numeric" placeholder="0" />
          </div>
        </div>
      </div>

      <!-- ROW FEE BANK -->
      <div class="row" id="rowFeeBank" style="display:none">
        <div>
          <label>Fee Bank (Transfer)</label>
          <div class="icon-input"><span>üè¶</span>
            <input id="f_fee_bank" inputmode="numeric" placeholder="0" />
          </div>
        </div>
      </div>

      <!-- ROW PULSA (MODAL & JUAL) -->
      <div class="row" id="rowPulsa" style="display:none">
        <div>
          <label>Modal (harga modal)</label>
          <div class="icon-input"><span>Rp</span>
            <input id="f_modal" inputmode="numeric" placeholder="0" />
          </div>
        </div>
        <div>
          <label>Jual (harga jual)</label>
          <div class="icon-input"><span>Rp</span>
            <input id="f_jual" inputmode="numeric" placeholder="0" />
          </div>
        </div>
      </div>

      <div>
        <label>Keterangan</label>
        <div class="icon-input">
          <textarea id="f_ket" rows="3" placeholder="Catatan jika perlu..."></textarea>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn btn-gray" id="batalForm">Batal</button>
      <button class="btn btn-primary" id="simpanForm">Simpan</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  const $ = (id)=>document.getElementById(id)
  const fmtRp = n => "Rp " + new Intl.NumberFormat('id-ID').format(Number(n||0))
  const parseNum = v => Number(String(v||'').replace(/[^0-9]/g,''))||0

  let gRole=null, gBranch=null, viewBranch=null
  let cacheAcc={ cash:[], rekening:[], server_pulsa:[] }
  let filterJenis='all'

  // ====== DATE RANGE STATE ======
  let range = { from: null, to: null } // 'YYYY-MM-DD'
  // ====== EXPORT STATE ======
  let lastRiwayatRows = []

  const isOwner = ()=> gRole==='owner'
  function toastErr(t){ const m=$('msgErr'); m.textContent=t; m.style.display='block'; setTimeout(()=>m.style.display='none',3000) }

  // helpers tanggal
  const fmtHuman = (d)=> d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric', hour:'2-digit', minute:'2-digit'})
  const fmtHumanDateOnly = (d)=> d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})
  const toISODate = (d)=> d.toISOString().slice(0,10)
  function startOfDayISO(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString() }
  function endOfDayISO(d){ const x=new Date(d); x.setHours(23,59,59,999); return x.toISOString() }
  function setPreset(days){
    const end = new Date()
    const start = new Date(); start.setHours(0,0,0,0); start.setDate(end.getDate()-(days-1))
    range.from = toISODate(start); range.to = toISODate(end)
    $('dateFrom').value = range.from
    $('dateTo').value = range.to
    updateRangeLabel()
  }
  function getRangeISO(){
    if(!range.from || !range.to){
      const t=new Date(); const s=new Date(); s.setHours(0,0,0,0)
      return { tmin: s.toISOString(), tmax: endOfDayISO(t) }
    }
    return { tmin: startOfDayISO(new Date(range.from)), tmax: endOfDayISO(new Date(range.to)) }
  }
  function updateRangeLabel(){
    const f = range.from ? fmtHumanDateOnly(new Date(range.from)) : '-'
    const t = range.to ? fmtHumanDateOnly(new Date(range.to)) : '-'
    const same = range.from===range.to
    $('activeRangeLabel').textContent = `Rentang: ${f} ${same?'':'‚Äì '+t}`
    $('kpiTglLabel').textContent = same? 'Hari ini' : `${f} ‚Äì ${t}`
  }

  ;(()=>{ // input numeric formatters
    const ids=['f_nom','f_admin_dalam','f_admin_luar','f_fee_bank','f_admin_luar_only','f_modal','f_jual']
    ids.forEach(id=>{
      const el=$(id); if(!el) return
      el.addEventListener('input', e=>{
        const raw=e.target.value.replace(/\D/g,'')
        e.target.value = raw? new Intl.NumberFormat('id-ID').format(Number(raw)) : ''
      })
    })
  })()

  async function boot(){
    // default preset: Hari ini
    setPreset(1)

    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }
    const { data: prof, error } = await supabase.from('profiles').select('role,branch_code,full_name,email').eq('id', session.user.id).single()
    if(error){ alert('Gagal ambil profil: '+error.message); return }

    gRole = (prof.role||'').toString().trim().toLowerCase()
    gBranch = (prof.branch_code||'').toString().trim()
    viewBranch = gBranch

    $('me').textContent = `${prof.full_name || prof.email}`
    $('roleBadge').textContent = `role: ${gRole}`
    $('branchBadge').textContent = `branch: ${viewBranch || '-'}`

    $('kpi_profit_wrap').style.display = isOwner()? 'block':'none'

    if(isOwner()){
      $('branchRow').style.display='flex'
      $('fabAdd').style.display='flex'
      await loadBranches()
    }else{
      $('branchRow').style.display='grid'
      $('btnTambah').style.display='inline-block'
    }

    await loadAccounts()
    await refreshByRange()
  }

  async function refreshByRange(){
    await loadKPITransaksi()
    await loadKPISaldo()
    await loadRiwayat()
  }

  async function loadBranches(){
    const sel=$('branchSelect')
    sel.innerHTML='<option value="">Memuat cabang‚Ä¶</option>'
    let list=[]
    const { data: br, error: ebr } = await supabase.from('branches').select('code,name').order('name')
    if(!ebr && br && br.length){
      list = br.map(b=>({code:(b.code||'').trim(), name:b.name||b.code}))
    }else{
      const { data: accs } = await supabase.from('accounts').select('branch_code').order('branch_code')
      const set = new Set((accs||[]).map(a=>(a.branch_code||'').trim()).filter(Boolean))
      list = Array.from(set).map(code=>({code,name:code}))
      if(list.length===0 && gBranch){ list=[{code:gBranch,name:gBranch}] }
    }
    if(list.length===0){ sel.innerHTML='<option>(Belum ada cabang)</option>'; return }
    sel.innerHTML = list.map(b=>`<option value="${b.code}">${b.code} ‚Äî ${b.name}</option>`).join('')
    sel.value = viewBranch || list[0].code
    if(!viewBranch) viewBranch = sel.value
    sel.onchange = async ()=>{
      viewBranch = sel.value;
      $('branchBadge').textContent = `branch: ${viewBranch}`;
      await loadAccounts();
      await refreshByRange();
    }
  }

  async function loadAccounts(){
    const cab = viewBranch || gBranch
    const { data, error } = await supabase
      .from('accounts')
      .select('id,name,account_type,branch_code,saldo')
      .eq('branch_code', cab)
      .order('name')
    if(error){ alert('Gagal ambil akun: '+error.message); return }
    cacheAcc={ cash:[], rekening:[], server_pulsa:[] }
    ;(data||[]).forEach(a=>{ if(cacheAcc[a.account_type]) cacheAcc[a.account_type].push(a) })
  }

  // ====== KPI TRANSAKSI (respect range) ======
  async function loadKPITransaksi(){
    const cab = viewBranch || gBranch
    const { tmin, tmax } = getRangeISO()

    const { data, error } = await supabase
      .from('transactions')
      .select('jenis, nominal, admin_dalam, admin_luar, fee_bank, branch_code, created_at')
      .eq('branch_code', cab).gte('created_at', tmin).lte('created_at', tmax)

    let omset=0, tarik=0, transfer=0, fee=0, profit=0
    if(!error){
      for(const r of (data||[])){
        const n = Number(r.nominal||0), ad=Number(r.admin_dalam||0), al=Number(r.admin_luar||0), fb=Number(r.fee_bank||0)
        omset += n; fee += fb
        if((r.jenis||'')==='tarik') tarik += n
        if((r.jenis||'')==='transfer') transfer += n
        profit += (ad + al - fb)
      }
    }
    $('kpi_omset').textContent = fmtRp(omset)
    $('kpi_tarik').textContent = fmtRp(tarik)
    $('kpi_transfer').textContent = fmtRp(transfer)
    $('kpi_fee').textContent = fmtRp(fee)
    if(gRole==='owner') $('kpi_profit').textContent = fmtRp(profit)
  }

  // ====== KPI MASTER SALDO (DINAMIS) ======
  function renderKPISaldoCards(accounts){
    const wrap = $('kpiSaldoWrap')
    const list = Array.isArray(accounts) ? accounts : []
    const totalAsset = list.reduce((s,a)=> s + Number(a.saldo||0), 0)

    const laci = list.filter(a=> a.account_type==='cash' && /laci/i.test(a.name||''))
    const rek  = list.filter(a=> a.account_type==='rekening').sort((a,b)=>(a.name||'').localeCompare(b.name||''))
    const srv  = list.filter(a=> a.account_type==='server_pulsa').sort((a,b)=>(a.name||'').localeCompare(b.name||''))

    let html = `
      <div class="kpi-card">
        <div class="kpi-title">Total Asset</div>
        <div class="kpi-value">${fmtRp(totalAsset)}</div>
        <div class="kpi-sub">Œ£ semua akun (cash + rekening + server)</div>
      </div>
    `
    const pushCard = (a)=> {
      html += `
        <div class="kpi-card">
          <div class="kpi-title">${a.name || (a.account_type||'').toUpperCase()}</div>
          <div class="kpi-value">${fmtRp(a.saldo||0)}</div>
          <div class="kpi-sub">${a.account_type}</div>
        </div>
      `
    }
    laci.forEach(pushCard); rek.forEach(pushCard); srv.forEach(pushCard)

    if(list.length===0){
      html = `
        <div class="kpi-card">
          <div class="kpi-title">Total Asset</div>
          <div class="kpi-value">Rp 0</div>
          <div class="kpi-sub">Belum ada akun</div>
        </div>
      `
    }
    wrap.innerHTML = html
  }

  async function loadKPISaldo(){
    const cab = viewBranch || gBranch
    const { data, error } = await supabase
      .from('accounts')
      .select('id,name,account_type,branch_code,saldo')
      .eq('branch_code', cab)
      .order('name')
    if(error){ renderKPISaldoCards([]); return }
    renderKPISaldoCards(data||[])
  }

  // ====== RIWAYAT (respect range) ======
  async function loadRiwayat(){
    const cab = viewBranch || gBranch
    const { tmin, tmax } = getRangeISO()

    const { data, error } = await supabase
      .from('v_tx_summary')
      .select(`
        id,
        id_trx,
        jenis,
        src_account_name,
        dst_account_name,
        nominal,
        admin_dalam,
        admin_luar,
        fee_bank,
        saldo_awal,
        saldo_akhir,
        note,
        created_by_name,
        created_at,
        branch_code
      `)
      .eq('branch_code', cab)
      .gte('created_at', tmin)
      .lte('created_at', tmax)
      .order('created_at', { ascending:false })
      .limit(500)

    if(error){
      $('tb').innerHTML = `<tr><td colspan="13" style="color:#991b1b">Gagal memuat riwayat: ${error.message}</td></tr>`
      return
    }

    const rows = (data||[]).filter(r=> filterJenis==='all' ? true : (r.jenis===filterJenis))
    lastRiwayatRows = rows

    if(rows.length===0){
      $('tb').innerHTML = `<tr><td colspan="13" style="color:#64748b">Belum ada transaksi dalam rentang ini.</td></tr>`
      return
    }

    let i = 1
    $('tb').innerHTML = rows.map(r=>{
      const user = r.created_by_name || '-'
      const tgl = fmtHuman(new Date(r.created_at))
      const sumberDana = `${r.src_account_name || '-'}${r.dst_account_name ? ' ‚Üí '+r.dst_account_name : ''}`
      const userTanggal = `(<span style="color:#1d4ed8">${user}</span>, ${tgl})`

      return `<tr data-id="${r.id}">
        <td>${i++}</td>
        <td>${userTanggal}</td>
        <td><code>${r.id_trx}</code></td>
        <td>${sumberDana}</td>
        <td style="text-transform:capitalize">${r.jenis}</td>
        <td>${fmtRp(r.saldo_awal || 0)}</td>
        <td>${fmtRp(r.nominal || 0)}</td>
        <td>${r.admin_dalam ? fmtRp(r.admin_dalam) : '-'}</td>
        <td>${r.admin_luar ? fmtRp(r.admin_luar) : '-'}</td>
        <td>${r.fee_bank ? fmtRp(r.fee_bank) : '-'}</td>
        <td>${fmtRp(r.saldo_akhir || 0)}</td>
        <td>${r.note || '-'}</td>
        <td>
          <button class="btn btn-ghost" data-act="edit" title="Edit" style="height:32px;padding:4px 8px">‚úèÔ∏è</button>
          <button class="btn btn-danger" data-act="del" title="Hapus" style="height:32px;padding:4px 8px">üóëÔ∏è</button>
        </td>
      </tr>`
    }).join('')
  }

  // ====== Export Excel (CSV) ======
  function csvEscape(value){
    if(value==null) return ''
    const s = String(value).replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim()
    if(/[",;]/.test(s)) return `"${s.replace(/"/g,'""')}"`
    return s
  }
  function exportCSV(){
    const rows = lastRiwayatRows || []
    const header = [
      'No urut','User','Tanggal','ID Trx','Sumber Dana','Jenis',
      'Saldo Awal','Nominal','Admin Dalam','Admin Luar','Fee Bank','Saldo Akhir','Keterangan'
    ]
    const lines = [header.join(',')]

    let i=1
    for(const r of rows){
      const user = r.created_by_name || ''
      const tgl  = fmtHuman(new Date(r.created_at))
      const sumber = `${r.src_account_name || ''}${r.dst_account_name ? ' ‚Üí '+r.dst_account_name : ''}`

      const rec = [
        i++,
        user,
        tgl,
        r.id_trx || '',
        sumber,
        r.jenis || '',
        (r.saldo_awal ?? 0),
        (r.nominal ?? 0),
        (r.admin_dalam ?? 0),
        (r.admin_luar ?? 0),
        (r.fee_bank ?? 0),
        (r.saldo_akhir ?? 0),
        r.note || ''
      ].map(csvEscape)
      lines.push(rec.join(','))
    }

    const csv = lines.join('\n')
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })

    const f = range.from || toISODate(new Date())
    const t = range.to   || toISODate(new Date())
    const same = f===t
    const fname = same ? `riwayat_${f}.csv` : `riwayat_${f}_sampai_${t}.csv`

    const link = document.createElement('a')
    const url = URL.createObjectURL(blob)
    link.setAttribute('href', url)
    link.setAttribute('download', fname)
    link.style.display='none'
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)
  }

  // Delegasi klik untuk Aksi Edit/Hapus
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]')
    if(!btn) return
    const tr = btn.closest('tr[data-id]')
    if(!tr) return
    const id = tr.getAttribute('data-id')
    const act = btn.getAttribute('data-act')

    if(act==='del'){
      if(!confirm('Hapus transaksi ini?')) return
      const { error } = await supabase.from('transactions').delete().eq('id', id)
      if(error){ alert('Gagal hapus: '+error.message); return }
      await refreshByRange()
    } else if(act==='edit'){
      alert('Edit: akan diaktifkan. (Form edit memuat data transaksi & update baris.)')
    }
  })

  // ====== UI: filter chips ======
  document.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'))
      ch.classList.add('active')
      filterJenis = ch.dataset.j
      loadRiwayat()
    })
  })

  // ====== Date preset & apply ======
  $('presetToday').onclick = async ()=>{ setPreset(1); await refreshByRange() }
  $('preset7').onclick     = async ()=>{ setPreset(7); await refreshByRange() }
  $('preset30').onclick    = async ()=>{ setPreset(30); await refreshByRange() }
  $('applyRange').onclick  = async ()=>{
    const f = $('dateFrom').value, t = $('dateTo').value
    if(!f || !t){ alert('Pilih tanggal Dari dan Sampai.'); return }
    if(new Date(f) > new Date(t)){ alert('Tanggal Dari tidak boleh melewati Sampai.'); return }
    range.from = f; range.to = t; updateRangeLabel()
    await refreshByRange()
  }

  // ====== Export button ======
  $('btnExport').onclick = ()=> exportCSV()

  // ====== Tambah transaksi (popup jenis -> form) ======
  function openJenis(){ $('modalJenis').classList.add('show') }
  function closeJenis(){ $('modalJenis').classList.remove('show') }
  function openForm(){ $('modalForm').classList.add('show') }
  function closeForm(){ $('modalForm').classList.remove('show') }

  $('btnTambah').onclick = openJenis
  $('fabAdd').onclick = openJenis
  $('xJenis').onclick = $('batalJenis').onclick = closeJenis
  $('xForm').onclick = $('batalForm').onclick = ()=>{ closeForm(); }

  // pilih jenis
  document.querySelectorAll('#modalJenis [data-pilih]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const jenis = btn.getAttribute('data-pilih')
      closeJenis()
      setupForm(jenis)
      openForm()
    })
  })

  function fillSelect(sel, items){
    sel.innerHTML = (items||[]).map(i=>`<option value="${i.id}">${i.name}</option>`).join('')
    if(!items || !items.length){ sel.innerHTML = '<option value="">(Tidak ada opsi)</option>' }
  }
  function findLaci(){ return (cacheAcc.cash||[]).find(a=>/laci/i.test(a.name||'')) || null }

  function setupForm(jenis){
    // reset
    $('dlgTitle').textContent = `Form ${jenis.toUpperCase()}`
    $('f_jenis').value = jenis
    $('f_branch').value = viewBranch || gBranch
    ;['f_nom','f_admin_dalam','f_admin_luar','f_admin_luar_only','f_fee_bank','f_ket','f_modal','f_jual']
      .forEach(id=>{ const el=$(id); if(el) el.value='' })

    const sumber=$('f_sumber'), terima=$('f_terima')
    const laci = findLaci()

    // default hide
    $('rowNominal').style.display='none'
    $('rowAdminDua').style.display='none'
    $('rowAdminLuarOnly').style.display='none'
    $('rowFeeBank').style.display='none'
    $('rowPulsa').style.display='none'
    $('rowSumber').style.display='grid'
    $('labelNominal').textContent = 'Nominal (Rp)'

    if(jenis==='tarik'){
      // sumber: Laci (locked), terima: Rekening
      fillSelect(sumber, laci? [laci] : []); sumber.disabled=true
      fillSelect(terima, cacheAcc.rekening||[]); terima.disabled=false

      $('rowNominal').style.display='grid'
      $('rowAdminDua').style.display='grid'      // admin dalam & admin luar
    }
    else if(jenis==='transfer'){
      // sumber: Rekening & Server; terima: Laci (locked)
      const sumberList = [...(cacheAcc.rekening||[]), ...(cacheAcc.server_pulsa||[])]
      fillSelect(sumber, sumberList); sumber.disabled=false
      fillSelect(terima, laci? [laci] : []); terima.disabled=true

      $('rowNominal').style.display='grid'
      $('rowAdminLuarOnly').style.display='grid' // hanya admin luar
      $('rowFeeBank').style.display='grid'
    }
    else if(jenis==='pulsa'){
      // sumber: Rekening & Server; terima: Laci (locked)
      const sumberList = [...(cacheAcc.rekening||[]), ...(cacheAcc.server_pulsa||[])]
      fillSelect(sumber, sumberList); sumber.disabled=false
      fillSelect(terima, laci? [laci] : []); terima.disabled=true

      $('rowPulsa').style.display='grid'         // modal & jual
    }
    else if(jenis==='jasa'){
      // Sembunyikan baris sumber/terima di UI, tapi tetap set terima = Laci agar kas bertambah
      $('rowSumber').style.display='none'
      if(laci){ terima.innerHTML = `<option value="${laci.id}">${laci.name}</option>`; }

      $('rowAdminLuarOnly').style.display='grid' // hanya admin luar
      // nominal disembunyikan; diisi otomatis saat simpan = admin luar
    }
  }

  // enforce TARIK: hanya salah satu admin terisi
  $('f_admin_dalam').addEventListener('input', ()=>{
    if(parseNum($('f_admin_dalam').value)>0){ $('f_admin_luar').value='' }
  })
  $('f_admin_luar').addEventListener('input', ()=>{
    if(parseNum($('f_admin_luar').value)>0){ $('f_admin_dalam').value='' }
  })

  $('simpanForm').onclick = async ()=>{
    const jenis = $('f_jenis').value
    const branch = viewBranch || gBranch
    const sumber = $('f_sumber').value || null
    const terima = $('f_terima').value || null
    const note = $('f_ket').value.trim()

    try{
      let row = { branch_code: branch, jenis, src_account_id: sumber, dst_account_id: terima, nominal: 0, admin_dalam: 0, admin_luar: 0, fee_bank: 0, note }

      if(jenis==='tarik'){
        if(!terima) throw new Error('Terima Dana (rekening) wajib diisi.')
        const laci = findLaci(); if(!laci) throw new Error('Tidak ditemukan akun Laci Tunai di cabang ini.')
        row.src_account_id = laci.id

        const nominal = parseNum($('f_nom').value)
        const ad = parseNum($('f_admin_dalam').value)
        const al = parseNum($('f_admin_luar').value)
        if(nominal<=0) throw new Error('Nominal harus > 0.')
        if(ad>0 && al>0) throw new Error('Isi salah satu: Admin Dalam ATAU Admin Luar.')
        row.nominal = nominal
        row.admin_dalam = ad>0 ? ad : 0
        row.admin_luar  = al>0 ? al : 0
        row.fee_bank = 0
      }
      else if(jenis==='transfer'){
        if(!sumber) throw new Error('Sumber Dana (rekening/server) wajib diisi.')
        const laci = findLaci(); if(!laci) throw new Error('Tidak ditemukan akun Laci Tunai di cabang ini.')
        row.dst_account_id = laci.id

        const nominal = parseNum($('f_nom').value)
        const al = parseNum($('f_admin_luar_only').value)
        const fb = parseNum($('f_fee_bank').value)
        if(nominal<=0) throw new Error('Nominal harus > 0.')
        row.nominal = nominal
        row.admin_dalam = 0
        row.admin_luar  = al
        row.fee_bank    = fb
      }
      else if(jenis==='pulsa'){
        if(!sumber) throw new Error('Sumber Dana (rekening/server) wajib diisi.')
        const laci = findLaci(); if(!laci) throw new Error('Tidak ditemukan akun Laci Tunai di cabang ini.')
        row.dst_account_id = laci.id

        const modal = parseNum($('f_modal').value)
        const jual  = parseNum($('f_jual').value)
        if(modal<=0) throw new Error('Modal harus > 0.')
        if(jual<modal) throw new Error('Jual tidak boleh kurang dari Modal.')
        const margin = Math.max(jual - modal, 0)
        row.nominal = modal
        row.admin_dalam = 0
        row.admin_luar  = margin
        row.fee_bank    = 0
        row.note = note ? note : `Pulsa: modal ${fmtRp(modal)}, jual ${fmtRp(jual)}, margin ${fmtRp(margin)}`
      }
      else if(jenis==='jasa'){
        const laci = findLaci(); if(!laci) throw new Error('Tidak ditemukan akun Laci Tunai di cabang ini.')
        row.src_account_id = null
        row.dst_account_id = laci.id

        const al = parseNum($('f_admin_luar_only').value)
        if(al<=0) throw new Error('Fee Admin (Admin Luar) harus > 0.')
        row.nominal    = al     // nominal = admin luar (otomatis)
        row.admin_luar = al
        row.admin_dalam = 0
        row.fee_bank = 0
      }

      const { error } = await supabase.from('transactions').insert(row)
      if(error) throw error

      $('modalForm').classList.remove('show')
      await refreshByRange()
    }catch(e){ toastErr('Gagal simpan: '+(e.message||e)) }
  }

  $('lnk-logout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.href='login.html' })

  // ====== Export button ======
  document.getElementById('btnExport').onclick = ()=> exportCSV()

  // start
  boot()
</script>
</body>
</html>
