<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Transaksi Mini-ATM | AMKO</title>
  <style>
    :root{
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --muted:#64748b; --txt:#0f172a;
      --shadow:0 6px 18px rgba(15,23,42,.08);
      --touch:48px; --radius:16px; --safe-bottom: env(safe-area-inset-bottom, 0);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);-webkit-tap-highlight-color: transparent}
    button,input,select,textarea{font-family:inherit}

    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px;line-height:1.2}
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--pri);color:#fff}

    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f9fafb;font-size:12px}

    .topbar{position:sticky;top:54px;z-index:9;background:linear-gradient(#fff,#fff 75%,transparent);padding:12px 16px;border-bottom:1px solid var(--bd)}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:12px 12px;font-size:16px;height:var(--touch);outline:none}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:var(--touch)}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-gray{background:#eef2f6}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--bd);padding:8px 10px;border-radius:999px;background:#fff;font-size:12px;cursor:pointer}
    .chip.active{background:#0b63f3;color:#fff;border-color:#0b63f3}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin:12px 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:22px;box-shadow:var(--shadow);padding:16px}
    .card h3{margin:0 0 6px 0}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--bd);font-size:14px;text-align:left}
    th{background:#f8fafc}

    .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
    .modal.show{display:flex}
    .dialog{width:min(820px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:92vh}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    .icon-input{display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff;min-height:var(--touch)}
    .icon-input input,.icon-input select,.icon-input textarea{border:none;outline:none;flex:1;font-size:16px;background:transparent}
    .icon-input textarea{min-height:96px;resize:vertical}
    .dlg-ft{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--bd);padding:12px 16px;display:flex;gap:8px;justify-content:flex-end}

    @media (max-width: 900px){
      .layout{grid-template-columns:1fr}
      .sidebar{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:11}
      .brand{margin:0}
      .topbar{top:56px;padding:10px 12px}
      header{padding:10px}
      .dialog{width:100%;height:100%;max-height:none;border-radius:0}
      .dlg-bd{padding:12px;gap:10px}
      .row{grid-template-columns:1fr}
    }

    .fab{position:fixed;right:14px;bottom:calc(14px + var(--safe-bottom));width:56px;height:56px;border-radius:999px;background:var(--pri);color:#fff;display:none;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(11,99,243,.35);z-index:15;font-size:26px;font-weight:900}
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="brand">AMKO</div>
    <nav class="nav" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="master-saldo-akun.html">üí≥ Master Akun</a>
      <a class="active" href="transaksi-mini-atm.html">üèß Mini ATM</a>
      <a href="#" id="lnk-logout">üö™ Logout</a>
    </nav>
  </aside>

  <div>
    <header>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Transaksi Mini-ATM</h2>
        <span class="pill" style="font-size:11px">Owner bisa pilih cabang ‚Ä¢ Non-owner terkunci cabang profil</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="me" class="pill">memuat‚Ä¶</div>
        <div id="roleBadge" class="pill">role: ‚Ä¶</div>
        <div id="branchBadge" class="pill">branch: ‚Ä¶</div>
      </div>
    </header>

    <div class="topbar">
      <!-- Dropdown cabang (owner only) -->
      <div id="branchRow" style="display:none; margin-bottom:10px; gap:8px; align-items:center; flex-wrap:wrap">
        <span style="font-size:12px;color:#475569;">Cabang</span>
        <select id="branchSelect" class="input" style="width:260px;max-width:100%">
          <option value="">Memuat cabang‚Ä¶</option>
        </select>
        <button id="btnTambah" class="btn btn-primary">+ Tambah Transaksi</button>
        <button id="btnExport" class="btn btn-gray" title="Export CSV">‚§ì Export CSV</button>
      </div>

      <!-- Filter Jenis -->
      <div class="chips">
        <div class="chip active" data-j="all">Semua</div>
        <div class="chip" data-j="tarik">Tarik Tunai</div>
        <div class="chip" data-j="transfer">Transfer</div>
        <div class="chip" data-j="pulsa">Pulsa</div>
        <div class="chip" data-j="jasa">Jasa</div>
      </div>
    </div>

    <!-- KPI Saldo Akun -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:0 16px 12px">
      <div class="card"><div class="label">Saldo Laci Tunai</div><div class="val" id="saldoCash">Rp 0</div></div>
      <div class="card"><div class="label">Saldo Rekening</div><div class="val" id="saldoBank">Rp 0</div></div>
      <div class="card"><div class="label">Saldo Server Pulsa</div><div class="val" id="saldoPulsa">Rp 0</div></div>
    </div>

    <!-- KPI Bar -->
    <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin:0 16px 12px">
      <div class="card"><div class="label">Omset</div><div class="val" id="kOmset">Rp 0</div></div>
      <div class="card"><div class="label">Transfer</div><div class="val" id="kTransfer">Rp 0</div></div>
      <div class="card"><div class="label">Tarik Tunai</div><div class="val" id="kTarik">Rp 0</div></div>
      <div class="card"><div class="label">Pulsa</div><div class="val" id="kPulsa">Rp 0</div></div>
      <div class="card"><div class="label">Jasa (Admin)</div><div class="val" id="kJasa">Rp 0</div></div>
      <div class="card"><div class="label">Biaya Bank</div><div class="val" id="kFee">Rp 0</div></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Riwayat Transaksi</h3>
        <span class="pill" id="infoRiwayat">Memuat‚Ä¶</span>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>No</th>
                <th>User & Tanggal</th>
                <th>ID Trx</th>
                <th>Sumber Dana</th>
                <th>Jenis</th>
                <th>Saldo Awal</th>
                <th>Nominal</th>
                <th>Admin Dalam</th>
                <th>Admin Luar</th>
                <th>Adm Bank</th>
                <th>Saldo Akhir</th>
                <th>Keterangan</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<button id="fabAdd" class="fab" title="Tambah">+</button>

<!-- MODAL PILIH JENIS -->
<div class="modal" id="modalJenis">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Pilih Jenis Transaksi</span>
      <button class="btn btn-ghost" id="xJenis" style="height:40px">‚úñ</button>
    </div>
    <div class="dlg-bd" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <button class="btn btn-gray" data-pilih="tarik">Tarik Tunai</button>
      <button class="btn btn-gray" data-pilih="transfer">Transfer</button>
      <button class="btn btn-gray" data-pilih="pulsa">Pulsa</button>
      <button class="btn btn-gray" data-pilih="jasa">Jasa</button>
    </div>
    <div class="dlg-ft">
      <button class="btn btn-gray" id="batalJenis">Batal</button>
    </div>
  </div>
</div>

<!-- MODAL FORM TRANSAKSI -->
<div class="modal" id="modalForm">
  <div class="dialog">
    <div class="dlg-hd">
      <span id="dlgTitle">Form Transaksi</span>
      <button class="btn btn-ghost" id="xForm" style="height:40px">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div id="msgErr" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px"></div>

      <div class="row">
        <div>
          <label>Jenis</label>
          <div class="icon-input"><span>üìÇ</span>
            <input id="f_jenis" readonly />
          </div>
        </div>
        <div>
          <label>Cabang</label>
          <div class="icon-input"><span>üè¨</span>
            <input id="f_branch" readonly />
          </div>
        </div>
      </div>

      <div class="row" id="rowSumber">
        <div>
          <label>Sumber Dana</label>
          <div class="icon-input"><span>‚ÜóÔ∏è</span>
            <select id="f_sumber"></select>
          </div>
        </div>
        <div>
          <label>Terima Dana</label>
          <div class="icon-input"><span>‚ÜòÔ∏è</span>
            <select id="f_terima"></select>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Nominal (Rp)</label>
          <div class="icon-input"><span>Rp</span>
            <input id="f_nom" inputmode="numeric" placeholder="0" />
          </div>
        </div>
        <div>
          <label>Admin Dalam / Luar</label>
          <div class="icon-input"><span>üí∏</span>
            <input id="f_admin_dalam" inputmode="numeric" placeholder="Admin Dalam (opsional)" style="width:50%">
            <input id="f_admin_luar" inputmode="numeric" placeholder="Admin Luar (opsional)" style="width:50%">
          </div>
        </div>
      </div>

      <div class="row" id="rowFeeBank" style="display:none">
        <div>
          <label>Fee Bank (Transfer)</label>
          <div class="icon-input"><span>üè¶</span>
            <input id="f_fee_bank" inputmode="numeric" placeholder="0" />
          </div>
        </div>
      </div>

      <div>
        <label>Keterangan</label>
        <div class="icon-input">
          <textarea id="f_ket" rows="3" placeholder="Catatan jika perlu..."></textarea>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn btn-gray" id="batalForm">Batal</button>
      <button class="btn btn-primary" id="simpanForm">Simpan</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  const $ = (id)=>document.getElementById(id)
  const fmtRp = n => "Rp " + new Intl.NumberFormat('id-ID').format(Number(n||0))
  const parseNum = v => Number(String(v||'').replace(/[^0-9]/g,''))||0
  const shortId = id => (id||'').toString().slice(0,8)

  let gRole=null, gBranch=null, viewBranch=null
  let cacheAcc={ cash:[], rekening:[], server_pulsa:[] }
  let filterJenis='all'
  let lastRows=[]

  const isOwner = ()=> gRole==='owner'
  function toastErr(t){ const m=$('msgErr'); m.textContent=t; m.style.display='block'; setTimeout(()=>m.style.display='none',3000) }

  ;(()=>{ // input numeric formatters
    const ids=['f_nom','f_admin_dalam','f_admin_luar','f_fee_bank']
    ids.forEach(id=>{
      const el=$(id)
      if(!el) return
      el.addEventListener('input', e=>{
        const raw=e.target.value.replace(/\D/g,'')
        e.target.value = raw? new Intl.NumberFormat('id-ID').format(Number(raw)) : ''
      })
    })
  })()

  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }
    const { data: prof, error } = await supabase.from('profiles').select('role,branch_code,full_name,email').eq('id', session.user.id).single()
    if(error){ alert('Gagal ambil profil: '+error.message); return }

    gRole = (prof.role||'').toString().trim().toLowerCase()
    gBranch = (prof.branch_code||'').toString().trim()
    viewBranch = gBranch

    $('me').textContent = `${prof.full_name || prof.email}`
    $('roleBadge').textContent = `role: ${gRole}`
    $('branchBadge').textContent = `branch: ${viewBranch || '-'}`

    if(isOwner()){
      $('branchRow').style.display='flex'
      $('fabAdd').style.display='flex'
      await loadBranches()
    }else{
      $('branchRow').style.display='grid'
      $('btnTambah').style.display='inline-block'
    }

    await loadAccounts()
    await loadKPIs()
    await loadRiwayat()
  }

  async function loadBranches(){
    const sel=$('branchSelect')
    sel.innerHTML='<option value="">Memuat cabang‚Ä¶</option>'
    let list=[]
    const { data: br, error: ebr } = await supabase.from('branches').select('code,name').order('name')
    if(!ebr && br && br.length){
      list = br.map(b=>({code:(b.code||'').trim(), name:b.name||b.code}))
    }else{
      const { data: accs } = await supabase.from('accounts').select('branch_code').order('branch_code')
      const set = new Set((accs||[]).map(a=>(a.branch_code||'').trim()).filter(Boolean))
      list = Array.from(set).map(code=>({code,name:code}))
      if(list.length===0 && gBranch){ list=[{code:gBranch,name:gBranch}] }
    }
    if(list.length===0){ sel.innerHTML='<option>(Belum ada cabang)</option>'; return }
    sel.innerHTML = list.map(b=>`<option value="${b.code}">${b.code} ‚Äî ${b.name}</option>`).join('')
    sel.value = viewBranch || list[0].code
    if(!viewBranch) viewBranch = sel.value
    sel.onchange = async ()=>{
      viewBranch = sel.value
      $('branchBadge').textContent = `branch: ${viewBranch}`
      await loadAccounts()
      await loadKPIs()
      await loadRiwayat()
    }
  }

  async function loadAccounts(){
    const cab = viewBranch || gBranch
    const { data, error } = await supabase
      .from('accounts')
      .select('id,name,account_type,branch_code,saldo_awal')
      .eq('branch_code', cab)
      .order('name')
    if(error){ console.warn('Gagal ambil akun:', error.message); return }
    cacheAcc={ cash:[], rekening:[], server_pulsa:[] }
    ;(data||[]).forEach(a=>{ if(cacheAcc[a.account_type]) cacheAcc[a.account_type].push(a) })
  }

  async function loadKPIs(){
    const cab = viewBranch || gBranch

    // --- KPI Saldo Akun (REAL-TIME) via v_kpi_saldo_by_type ---
    try{
      const { data: byType, error: e1 } = await supabase
        .from('v_kpi_saldo_by_type')
        .select('account_type,saldo_tipe')
        .eq('branch_code', cab)
      if(e1) throw e1
      const get = (t) => Number((byType||[]).find(x=>x.account_type===t)?.saldo_tipe || 0)
      $('saldoCash').textContent  = fmtRp(get('cash'))
      $('saldoBank').textContent  = fmtRp(get('rekening'))
      $('saldoPulsa').textContent = fmtRp(get('server_pulsa'))
    }catch(err){
      $('saldoCash').textContent  = 'Rp 0'
      $('saldoBank').textContent  = 'Rp 0'
      $('saldoPulsa').textContent = 'Rp 0'
    }

    // --- KPI transaksi (Omset/Transfer/Tarik/Pulsa/Jasa/Fee) dari v_tx_summary ---
    try{
      const { data, error } = await supabase
        .from('v_tx_summary')
        .select('jenis, nominal, admin_dalam, admin_luar, adm_bank, branch_code')
        .eq('branch_code', cab)
      if(error) throw error
      const rows = data||[]
      let omset=0, transfer=0, tarik=0, pulsa=0, jasa=0, fee=0
      rows.forEach(r=>{
        const nom = Number(r.nominal||0)||0
        const admDalam = Number(r.admin_dalam||0)||0
        const admLuar  = Number(r.admin_luar||0)||0
        const fb = Number(r.adm_bank||0)||0
        omset += nom
        fee   += fb
        if(r.jenis==='transfer') transfer += nom
        else if(r.jenis==='tarik') tarik += nom
        else if(r.jenis==='pulsa') pulsa += nom
        else if(r.jenis==='jasa') jasa += (admDalam+admLuar)
      })
      $('kOmset').textContent   = fmtRp(omset)
      $('kTransfer').textContent= fmtRp(transfer)
      $('kTarik').textContent   = fmtRp(tarik)
      $('kPulsa').textContent   = fmtRp(pulsa)
      $('kJasa').textContent    = fmtRp(jasa)
      $('kFee').textContent     = fmtRp(fee)
      $('infoRiwayat').textContent = `Cabang: ${cab} ‚Ä¢ Data: ${rows.length} baris`
    }catch(e){
      $('kOmset').textContent   = 'Rp 0'
      $('kTransfer').textContent= 'Rp 0'
      $('kTarik').textContent   = 'Rp 0'
      $('kPulsa').textContent   = 'Rp 0'
      $('kJasa').textContent    = 'Rp 0'
      $('kFee').textContent     = 'Rp 0'
      $('infoRiwayat').textContent = 'v_tx_summary belum tersedia'
    }
  }

  async function loadRiwayat(){
    const cab = viewBranch || gBranch
    let query = supabase
      .from('v_tx_summary')
      .select('no_urut,user_tanggal,id_trx,sumber_dana,jenis,saldo_awal,nominal,admin_dalam,admin_luar,adm_bank,saldo_akhir,keterangan,aksi_id,branch_code')
      .eq('branch_code', cab)
      .limit(200)
    if(filterJenis!=='all') query = query.eq('jenis', filterJenis)
    const { data, error } = await query

    if(error){
      $('tb').innerHTML = `<tr><td colspan="13" style="color:#991b1b">Riwayat belum tersedia (buat view v_tx_summary). ${error.message}</td></tr>`
      return
    }

    lastRows = data||[]
    if(lastRows.length===0){ $('tb').innerHTML = `<tr><td colspan="13" style="color:#64748b">Belum ada transaksi.</td></tr>`; return }

    $('tb').innerHTML = lastRows.map(r=>{
      return `<tr data-id="${r.aksi_id||r.id_trx||''}">
        <td>${r.no_urut||''}</td>
        <td><div class="user-name">${(r.user_tanggal||'').split(' ‚Äî ')[0]}</div><small>${(r.user_tanggal||'').split(' ‚Äî ')[1]||''}</small></td>
        <td title="${r.id_trx||''}"><code>${shortId(r.id_trx)}</code></td>
        <td>${r.sumber_dana||'-'}</td>
        <td style="text-transform:capitalize">${r.jenis||''}</td>
        <td>${(r.saldo_awal==null||isNaN(r.saldo_awal))? '-' : fmtRp(r.saldo_awal)}</td>
        <td>${fmtRp(r.nominal||0)}</td>
        <td>${r.admin_dalam? fmtRp(r.admin_dalam): '-'}</td>
        <td>${r.admin_luar? fmtRp(r.admin_luar): '-'}</td>
        <td>${r.adm_bank? fmtRp(r.adm_bank): '-'}</td>
        <td>${(r.saldo_akhir==null||isNaN(r.saldo_akhir))? '-' : fmtRp(r.saldo_akhir)}</td>
        <td>${r.keterangan? r.keterangan : '-'}</td>
        <td>
          <button class="btn btn-ghost" style="padding:6px 8px;font-size:12px" data-act="edit" data-id="${r.aksi_id}">Edit</button>
          <button class="btn btn-danger" style="padding:6px 8px;font-size:12px" data-act="del" data-id="${r.aksi_id}">Hapus</button>
        </td>
      </tr>`
    }).join('')
  }

  // ====== Export CSV (ikut sertakan kolom ID) ======
  $('btnExport').addEventListener('click', ()=>{
    if(!lastRows.length){ alert('Tidak ada data.'); return }
    const header=['Tanggal','User','ID','Jenis','Akun','Nominal','Adm Dalam','Adm Luar','Adm Bank','Profit','Saldo Awal (akun)','Saldo Akhir (akun)','Keterangan','Status']
    const rows = lastRows.map(t=>{
      const akunLbl = t.sumber_dana||'-'
      const profit = (Number(t.admin_dalam||0)+Number(t.admin_luar||0)) - Number(t.adm_bank||0)
      const cols=[
        (t.user_tanggal||'').split(' ‚Äî ')[1]||'',
        (t.user_tanggal||'').split(' ‚Äî ')[0]||'',
        (t.id_trx||''),
        (t.jenis||''),
        akunLbl,
        (t.nominal||0),
        (t.admin_dalam||0),
        (t.admin_luar||0),
        (t.adm_bank||0),
        profit,
        (t.saldo_awal==null?'':t.saldo_awal),
        (t.saldo_akhir==null?'':t.saldo_akhir),
        (t.keterangan||'').replaceAll(',',' '),
        'OK'
      ]
      return cols.join(',')
    })
    const csv = [header.join(','), ...rows].join('\n')
    const blob = new Blob([csv],{type:'text/csv'})
    const a = document.createElement('a')
    a.href = URL.createObjectURL(blob)
    a.download = `riwayat-mini-atm-${(viewBranch||gBranch||'all')}.csv`
    a.click()
    URL.revokeObjectURL(a.href)
  })

  // ====== UI: filter chips ======
  document.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', async ()=>{
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'))
      ch.classList.add('active')
      filterJenis = ch.dataset.j
      await loadKPIs()
      await loadRiwayat()
    })
  })

  // ====== Tambah transaksi (popup jenis -> form) ======
  function openJenis(){ $('modalJenis').classList.add('show') }
  function closeJenis(){ $('modalJenis').classList.remove('show') }
  function openForm(){ $('modalForm').classList.add('show') }
  function closeForm(){ $('modalForm').classList.remove('show') }

  $('btnTambah').onclick = openJenis
  $('fabAdd').onclick = openJenis
  $('xJenis').onclick = $('batalJenis').onclick = closeJenis
  $('xForm').onclick = $('batalForm').onclick = ()=>{ closeForm(); }

  // pilih jenis
  document.querySelectorAll('#modalJenis [data-pilih]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const jenis = btn.getAttribute('data-pilih')
      closeJenis()
      setupForm(jenis)
      openForm()
    })
  })

  function fillSelect(sel, items){
    sel.innerHTML = (items||[]).map(i=>`<option value="${i.id}">${i.name}</option>`).join('')
  }

  function setupForm(jenis){
    $('dlgTitle').textContent = `Form ${jenis.toUpperCase()}`
    $('f_jenis').value = jenis
    $('f_branch').value = viewBranch || gBranch
    $('f_nom').value = ''
    $('f_admin_dalam').value=''
    $('f_admin_luar').value=''
    $('f_fee_bank').value=''
    $('f_ket').value=''

    const sumber=$('f_sumber'), terima=$('f_terima')

    if(jenis==='tarik'){
      const laci = cacheAcc.cash.filter(a=>/laci/i.test(a.name))
      fillSelect(sumber, laci); sumber.disabled=true
      fillSelect(terima, cacheAcc.rekening); terima.disabled=false
      $('rowFeeBank').style.display='none'
    }
    else if(jenis==='transfer'){
      fillSelect(sumber, cacheAcc.rekening); sumber.disabled=false
      const laci = cacheAcc.cash.filter(a=>/laci/i.test(a.name))
      fillSelect(terima, laci); terima.disabled=true
      $('rowFeeBank').style.display='block'
    }
    else if(jenis==='pulsa'){
      fillSelect(sumber, cacheAcc.server_pulsa); sumber.disabled=false
      const laci = cacheAcc.cash.filter(a=>/laci/i.test(a.name))
      fillSelect(terima, laci); terima.disabled=true
      $('rowFeeBank').style.display='none'
    }
    else if(jenis==='jasa'){
      const laci = cacheAcc.cash.filter(a=>/laci/i.test(a.name))
      fillSelect(terima, laci); terima.disabled=true
      fillSelect(sumber, []); sumber.innerHTML = `<option value="">(Tidak berlaku)</option>`; sumber.disabled=true
      $('rowFeeBank').style.display='none'
    }
  }

  $('simpanForm').onclick = async ()=>{
    const jenis = $('f_jenis').value
    const branch = viewBranch || gBranch
    const sumber = $('f_sumber').value || null
    const terima = $('f_terima').value || null
    const nominal = parseNum($('f_nom').value)
    const admin_dalam = parseNum($('f_admin_dalam').value)
    const admin_luar = parseNum($('f_admin_luar').value)
    const fee_bank = parseNum($('f_fee_bank').value)
    const note = $('f_ket').value.trim()

    if(!jenis){ toastErr('Jenis wajib.'); return }
    if(nominal<=0){ toastErr('Nominal harus > 0.'); return }
    if(jenis==='tarik' && (!terima)) { toastErr('Terima Dana (rekening) wajib diisi.'); return }
    if(jenis==='transfer' && (!sumber)) { toastErr('Sumber Dana (rekening) wajib diisi.'); return }
    if(jenis==='pulsa' && (!sumber)) { toastErr('Sumber Dana (server pulsa) wajib diisi.'); return }

    try{
      const { data: sessionData } = await supabase.auth.getSession();
      const user_id = sessionData?.session?.user?.id || null;
      const row={
        branch_code: branch,
        jenis,
        src_account_id: sumber,
        dst_account_id: terima,
        nominal,
        admin_dalam,
        admin_luar,
        fee_bank,
        note,
        user_id
      }
      const { error } = await supabase.from('transactions').insert(row)
      if(error) throw error

      closeForm()
      await loadAccounts()
      await loadKPIs()
      await loadRiwayat()
    }catch(e){ toastErr('Gagal simpan: '+(e.message||e)) }
  }

  // logout
  $('lnk-logout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.href='login.html' })

  // start
  boot()
</script>
</body>
</html>
