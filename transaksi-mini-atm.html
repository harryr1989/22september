<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Transaksi Mini-ATM | Amko MiniLink</title>
  <style>
    :root{
      --navy1:#0b2a5b; --navy2:#123b7a;
      --bg:#f3f6fb; --card:#ffffff; --txt:#0f172a;
      --border:#e6ebf3; --shadow:0 6px 18px rgba(2,8,23,.06);
      --sidebar-w:260px; --H_BAR:48px;

      /* KPI colors */
      --kpi-blue:#1976d2;   /* Transfer */
      --kpi-green:#2e7d32;  /* Tarik */
      --kpi-amber:#ffb300;  /* Omset */
      --kpi-orange:#fb8c00; /* Adm Bank / Fee */
      --kpi-profit:#43a047; /* Profit */
      --kpi-brown:#99501d;  /* Operasional */

      /* Chip saldo */
      --chip1:#6f3bf1; --chip2:#7a4df3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--txt);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }

    /* ===== LAYOUT ===== */
    .layout{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100vh}

    /* ===== SIDEBAR ===== */
    .sidebar{
      position:sticky; top:0; height:100vh; z-index:10001;
      background:linear-gradient(180deg,var(--navy1),var(--navy2));
      color:#eaf2ff; display:flex; flex-direction:column; box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08);font-weight:800}
    .nav{padding:10px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#eaf2ff;text-decoration:none;font-weight:600}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.10)}
    .group{margin-top:12px;border:1px solid rgba(255,255,255,.10);border-radius:10px;overflow:hidden}
    .group-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(255,255,255,.06);cursor:pointer}
    .group-body{padding:8px;display:flex;flex-direction:column;gap:4px}
    .group.collapsed .group-body{display:none}
    .footer{margin-top:auto;padding:12px}
    .logout{width:100%;border:0;border-radius:10px;background:#ef4444;color:#fff;padding:10px 12px;font-weight:800;text-align:center;text-decoration:none;display:block}

    /* ===== HEADER ===== */
    .branchbar{
      position:sticky; top:0; z-index:55; min-height:var(--H_BAR);
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 16px; background:#fff; border-bottom:1px solid var(--border);
    }
    .bb-select{min-width:260px;height:38px;border:1px solid var(--border);border-radius:10px;padding:0 10px;background:#fff;font-weight:700}
    .bb-now{font-weight:800;background:#eef2ff;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .user-role{margin-left:auto;font-weight:900;color:#1e293b}
    .hamburger{display:none;place-items:center;width:38px;height:38px;border-radius:10px;border:1px solid var(--border);background:#fff}

    /* ====== TICKER ====== */
    .ticker{
      background:#2a44a5; color:#eaf2ff;
      border-bottom:1px solid #1e2f84;
      overflow:hidden; position:relative; padding:8px 0;
      --ticker-gap: 20px;
      --ticker-speed: 16s;
      --ticker-shift: 200px;
    }
    .ticker-rail{
      display:flex; align-items:center; width:max-content; will-change:transform;
      gap:var(--ticker-gap);
      animation: ticker-marquee var(--ticker-speed) linear infinite;
    }
    .ticker-chunk{ white-space:nowrap; font-weight:200; letter-spacing:.2px; font-size:13px }
    @keyframes ticker-marquee{
      from{ transform:translateX(0) }
      to  { transform:translateX(calc(-1 * var(--ticker-shift))) }
    }
    @media (prefers-reduced-motion: reduce){ .ticker-rail{ animation:none } }

    /* ===== CONTENT ===== */
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin:14px 18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .card h3{margin:0 0 10px 0}

    /* ===== KPI TRANSAKSI ===== */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:12px;
    }
    .kpi{
      border-radius:16px;box-shadow:var(--shadow);padding:12px 14px;
      color:#fff; display:flex; gap:12px; align-items:center; min-height:76px
    }
    .kpi .ic{
      width:40px;height:40px;border-radius:12px;display:grid;place-items:center;
      background:rgba(255,255,255,.18);font-weight:900;font-size:18px
    }
    .kpi .meta{display:flex;flex-direction:column}
    .kpi .meta h4{margin:0;font-size:12px;color:#eef3ff;letter-spacing:.3px}
    .kpi .meta .val{font-weight:900;font-size:18px;line-height:1.1}

    .kpi.blue   {background:linear-gradient(180deg,var(--kpi-blue),#155a9b)}
    .kpi.green  {background:linear-gradient(180deg,var(--kpi-green),#205b24)}
    .kpi.amber  {background:linear-gradient(180deg,var(--kpi-amber),#c08a00)}
    .kpi.orange {background:linear-gradient(180deg,var(--kpi-orange),#d27100)}
    .kpi.profit {background:linear-gradient(180deg,var(--kpi-profit),#2e6f33)}
    .kpi.brown  {background:linear-gradient(180deg,var(--kpi-brown),#6b3512)}

    /* TOTAL ASSET */
    .asset-main{display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px solid var(--border);border-radius:16px;padding:12px 16px;box-shadow:var(--shadow)}
    .asset-label{font-size:12px;font-weight:800;color:#334155}
    .asset-value{font-size:20px;font-weight:900;color:#16a34a}

    /* ===== KPI SALDO CHIP (scroll) ===== */
    #kpiSaldoWrap{
      display:flex !important; gap:10px !important; overflow-x:auto !important; overflow-y:hidden !important;
      padding:8px 6px 10px !important; scroll-snap-type:x mandatory !important; -webkit-overflow-scrolling:touch !important;
      border-radius:16px !important; background:#fff !important; border:1px solid var(--border) !important; box-shadow:var(--shadow) !important;
    }
    #kpiSaldoWrap > .kpi-card{
      flex:0 0 auto !important; min-width:210px !important; max-width:260px !important; scroll-snap-align:start !important;
      border-radius:999px !important; padding:10px 16px !important;
      background:linear-gradient(180deg,var(--chip1),var(--chip2)) !important; color:#fff !important;
      border:0 !important; display:flex !important; align-items:center !important; justify-content:space-between !important;
      box-shadow:var(--shadow) !important;
    }
    #kpiSaldoWrap .kpi-title{color:#fff !important;font-weight:800 !important}
    #kpiSaldoWrap .kpi-value{color:#fff !important}

    /* TABEL */
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1100px;background:#fff}
    thead th{position:sticky;top:0;background:#eef2ff;border-bottom:1px solid var(--border);padding:12px;font-size:13px;text-align:left;color:#1f2937}
    tbody td{border-bottom:1px solid var(--border);padding:10px 12px}
    tbody tr:hover{background:#f8fafc}

    /* FILTERS & BUTTONS */
    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .sel,.date-input{height:38px;padding:0 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:700}
    .btn-sm{height:38px;padding:0 12px;border-radius:10px;font-weight:800;cursor:pointer;border:1px solid var(--border);background:#fff}
    .btn-primary{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b;border-color:#fee2e2}
    .btn-wa{background:#15803d;color:#fff;border-color:#15803d}
    .btn-excel{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .btn-sm:disabled{opacity:.5;cursor:not-allowed}

    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:100}
    .modal.show{display:flex}
    .dialog{width:min(1024px,100%);background:#fff;border-radius:16px;border:1px solid var(--border);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:92vh}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    .icon-input{display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;min-height:50px}
    .icon-input input,.icon-input select,.icon-input textarea{border:none;outline:none;flex:1;font-size:16px;background:transparent}
    .icon-input textarea{min-height:96px;resize:vertical}
    .dlg-ft{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:12px 16px;display:flex;gap:8px;justify-content:flex-end}

    /* ======= RESPONSIVE BREAKPOINTS =======
       Desktop: 6 kolom
       Tablet:  3 kolom
       Mobile:  2 kolom (seperti screenshot eLink)
       Very small: 1 kolom
    */
    @media (max-width:1080px){ .kpi-grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:2200px){
      .layout{grid-template-columns:1fr}
      .sidebar{position:fixed;left:calc(-1 * var(--sidebar-w));top:0;bottom:0;width:var(--sidebar-w);border-right:1px solid rgba(255,255,255,.12)}
      .sidebar.open{left:0}
      .hamburger{display:grid}
      .row{grid-template-columns:1fr}
      .kpi-grid{grid-template-columns:repeat(2,1fr)}
      .kpi{min-height:72px;padding:12px}
      .kpi .meta .val{font-size:17px}
    }
    @media (max-width:420px){
      .kpi-grid{grid-template-columns:1fr}
      .kpi .meta .val{font-size:16px}
    }
  </style>
</head>
<body>
<div class="layout">
  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Amko MiniLink</div>
    <nav class="nav" id="menuList"></nav>
    <div class="footer">
      <a href="#" id="lnk-logout-visual" class="logout">🚪 Logout</a>
    </div>
  </aside>

  <!-- ===== Main ===== -->
  <div>
    <!-- HEADER / BRANCH BAR -->
    <div id="branchTopBar" class="branchbar">
      <button id="toggleSidebar" class="hamburger" aria-label="Toggle Sidebar" aria-controls="sidebar" aria-expanded="false">☰</button>
      <select id="branchTopSelect" class="bb-select"><option value="">-- Pilih Toko --</option></select>
      <span class="bb-now">TOKO: <strong id="bbNowName">-</strong></span>
      <span id="userRole" class="user-role">-</span>
    </div>

    <!-- === TEKS BERJALAN (MOTIVASI) === -->
    <div class="ticker" id="tickerBar" aria-live="polite">
      <div class="ticker-rail" id="tickerRail">
        <span class="ticker-chunk" id="tickerA">Memuat motivasi…</span>
        <span class="ticker-chunk" id="tickerB">Memuat motivasi…</span>
      </div>
    </div>

    <!-- Content -->
    <div class="grid">
      <!-- KPI Transaksi -->
      <div class="card">
        <h3>KPI Transaksi <span id="kpiTglLabel" class="bb-now" style="margin-left:8px">Hari ini</span></h3>
        <div class="kpi-grid">
          <!-- urutan dibuat mirip eLink -->
          <div class="kpi blue">
            <div class="ic">🔁</div>
            <div class="meta"><h4>TRANSFER</h4><div class="val" id="kpi_transfer">Rp 0</div></div>
          </div>
          <div class="kpi green">
            <div class="ic">💵</div>
            <div class="meta"><h4>TARIK TUNAI</h4><div class="val" id="kpi_tarik">Rp 0</div></div>
          </div>
          <div class="kpi amber">
            <div class="ic">📊</div>
            <div class="meta"><h4>OMSET</h4><div class="val" id="kpi_omset">Rp 0</div></div>
          </div>
          <div class="kpi orange">
            <div class="ic">🏦</div>
            <div class="meta"><h4>ADM BANK</h4><div class="val" id="kpi_fee">Rp 0</div></div>
          </div>
          <div class="kpi brown">
            <div class="ic">⚙️</div>
            <div class="meta"><h4>OPERASIONAL</h4><div class="val" id="kpi_opr">Rp 0</div></div>
          </div>
          <div class="kpi profit" id="kpi_profit_wrap" style="display:none">
            <div class="ic">💹</div>
            <div class="meta"><h4>PROFIT</h4><div class="val" id="kpi_profit">Rp 0</div></div>
          </div>
        </div>
      </div>

      <!-- Asset bar -->
      <div class="card">
        <div class="asset-main">
          <div class="asset-label">TOTAL ASET</div>
          <div class="asset-value" id="assetTotalValue">Rp 0</div>
        </div>
      </div>

      <!-- KPI Saldo akun (chip scroll) -->
      <div class="card">
        <h3>KPI Master Saldo Akun</h3>
        <div id="kpiSaldoWrap" class="kpi-grid"></div>
      </div>

      <!-- Riwayat -->
      <div class="card">
        <h3>Riwayat Transaksi</h3>

        <div class="filters">
          <input id="fltDate" type="date" class="date-input" />
          <select id="fltUser" class="sel"><option value="">Semua User</option></select>
          <select id="fltJenis" class="sel">
            <option value="">Semua Jenis</option>
            <option value="tarik">Tarik Tunai</option>
            <option value="transfer">Transfer</option>
            <option value="pulsa">Pulsa / Kuota</option>
            <option value="jasa">Jasa ATM</option>
          </select>
          <select id="fltRek" class="sel"><option value="">Semua Rek/Server</option></select>

          <div style="flex:1"></div>

          <button id="btnTambah" class="btn-sm btn-primary">➕ Transaksi</button>
          <button class="btn-sm btn-wa" id="btnWA">📲 WhatsApp</button>
          <button class="btn-sm btn-excel" id="btnExport" disabled>📊 Excel</button>
        </div>

        <div id="totalTransaksi" style="margin:6px 0;font-weight:bold;">Jumlah Total Transaksi = 0</div>

        <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
          <table>
            <thead>
              <tr>
                <th>No urut</th>
                <th>User & Tanggal</th>
                <th>ID Trx</th>
                <th>Sumber Dana</th>
                <th>Jenis</th>
                <th>Saldo Awal</th>
                <th>Nominal</th>
                <th>Admin Dalam</th>
                <th>Admin Luar</th>
                <th>Fee Bank</th>
                <th>Saldo Akhir</th>
                <th>Keterangan</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tb"></tbody>
          </table>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:center;">
          <button class="btn-sm btn-ghost" id="btnPrev">⟨ Prev</button>
          <span class="bb-now" id="pageInfo">Hal 1</span>
          <button class="btn-sm btn-ghost" id="btnNext">Next ⟩</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modals ===== -->
<div class="modal" id="modalJenis">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Pilih Jenis Transaksi</span>
      <button class="btn btn-ghost" id="xJenis" style="height:40px">✖</button>
    </div>
    <div class="dlg-bd" style="padding:16px">
      <div style="display:grid;gap:10px">
        <button class="btn-sm btn-ghost" style="height:48px;font-size:15px" data-pilih="tarik">Tarik Tunai</button>
        <button class="btn-sm btn-ghost" style="height:48px;font-size:15px" data-pilih="transfer">Transfer</button>
        <button class="btn-sm btn-ghost" style="height:48px;font-size:15px" data-pilih="pulsa">Pulsa / Kuota</button>
        <button class="btn-sm btn-ghost" style="height:48px;font-size:15px" data-pilih="jasa">Jasa ATM</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modalForm">
  <div class="dialog">
    <div class="dlg-hd">
      <span id="dlgTitle">Form Transaksi</span>
      <button class="btn btn-ghost" id="xForm" style="height:40px">✖</button>
    </div>
    <div class="dlg-bd">
      <div id="msgErr" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px"></div>

      <div class="row">
        <div>
          <label>Jenis</label>
          <div class="icon-input"><span>📂</span><input id="f_jenis" readonly /></div>
        </div>
        <div>
          <label>Cabang</label>
          <div class="icon-input"><span>🏬</span><input id="f_branch" readonly /></div>
        </div>
      </div>

      <div class="row" id="rowSumber">
        <div>
          <label>Sumber Dana</label>
          <div class="icon-input"><span>↗️</span><select id="f_sumber"></select></div>
        </div>
        <div>
          <label>Terima Dana</label>
          <div class="icon-input"><span>↘️</span><select id="f_terima"></select></div>
        </div>
      </div>

      <div class="row" id="rowNominal">
        <div>
          <label id="labelNominal">Nominal (Rp)</label>
          <div class="icon-input"><span>Rp</span><input id="f_nom" inputmode="numeric" placeholder="0" /></div>
        </div>
      </div>

      <div class="row" id="rowAdminDua">
        <div>
          <label>Admin Dalam</label>
          <div class="icon-input"><span>💸</span><input id="f_admin_dalam" inputmode="numeric" placeholder="0" /></div>
        </div>
        <div>
          <label>Admin Luar</label>
          <div class="icon-input"><span>💸</span><input id="f_admin_luar" inputmode="numeric" placeholder="0" /></div>
        </div>
      </div>

      <div class="row" id="rowAdminLuarOnly" style="display:none">
        <div>
          <label>Admin Luar</label>
          <div class="icon-input"><span>💸</span><input id="f_admin_luar_only" inputmode="numeric" placeholder="0" /></div>
        </div>
      </div>

      <div class="row" id="rowFeeBank" style="display:none">
        <div>
          <label>Fee Bank (Transfer)</label>
          <div class="icon-input"><span>🏦</span><input id="f_fee_bank" inputmode="numeric" placeholder="0" /></div>
        </div>
      </div>

      <div class="row" id="rowPulsa" style="display:none">
        <div>
          <label>Modal (harga modal)</label>
          <div class="icon-input"><span>Rp</span><input id="f_modal" inputmode="numeric" placeholder="0" /></div>
        </div>
        <div>
          <label>Jual (harga jual)</label>
          <div class="icon-input"><span>Rp</span><input id="f_jual" inputmode="numeric" placeholder="0" /></div>
        </div>
      </div>

      <div>
        <label>Keterangan (wajib diisi, mis. No HP / No Ref)</label>
        <div class="icon-input"><input id="f_ket" type="text" maxlength="50" placeholder="contoh: 081234567890" required /></div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn btn-ghost" id="batalForm">Batal</button>
      <button class="btn btn-primary" id="simpanForm">Simpan</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const supabase = createClient(
    "https://kfqcdcvcnyhisbmwftzb.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y",
    { auth:{ persistSession:true, autoRefreshToken:true } }
  );

  const $ = id=>document.getElementById(id)
  const fmtRp  = n => "Rp " + new Intl.NumberFormat('id-ID').format(Number(n||0))
  const fmtNum = n => new Intl.NumberFormat('id-ID').format(Number(n||0))
  const parseNum = v => Number(String(v||'').replace(/[^0-9]/g,''))||0

  const getActive = ()=>({ code: localStorage.getItem('current_branch_code')||'', name: localStorage.getItem('current_branch_name')||'' })
  const setActive = (code,name)=>{ localStorage.setItem('current_branch_code',code||''); localStorage.setItem('current_branch_name',name||'') }

  let gRole=null, gBranch=null, viewBranch=null
  let cacheAcc={ cash:[], rekening:[], server_pulsa:[] }
  let lastRiwayatRows=[]
  let editMode=false, editId=null

  // Pagination
  let page=0, pageSize=25, totalRows=0

  // Range tanggal
  let range={from:null,to:null}
  const toISODate = d => new Date(d).toISOString().slice(0,10)
  const startOfDayISO = d=>{const x=new Date(d);x.setHours(0,0,0,0);return x.toISOString()}
  const endOfDayISO   = d=>{const x=new Date(d);x.setHours(23,59,59,999);return x.toISOString()}
  const fmtHuman = d=> new Date(d).toLocaleString('id-ID',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'})
  const fmtHumanDateOnly = d => new Date(d).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})

  const flt = { user:'', jenis:'', acc:'' }

  // WA summary
  const saldoSum = { cash:0, rek:0, asset:0, server:0 }
  let waRekeningList = [], waServerList = [], waCashList = []

  /* ====== Ticker Motivasi (rapi) ====== */
  const TICKER_QUOTES = [
    "Fokus pada proses, hasil akan menyusul",
    "Disiplin kecil hari ini jadi lompatan besar esok",
    "Bekerja jujur, rezeki bertemu jalan",
    "Konsisten lebih kuat dari motivasi sesaat",
    "Belajar dari data, bergerak dengan hati",
    "Progress lebih penting daripada perfect",
    "Kerja tuntas, tidur nyenyak",
    "Kepercayaan dibangun dari akurasi",
    "Setiap angka bercerita—baca, pahami, bertindak",
    "Tidak ada alasan, yang ada solusi"
  ]
  const TICKER_DURATION_S = 6
  const TICKER_GAP_PX = 10
  let _tickerIndex = 0

  function buildQuoteLine(){
    const MAX_PER_LOOP = 2;  // tampilkan 4 quote per putaran (biar tidak kepanjangan)
    const ordered=[]
    for(let i=0;i<MAX_PER_LOOP;i++){
      ordered.push(TICKER_QUOTES[(_tickerIndex+i)%TICKER_QUOTES.length])
    }
    return ordered.join('   •   ')
  }
  function adjustTickerLayout(){
    const rail = document.getElementById('tickerRail')
    const a = document.getElementById('tickerA')
    if(!rail || !a) return
    const shift = a.offsetWidth + TICKER_GAP_PX
    rail.style.setProperty('--ticker-shift', shift + 'px')
    rail.style.setProperty('--ticker-speed', TICKER_DURATION_S + 's')
  }
  function updateTicker(){
    const a = document.getElementById('tickerA')
    const b = document.getElementById('tickerB')
    const rail = document.getElementById('tickerRail')
    if(!a || !b || !rail) return
    const msg = buildQuoteLine()
    a.textContent = msg; b.textContent = msg
    rail.style.animation = 'none'; void rail.offsetWidth
    adjustTickerLayout()
    rail.style.animation = `ticker-marquee var(--ticker-speed) linear infinite`
    _tickerIndex = (_tickerIndex + 1) % TICKER_QUOTES.length
  }
  function startTickerRotation(){
    updateTicker()
    window.addEventListener('resize', adjustTickerLayout)
    setInterval(updateTicker, TICKER_DURATION_S * 500)
  }

  // Mask angka
  ;(()=>{['f_nom','f_admin_dalam','f_admin_luar','f_admin_luar_only','f_fee_bank','f_modal','f_jual'].forEach(id=>{
    const el=$(id); if(!el) return; el.addEventListener('input',e=>{const raw=e.target.value.replace(/\D/g,''); e.target.value = raw? new Intl.NumberFormat('id-ID').format(Number(raw)) : ''})
  })})()

  function setPresetToday(){
    const today = new Date()
    const iso = toISODate(today)
    range.from = iso; range.to = iso
    $('fltDate').value = iso
    $('kpiTglLabel').textContent = fmtHumanDateOnly(today)
  }
  function setDateRange(dateISO){
    range.from = dateISO; range.to = dateISO
    $('kpiTglLabel').textContent = fmtHumanDateOnly(dateISO)
  }
  function getRangeISO(){
    const pick = range.from || toISODate(new Date())
    const tmin = startOfDayISO(new Date(pick))
    const tmax = endOfDayISO(new Date(pick))
    return { tmin, tmax }
  }

  // ===== BOOT =====
  async function boot(){
    setPresetToday()

    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }

    const { data: prof } = await supabase.from('profiles').select('role,branch_code,full_name,email').eq('id', session.user.id).single()
    gRole = (prof?.role||'').toLowerCase() || (localStorage.getItem('user_role')||'kasir')
    gBranch = (prof?.branch_code||'').trim()

    if ((gRole||'') !== 'owner') {
      setActive(gBranch, gBranch)
      viewBranch = gBranch
    } else {
      const saved = getActive()
      viewBranch = saved.code || gBranch || ''
    }

    const nm = (prof?.full_name || prof?.email || '-').split(' ')[0].toUpperCase()
    $('userRole').textContent = `${nm}–${(gRole||'').toUpperCase()}`
    $('kpi_profit_wrap').style.display = (gRole==='owner') ? 'flex' : 'none'

    await initSidebar()
    await initBranchBar()
    await loadAccounts()
    await populateFilterOptions()
    $('fltDate').addEventListener('change', async ()=>{
      const val = $('fltDate').value || toISODate(new Date())
      setDateRange(val); $('btnExport').disabled = true; await refreshByRange()
    })
    $('btnWA').addEventListener('click', sendWhatsAppSummary)

    await refreshByRange()
    startTickerRotation()
  }

  async function refreshByRange(){
    page=0
    await loadKPITransaksi()
    await loadKPISaldo()
    await loadRiwayat()
  }

  async function loadAccounts(){
    if(!viewBranch) return
    const { data } = await supabase.from('accounts').select('id,name,account_type,branch_code,saldo').eq('branch_code', viewBranch).order('name')
    cacheAcc={ cash:[], rekening:[], server_pulsa:[] }
    ;(data||[]).forEach(a=>{ if(cacheAcc[a.account_type]) cacheAcc[a.account_type].push(a) })
  }

  async function populateFilterOptions(){
    const uSel = $('fltUser')
    if(viewBranch){
      const { data: users } = await supabase.from('profiles').select('full_name,branch_code').eq('branch_code', viewBranch).order('full_name')
      uSel.innerHTML = '<option value="">Semua User</option>' + (users||[])
        .filter(u=>u.full_name && u.full_name.trim().length>0)
        .map(u=>`<option value="${u.full_name}">${u.full_name}</option>`).join('')
    } else { uSel.innerHTML = '<option value="">Semua User</option>' }

    const list=[...(cacheAcc.rekening||[]), ...(cacheAcc.server_pulsa||[])]
    const rSel = $('fltRek')
    rSel.innerHTML = '<option value="">Semua Rek/Server</option>' + list.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')

    uSel.onchange = ()=>{ flt.user = uSel.value||''; $('btnExport').disabled=true; refreshByRange() }
    $('fltJenis').onchange = ()=>{ flt.jenis = $('fltJenis').value||''; $('btnExport').disabled=true; refreshByRange() }
    rSel.onchange = ()=>{ flt.acc = rSel.value||''; $('btnExport').disabled=true; refreshByRange() }
  }

  // KPI transaksi
  async function loadKPITransaksi(){
    const { tmin, tmax } = getRangeISO()
    const { data } = await supabase.from('transactions')
      .select('jenis, nominal, admin_dalam, admin_luar, fee_bank, branch_code, created_at')
      .eq('branch_code', viewBranch).gte('created_at', tmin).lte('created_at', tmax)

    let omset=0, tarik=0, transfer=0, fee=0, profit=0, opr=0
    for(const r of (data||[])){
      const n=+r.nominal||0, ad=+r.admin_dalam||0, al=+r.admin_luar||0, fb=+r.fee_bank||0
      if(r.jenis==='tarik')     tarik+=n
      else if(r.jenis==='transfer') transfer+=n
      else if(r.jenis==='jasa') opr += al
      omset+=n; fee+=fb; profit += (ad+al-fb)
    }
    $('kpi_omset').textContent=fmtRp(omset)
    $('kpi_tarik').textContent=fmtRp(tarik)
    $('kpi_transfer').textContent=fmtRp(transfer)
    $('kpi_fee').textContent=fmtRp(fee)
    $('kpi_opr').textContent=fmtRp(opr)
    if(gRole==='owner') $('kpi_profit').textContent=fmtRp(profit)
  }

  // Asset & saldo
  function updateAssetBar(list){
    const totalAsset = (list||[]).reduce((s,a)=> s + Number(a.saldo||0), 0)
    saldoSum.asset = totalAsset
    $('assetTotalValue').textContent = fmtRp(totalAsset)
  }
  async function loadKPISaldo(){
    const { data } = await supabase.from('accounts').select('id,name,account_type,branch_code,saldo').eq('branch_code', viewBranch).order('name')

    const cashArr = (data||[]).filter(a=>a.account_type==='cash')
    const rekArr  = (data||[]).filter(a=>a.account_type==='rekening')
    const srvArr  = (data||[]).filter(a=>a.account_type==='server_pulsa')

    saldoSum.cash = cashArr.reduce((s,a)=>s + Number(a.saldo||0), 0)
    saldoSum.rek  = rekArr.reduce((s,a)=>s + Number(a.saldo||0), 0)
    saldoSum.server = srvArr.reduce((s,a)=>s + Number(a.saldo||0), 0)
    saldoSum.asset = saldoSum.cash + saldoSum.rek + saldoSum.server

    waCashList     = cashArr.map(a=>({ name: a.name||'Cash', saldo: Number(a.saldo||0) }))
    waRekeningList = rekArr.map(a=>({ name: a.name||'Rekening', saldo: Number(a.saldo||0) }))
    waServerList   = srvArr.map(a=>({ name: a.name||'Server', saldo: Number(a.saldo||0) }))

    updateAssetBar(data||[])
    renderKPISaldoCards(data||[])
  }
  function renderKPISaldoCards(list){
    const wrap=$('kpiSaldoWrap')
    const laci=(list||[]).filter(a=> a.account_type==='cash' && /laci/i.test(a.name||''))
    const rek=(list||[]).filter(a=> a.account_type==='rekening').sort((a,b)=>(a.name||'').localeCompare(b.name||''))
    const srv=(list||[]).filter(a=> a.account_type==='server_pulsa').sort((a,b)=>(a.name||'').localeCompare(b.name||''))

    const card = a => `
      <div class="kpi-card" title="ID: ${a.id}">
        <div class="kpi-title">${a.name|| (a.account_type||'').toUpperCase()}</div>
        <div class="kpi-value">${fmtRp(a.saldo||0)}</div>
      </div>
    `
    let html=''
    laci.forEach(a=> html+=card(a))
    rek.forEach(a=> html+=card(a))
    srv.forEach(a=> html+=card(a))
    if(!html) html = `<div class="kpi-card"><div class="kpi-title">Tidak ada akun</div><div class="kpi-value">Rp 0</div></div>`
    wrap.innerHTML=html
  }

  // CSV export
  function csvEscape(v){ if(v==null) return ''; const s=String(v).replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim(); return /[",;]/.test(s)?`"${s.replace(/"/g,'""')}"`:s }
  function updateExportState(){ const hasData = (lastRiwayatRows||[]).length > 0; $('btnExport').disabled = !hasData }
  function exportCSV(){
    const rows=lastRiwayatRows||[]; if(rows.length===0) return
    const header=['No urut','User','Tanggal','ID Trx','Sumber Dana','Jenis','SRC Saldo Awal','DST Saldo Awal','Nominal','Admin Dalam','Admin Luar','Fee Bank','SRC Saldo Akhir','DST Saldo Akhir','Keterangan']
    const lines=[header.join(',')]
    let i=1 + page*pageSize
    for(const r of rows){
      const rec=[i++,r.created_by_name||'',fmtHuman(r.created_at),(r.id_trx||r.id),
        `${r.src_account_name||''}${r.dst_account_name?` → ${r.dst_account_name}`:''}`, r.jenis||'',
        (r.src_saldo_awal??''),(r.dst_saldo_awal??''),(r.nominal??0),(r.admin_dalam??0),(r.admin_luar??0),(r.fee_bank??0),(r.src_saldo_akhir??''),(r.dst_saldo_akhir??''), r.note||''].map(csvEscape)
      lines.push(rec.join(','))
    }
    const f=range.from||toISODate(new Date())
    const fname = `riwayat_${f}_p${page+1}.csv`
    const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500)
  }
  $('btnExport').onclick=exportCSV

  // WA summary
  function fmtMakassar(dt=new Date()){
    const tz='Asia/Makassar', pad=n=>String(n).padStart(2,'0')
    const z=new Date(dt.toLocaleString('en-US',{timeZone:tz}))
    return `${pad(z.getDate())}-${pad(z.getMonth()+1)}-${z.getFullYear()} ${pad(z.getHours())}:${pad(z.getMinutes())}:${pad(z.getSeconds())}`
  }
  function buildWhatsAppText(){
    const cab = localStorage.getItem('current_branch_name') || viewBranch || '-'
    const header = [
      `*LAPORAN SUMBER DANA,*`,``,`*CABANG : ${cab}*`,``,`*Report By:* ${$('userRole').textContent || '-'}`,`*Generated at:* ${fmtMakassar()}`
    ].join('\n')
    const section = (title, list) => {
      if(!list || !list.length) return ''
      let lines = list.map((a,i)=>`${i+1}. ${a.name}: ${fmtRp(a.saldo||0)}`).join('\n')
      let subtotal = list.reduce((s,a)=> s + Number(a.saldo||0), 0)
      return [``, `*> ${title}*`, lines, ``, `*Subtotal ${title}:* ${fmtRp(subtotal)}`, ``].join('\n')
    }
    const bankTxt   = section('BANK', waRekeningList)
    const serverTxt = section('SERVER PULSA', waServerList)
    const cashTxt   = section('LACI / CASH', waCashList)
    const totalTxt  = `*TOTAL ASSET:* ${fmtRp(saldoSum.asset)}`
    return [header, bankTxt, serverTxt, cashTxt, totalTxt].filter(Boolean).join('\n')
  }
  function sendWhatsAppSummary(){
    const txt = buildWhatsAppText()
    const url = `https://wa.me/?text=${encodeURIComponent(txt)}`
    window.open(url, '_blank')
  }

  // Riwayat
  const saldoBlock = (srcName, srcVal, dstName, dstVal) => {
    const fmt = v => (v ?? null) !== null ? fmtNum(v) : '-'
    let html = ''
    if (srcName || srcVal !== undefined) html += `<div>${(srcName || 'SRC')}: <b>${fmt(srcVal)}</b></div>`
    if (dstName || dstVal !== undefined) html += `<div>${(dstName || 'DST')}: <b>${fmt(dstVal)}</b></div>`
    return html || '-'
  }

  async function loadRiwayat(){
    const { tmin, tmax } = getRangeISO()
    if(!viewBranch){
      $('tb').innerHTML=`<tr><td colspan="13">Pilih cabang terlebih dahulu.</td></tr>`
      $('btnPrev').disabled=true; $('btnNext').disabled=true; $('pageInfo').textContent='Hal -'
      lastRiwayatRows=[]; updateExportState(); return
    }

    let qCount = supabase.from('v_tx_summary').select('*',{ count:'exact', head:true })
      .eq('branch_code', viewBranch).gte('created_at', tmin).lte('created_at', tmax)
    if(flt.jenis) qCount = qCount.eq('jenis', flt.jenis)
    if(flt.user)  qCount = qCount.eq('created_by_name', flt.user)
    if(flt.acc)   qCount = qCount.or(`src_account_id.eq.${flt.acc},dst_account_id.eq.${flt.acc}`)
    const { count:cnt } = await qCount
    totalRows = cnt || 0
    $('totalTransaksi').textContent = 'Jumlah Total Transaksi = ' + totalRows

    let dataQuery = supabase.from('v_tx_summary').select(`
      id, id_trx, jenis, src_account_id, src_account_name, dst_account_id, dst_account_name,
      nominal, admin_dalam, admin_luar, fee_bank,
      src_saldo_awal, src_saldo_akhir, dst_saldo_awal, dst_saldo_akhir,
      note, created_by_name, created_at, branch_code
    `).eq('branch_code', viewBranch).gte('created_at', tmin).lte('created_at', tmax)
    if(flt.jenis) dataQuery = dataQuery.eq('jenis', flt.jenis)
    if(flt.user)  dataQuery = dataQuery.eq('created_by_name', flt.user)
    if(flt.acc)   dataQuery = dataQuery.or(`src_account_id.eq.${flt.acc},dst_account_id.eq.${flt.acc}`)

    const { data, error } = await dataQuery.order('created_at',{ascending:false}).range(page*pageSize,(page+1)*pageSize-1)
    if(error){
      $('tb').innerHTML = `<tr><td colspan="13" style="color:#991b1b">Gagal memuat riwayat: ${error.message}</td></tr>`
      $('btnPrev').disabled=true; $('btnNext').disabled=true; $('pageInfo').textContent='Hal -'
      lastRiwayatRows=[]; updateExportState(); return
    }
    const rows=data||[]; lastRiwayatRows=rows
    if(rows.length===0){
      $('tb').innerHTML = `<tr><td colspan="13" style="color:#64748b">Belum ada transaksi pada tanggal ini.</td></tr>`
      $('btnPrev').disabled = page===0
      $('btnNext').disabled = (page+1)*pageSize >= totalRows
      $('pageInfo').textContent = `Hal ${page+1}`
      updateExportState(); return
    }

    let i = 1 + page*pageSize
    $('tb').innerHTML = rows.map(r=>{
      const tgl = fmtHuman(r.created_at)
      const user = r.created_by_name || '-'
      const src = r.src_account_name || '-'
      const dst = r.dst_account_name || ''
      const sumberDana = dst ? `${src} → ${dst}` : src
      const saldoAwalCell  = saldoBlock(r.src_account_name, r.src_saldo_awal,  r.dst_account_name, r.dst_saldo_awal)
      const saldoAkhirCell = saldoBlock(r.src_account_name, r.src_saldo_akhir, r.dst_account_name, r.dst_saldo_akhir)

      return `<tr data-id="${r.id}">
        <td>${i++}</td>
        <td>(<span style="color:#1d4ed8">${user}</span>, ${tgl})</td>
        <td><code>${r.id_trx || r.id}</code></td>
        <td>${sumberDana}</td>
        <td style="text-transform:capitalize">${r.jenis}</td>
        <td>${saldoAwalCell}</td>
        <td>${fmtNum(r.nominal || 0)}</td>
        <td>${r.admin_dalam ? fmtNum(r.admin_dalam) : '-'}</td>
        <td>${r.admin_luar ? fmtNum(r.admin_luar) : '-'}</td>
        <td>${r.fee_bank ? fmtNum(r.fee_bank) : '-'}</td>
        <td>${saldoAkhirCell}</td>
        <td>${r.note || '-'}</td>
        <td>
          <button class="btn-sm btn-ghost" data-act="edit" title="Edit">✏️</button>
          <button class="btn-sm btn-danger" data-act="del" title="Hapus">🗑️</button>
        </td>
      </tr>`
    }).join('')

    $('btnPrev').disabled = page===0
    $('btnNext').disabled = (page+1)*pageSize >= totalRows
    $('pageInfo').textContent = `Hal ${page+1}`
    updateExportState()
  }

  // Pagination
  $('btnPrev').onclick=async()=>{ if(page>0){ page--; await loadRiwayat() } }
  $('btnNext').onclick=async()=>{ if((page+1)*pageSize < totalRows){ page++; await loadRiwayat() } }

  // Modal jenis
  document.getElementById('btnTambah').onclick=()=>$('modalJenis').classList.add('show')
  $('xJenis').onclick=()=>$('modalJenis').classList.remove('show')
  document.querySelectorAll('#modalJenis [data-pilih]').forEach(b=>b.addEventListener('click',()=>{ const j=b.getAttribute('data-pilih'); $('modalJenis').classList.remove('show'); setupForm(j); $('modalForm').classList.add('show') }))

  // Modal form
  $('xForm').onclick=$('batalForm').onclick=()=>{ $('modalForm').classList.remove('show'); editMode=false; editId=null; }

  // Helpers form
  function fillSelect(sel, items){ sel.innerHTML=(items||[]).map(i=>`<option value="${i.id}">${i.name}</option>`).join('') || '<option value="">(Tidak ada opsi)</option>' }
  const findLaci = ()=> (cacheAcc.cash||[]).find(a=>/laci/i.test(a.name||'')) || null

  function setupForm(jenis){
    $('dlgTitle').textContent=`Form ${jenis.toUpperCase()}`
    $('f_jenis').value=jenis; $('f_branch').value=viewBranch
    ;['f_nom','f_admin_dalam','f_admin_luar','f_admin_luar_only','f_fee_bank','f_ket','f_modal','f_jual'].forEach(id=>{const el=$(id); if(el) el.value=''})

    const sumber=$('f_sumber'), terima=$('f_terima'), laci=findLaci()
    $('rowNominal').style.display='none'; $('rowAdminDua').style.display='none'; $('rowAdminLuarOnly').style.display='none'; $('rowFeeBank').style.display='none'; $('rowPulsa').style.display='none'; $('rowSumber').style.display='grid'; $('labelNominal').textContent='Nominal (Rp)'

    if(jenis==='tarik'){
      fillSelect(sumber, laci?[laci]:[]); sumber.disabled=true
      fillSelect(terima, cacheAcc.rekening||[]); terima.disabled=false
      $('rowNominal').style.display='grid'; $('rowAdminDua').style.display='grid'
    }else if(jenis==='transfer'){
      const sumberList=[...(cacheAcc.rekening||[]), ...(cacheAcc.server_pulsa||[])]
      fillSelect(sumber, sumberList); sumber.disabled=false
      fillSelect(terima, laci?[laci]:[]); terima.disabled=true
      $('rowNominal').style.display='grid'; $('rowAdminLuarOnly').style.display='grid'; $('rowFeeBank').style.display='grid'
    }else if(jenis==='pulsa'){
      const sumberList=[...(cacheAcc.rekening||[]), ...(cacheAcc.server_pulsa||[])]
      fillSelect(sumber, sumberList); sumber.disabled=false
      fillSelect(terima, laci?[laci]:[]); terima.disabled=true
      $('rowPulsa').style.display='grid'
    }else if(jenis==='jasa'){
      $('rowSumber').style.display='none'
      if(laci){ terima.innerHTML=`<option value="${laci.id}">${laci.name}</option>` }
      $('rowAdminLuarOnly').style.display='grid'
    }
  }

  // Eksklusif admin dalam/luar untuk TARIK
  $('f_admin_dalam').addEventListener('input',()=>{ if(parseNum($('f_admin_dalam').value)>0) $('f_admin_luar').value='' })
  $('f_admin_luar').addEventListener('input',()=>{ if(parseNum($('f_admin_luar').value)>0) $('f_admin_dalam').value='' })

  // CRUD
  document.addEventListener('click', async (e)=>{
    const actBtn = e.target.closest('button[data-act]')
    if(!actBtn) return
    const tr = actBtn.closest('tr[data-id]'); const id = tr?.getAttribute('data-id'); const act = actBtn.getAttribute('data-act')
    if(act==='del'){
      if(!confirm('Hapus transaksi ini?')) return
      const { error } = await supabase.from('transactions').delete().eq('id', id)
      if(error) return alert('Gagal hapus: '+error.message)
      await refreshByRange()
    }else if(act==='edit'){
      const row = (lastRiwayatRows||[]).find(r=>r.id===id); if(!row) return alert('Data tidak ditemukan')
      editMode=true; editId=id
      setupForm(row.jenis)
      $('f_jenis').value=row.jenis; $('f_branch').value=row.branch_code
      if(row.src_account_id) $('f_sumber').value=row.src_account_id
      if(row.dst_account_id) $('f_terima').value=row.dst_account_id
      $('f_nom').value=fmtNum(row.nominal||0); $('f_admin_dalam').value=fmtNum(row.admin_dalam||0); $('f_admin_luar').value=fmtNum(row.admin_luar||0); $('f_fee_bank').value=fmtNum(row.fee_bank||0); $('f_ket').value=row.note||''
      if(row.jenis==='pulsa'){ $('f_modal').value=fmtNum(row.nominal||0); $('f_jual').value=fmtNum((row.nominal||0)+(row.admin_luar||0)) }
      if(row.jenis==='jasa'){ $('f_admin_luar_only').value=fmtNum(row.admin_luar||0) }
      $('modalForm').classList.add('show')
    }
  })

  // Simpan
  $('simpanForm').onclick = async ()=>{
    const jenis=$('f_jenis').value, branch=viewBranch, sumber=$('f_sumber').value||null, terima=$('f_terima').value||null, note=$('f_ket').value.trim()
    const findLaci=()=> (cacheAcc.cash||[]).find(a=>/laci/i.test(a.name||''))||null
    try{
      if(!note) throw new Error('Keterangan wajib diisi (mis. No HP / No Ref).')
      let row={ branch_code:branch, jenis, src_account_id:sumber, dst_account_id:terima, nominal:0, admin_dalam:0, admin_luar:0, fee_bank:0, note }

      if(jenis==='tarik'){
        if(!terima) throw new Error('Terima Dana (rekening) wajib diisi.')
        const laci=findLaci(); if(!laci) throw new Error('Tidak ditemukan akun Laci Tunai.')
        row.src_account_id=laci.id
        const nominal=parseNum($('f_nom').value), ad=parseNum($('f_admin_dalam').value), al=parseNum($('f_admin_luar').value)
        if(nominal<=0) throw new Error('Nominal harus > 0.')
        if(ad>0 && al>0) throw new Error('Isi salah satu: Admin Dalam ATAU Admin Luar.')
        row.nominal=nominal; row.admin_dalam=ad>0?ad:0; row.admin_luar=al>0?al:0; row.fee_bank=0
      }
      else if(jenis==='transfer'){
        if(!sumber) throw new Error('Sumber Dana (rekening/server) wajib diisi.')
        const laci=findLaci(); if(!laci) throw new Error('Tidak ditemukan akun Laci Tunai.')
        row.dst_account_id=laci.id
        const nominal=parseNum($('f_nom').value), al=parseNum($('f_admin_luar_only').value), fb=parseNum($('f_fee_bank').value)
        if(nominal<=0) throw new Error('Nominal harus > 0.')
        row.nominal=nominal; row.admin_dalam=0; row.admin_luar=al; row.fee_bank=fb
      }
      else if(jenis==='pulsa'){
        if(!sumber) throw new Error('Sumber Dana (rekening/server) wajib diisi.')
        const laci=findLaci(); if(!laci) throw new Error('Tidak ditemukan akun Laci Tunai.')
        row.dst_account_id=laci.id
        const modal=parseNum($('f_modal').value), jual=parseNum($('f_jual').value)
        if(modal<=0) throw new Error('Modal harus > 0.')
        if(jual<modal) throw new Error('Jual tidak boleh kurang dari Modal.')
        const margin=Math.max(jual-modal,0)
        row.nominal=modal; row.admin_dalam=0; row.admin_luar=margin; row.fee_bank=0
      }
      else if(jenis==='jasa'){
        const laci=findLaci(); if(!laci) throw new Error('Tidak ditemukan akun Laci Tunai.')
        row.src_account_id=null; row.dst_account_id=laci.id
        const al=parseNum($('f_admin_luar_only').value)
        if(al<=0) throw new Error('Fee Admin (Admin Luar) harus > 0.')
        row.nominal=0; row.admin_luar=al; row.admin_dalam=0; row.fee_bank=0
      }

      if(editMode && editId){
        const { error:delErr } = await supabase.from('transactions').delete().eq('id',editId)
        if(delErr) throw new Error('Gagal hapus data lama: '+delErr.message)
      }

      const { error } = await supabase.from('transactions').insert(row)
      if(error) throw error

      $('modalForm').classList.remove('show'); editMode=false; editId=null
      await refreshByRange()
    }catch(e){
      const m=$('msgErr'); m.textContent='Gagal simpan: '+(e.message||e); m.style.display='block'; setTimeout(()=>m.style.display='none',3000)
    }
  }

  // Branch bar
  async function initBranchBar(){
    const sel=$('branchTopSelect'), lbl=$('bbNowName')
    const { data:{ session } } = await supabase.auth.getSession()
    let role=(localStorage.getItem('user_role')||'').toLowerCase(), prof=null
    if(session){
      const { data } = await supabase.from('profiles').select('role,branch_code').eq('id',session.user.id).maybeSingle()
      prof=data||null; if(prof?.role) role=prof.role.toLowerCase()
    }
    if(!role) role='kasir'

    let list=[]
    if(role==='owner'){
      const { data } = await supabase.from('branches').select('code,name').order('name')
      list=(data||[]).map(b=>({code:b.code,name:b.name||b.code}))
    } else {
      list = prof?.branch_code ? [{code:prof.branch_code,name:prof.branch_code}] : []
    }

    sel.innerHTML='<option value="">-- Pilih Toko --</option>'+list.map(b=>`<option value="${b.code}">${b.name}</option>`).join('')

    let active
    if(role==='owner'){
      const saved=getActive()
      active = saved.code ? saved : (list[0] || {code:'',name:''})
    }else{
      active = list[0] || {code:'',name:''}
      setActive(active.code, active.name)
      sel.style.display='none'
    }

    if(active.code){
      sel.value=active.code
      lbl.textContent=active.name||active.code
      viewBranch=active.code
    } else { lbl.textContent='-' }

    sel.onchange = async ()=>{
      if(role!=='owner') return
      const code = sel.value
      const name = sel.options[sel.selectedIndex]?.text || code
      if(!code) return
      setActive(code, name); lbl.textContent = name; viewBranch = code
      await loadAccounts(); await populateFilterOptions(); await refreshByRange()
    }
  }

  /* Sidebar builder */
  function normPath(u){ return (u||'').toLowerCase().split('/').pop().replace(/[#?].*$/,'') || 'index.html' }
  function isActive(link){
    const current = normPath(location.pathname), target = normPath(link)
    const EQUIV = new Set(['das.html','dashboard.html','index.html',''])
    const curSet = EQUIV.has(current) ? EQUIV : new Set([current])
    const tgtSet = EQUIV.has(target)  ? EQUIV : new Set([target])
    for(const v of curSet){ if(tgtSet.has(v)) return true } return false
  }
  async function initSidebar(){
    const roleLS=(localStorage.getItem("user_role")||gRole||"kasir").toLowerCase();
    const menuModel=[
      { type:"item", label:"Dashboard", icon:"📊", link:"./dashboard.html" },
      { type:"item", label:"Transaksi Mini ATM", icon:"🧮", link:"./transaksi-mini-atm.html" },
      { type:"group", key:"grp_master", title:"Master Data", icon:"📂",
        items:[ {type:"item",label:"Master Saldo Akun",icon:"💰",link:"./master-saldo-akun.html"},
                {type:"item",label:"Mutasi Saldo",icon:"🔄",link:"./mutasi-saldo.html"},
                {type:"item",label:"Saldo Real",icon:"📑",link:"./saldo-real.html"} ] },
      { type:"group", key:"grp_laporan", title:"Laporan", icon:"📘",
        items:[ {type:"item",label:"Laporan MiniLink",icon:"📘",link:"./laporan.html"} ]},
      { type:"group", key:"grp_pengaturan", title:"Pengaturan", icon:"⚙️",
        items:[ {type:"item",label:"Manajemen Pengguna",icon:"👥",link:"./manajemen-pengguna.html",ownerOnly:true},
                {type:"item",label:"Hak Akses",icon:"🔑",link:"./hak-akses.html",ownerOnly:true} ] }
    ];
    function getGroupState(k){ const st=JSON.parse(localStorage.getItem("sidebar_groups_state")||"{}"); return st[k]!==false }
    function setGroupState(k,o){ const st=JSON.parse(localStorage.getItem("sidebar_groups_state")||"{}"); st[k]=!!o; localStorage.setItem("sidebar_groups_state",JSON.stringify(st)) }

    const nav=document.getElementById("menuList"); nav.innerHTML="";
    menuModel.forEach(n=>{
      if(n.ownerOnly && roleLS!=="owner") return;
      if(n.type==="item"){
        const a=document.createElement("a"); a.href=n.link; a.textContent=`${n.icon} ${n.label}`;
        if(isActive(n.link)) a.classList.add("active"); nav.appendChild(a);
      }else{
        const g=document.createElement("div"); g.className="group"; if(!getGroupState(n.key)) g.classList.add("collapsed");
        const h=document.createElement("div"); h.className="group-header";
        h.innerHTML=`<div>${n.icon} ${n.title}</div><div class="chev">▾</div>`;
        h.addEventListener("click",()=>{ const open=!g.classList.contains("collapsed"); if(open) g.classList.add("collapsed"); else g.classList.remove("collapsed"); setGroupState(n.key,!open) });
        const b=document.createElement("div"); b.className="group-body";
        (n.items||[]).forEach(it=>{
          if(it.ownerOnly && roleLS!=="owner") return;
          const a=document.createElement("a"); a.href=it.link; a.textContent=`${it.icon} ${it.label}`;
          if(isActive(it.link)) a.classList.add("active"); b.appendChild(a);
        });
        g.appendChild(h); g.appendChild(b); nav.appendChild(g);
      }
    })

    document.getElementById('lnk-logout-visual').addEventListener('click', async (e)=>{
      e.preventDefault(); await supabase.auth.signOut();
      localStorage.removeItem('current_branch_code'); localStorage.removeItem('current_branch_name');
      location.href='login.html';
    })
  }

  // Hamburger + overlay
  const sidebarEl = document.getElementById('sidebar');
  const overlayEl = document.createElement('div'); overlayEl.className='overlay';
  Object.assign(overlayEl.style,{position:'fixed',inset:'0',background:'rgba(2,6,23,.45)',opacity:'0',pointerEvents:'none',transition:'opacity .25s ease',zIndex:'9999'});
  document.body.appendChild(overlayEl);
  const btnHamb = document.getElementById('toggleSidebar');
  function toggleSidebar(open){
    const willOpen = (typeof open==='boolean') ? open : !sidebarEl.classList.contains('open');
    sidebarEl.classList.toggle('open', willOpen);
    overlayEl.style.opacity = willOpen ? '1':'0';
    overlayEl.style.pointerEvents = willOpen ? 'auto':'none';
    document.body.style.overflow = willOpen ? 'hidden':'auto';
    btnHamb?.setAttribute('aria-expanded', String(willOpen));
  }
  btnHamb?.addEventListener('click', ()=> toggleSidebar());
  overlayEl?.addEventListener('click', ()=> toggleSidebar(false));
  window.addEventListener('keyup', (e)=>{ if(e.key==='Escape') toggleSidebar(false); });

  document.addEventListener('click', (e)=>{
    const a = e.target.closest('.sidebar a'); if(!a) return;
    document.querySelectorAll('.sidebar .nav a.active').forEach(el=>el.classList.remove('active'));
    a.classList.add('active'); setTimeout(()=>toggleSidebar(false),120);
  });

  // Start
  boot()
</script>
</body>
</html>
