<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mutasi Saldo | AMKO</title>
  <style>
    :root{
      --sidebar-w:240px;
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --txt:#0f172a; --ring:#93c5fd33;
      --pos:#16a34a; /* hijau */
      --neg:#dc2626; /* merah */
      --neu:#ca8a04; /* kuning */
      --blue:#0b63f3; /* nama user */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);font-size:15px;line-height:1.5}

    /* ===== Layout ===== */
    .layout{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100vh}

    /* ===== Sidebar ===== */
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px;position:relative;z-index:20}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{padding:0;display:flex;flex-direction:column;gap:6px}
    .nav a{display:flex;align-items:center;gap:10px;color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px;line-height:1.3;min-height:36px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .nav a:hover{background:rgba(255,255,255,.08)}
    .nav a.active{background:#0b3a66;color:#fff}
    .group{margin-top:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .group-hd{padding:8px 10px;background:#0f2238;color:#cfe0f3;font-size:12px;font-weight:800;display:flex;justify-content:space-between;align-items:center;letter-spacing:.2px;text-transform:uppercase}
    .group-bd{padding:8px;background:#0f253f;display:flex;flex-direction:column;gap:6px}
    .sidebar-footer{margin-top:auto;padding-top:10px;font-size:11px;color:#93a3b8}
    .logout{display:block;margin-top:8px;background:#fecdd3;color:#7f1d1d;text-align:center;border-radius:10px;padding:9px 10px;font-weight:800;text-decoration:none}

    /* ===== Header & konten ===== */
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .hdr-left{display:flex;align-items:center;gap:12px;flex:1 1 auto;min-width:300px}
    .hdr-right{display:flex;align-items:center;gap:8px}
    .current-store{font-weight:800}
    .user-badge{font-weight:800;letter-spacing:.2px;text-transform:uppercase}

    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:44px;transition:background .15s,box-shadow .15s}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-sm{height:36px;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid var(--bd);background:#fff}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:22px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:16px;margin:12px 16px}
    .kpi-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px}
    @media(min-width:560px){ .kpi-grid{grid-template-columns:repeat(3,1fr)} }
    .kpi-card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .kpi-title{font-size:12px;color:#475569}
    .kpi-value{font-size:20px;font-weight:800}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden}
    th,td{padding:10px;border:1px solid var(--bd);font-size:14px;text-align:left;vertical-align:top}
    th{background:#f8fafc;position:sticky;top:0;z-index:1;box-shadow:inset 0 -1px #e5e7eb}
    tbody tr:nth-child(odd){background:#fafafa}
    tbody tr:hover{background:#eef2ff}
    td.num,th.num{text-align:right;font-variant-numeric:tabular-nums}
    .pill{background:#f8fafc;border:1px solid var(--bd);padding:2px 8px;border-radius:999px}
    .pager{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center}
    .pager .btn-sm{border-radius:999px}
    .fab{position:fixed;right:14px;bottom:14px;width:56px;height:56px;border-radius:999px;background:#0b63f3;color:#fff;display:none;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(11,99,243,.35);z-index:15;font-size:26px;font-weight:900}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    .input:focus{box-shadow:0 0 0 4px var(--ring);border-color:#bfdbfe}

    /* ===== Filter row ===== */
    .filters{display:flex;gap:8px;align-items:end;flex-wrap:wrap;margin:8px 0 12px}
    .field{display:flex;flex-direction:column;gap:4px}
    .field label{font-size:12px;color:#475569}

    /* ===== Hamburger & Overlay ===== */
    .hamburger{font-size:22px;background:none;border:none;cursor:pointer;padding:8px;display:none}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.45);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:19}
    .overlay.show{opacity:1;pointer-events:auto}
    body.noscroll{overflow:hidden}

    /* ===== Responsive ===== */
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .sidebar{ position:fixed;left:-240px;top:0;bottom:0;width:var(--sidebar-w); transition:left .25s ease; }
      .sidebar.open{ left:0; }
      .hamburger{ display:block; }
      .fab{ display:flex; }
    }

    /* ===== Modal (dialog) ===== */
    dialog{border:none;border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.25);padding:0;max-width:640px;width:96%}
    .dlg-hd{padding:14px 16px;border-bottom:1px solid var(--bd);font-weight:800}
    .dlg-bd{padding:16px;display:grid;gap:10px}
    .dlg-ft{padding:12px 16px;border-top:1px solid var(--bd);display:flex;gap:8px;justify-content:flex-end}
    .row{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
    .w100{width:100%}
    .hidden{display:none!important}

    /* ===== Pewarnaan & badge Jenis ===== */
    .name-blue{color:var(--blue);font-weight:700}
    .time{font-variant-numeric:tabular-nums}
    .jenis-badge{display:inline-flex;align-items:center;gap:8px;font-weight:800;border-radius:999px;padding:4px 10px;border:1px solid var(--bd);background:#fff}
    .jenis-ico{font-size:14px;line-height:1}
    .jenis-tambah{color:var(--pos)}
    .jenis-kurang{color:var(--neg)}
    .jenis-pindah{color:var(--neu)}
    .jenis-operasional{color:var(--neg)}

    /* ===== Sembunyikan kolom Admin di layar kecil ===== */
    @media (max-width: 680px){
      table thead th:nth-child(8),
      table tbody td:nth-child(8){
        display:none;
      }
    }
  </style>
</head>
<body>
<div class="layout">

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Amko MiniLink</div>

    <nav class="nav" id="menuList">
      <a href="dashboard.html">📊 Dashboard</a>
      <a href="transaksi-mini-atm.html">🧮 Transaksi Mini ATM</a>

      <div class="group">
        <div class="group-hd"><span>MASTER DATA</span><span>▾</span></div>
        <div class="group-bd">
          <a href="master-saldo-akun.html">💰 Master Saldo Akun</a>
          <a class="active" href="mutasi-saldo.html">🔄 Mutasi Saldo</a>
          <a href="saldo-real.html">📑 Saldo Real</a>
        </div>
      </div>

      <div class="group">
        <div class="group-hd"><span>LAPORAN</span><span>▾</span></div>
        <div class="group-bd">
          <a href="laporan.html">📘 Laporan MiniLink</a>
        </div>
      </div>

      <div class="group">
        <div class="group-hd"><span>PENGATURAN</span><span>▾</span></div>
        <div class="group-bd">
          <a href="manajemen-pengguna.html">👥 Manajemen Pengguna</a>
          <a href="hak-akses.html">🔑 Hak Akses</a>
          <a href="absensi.html">🕒 Absensi</a>
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      © Amko MiniLink • v1
      <a href="#" id="lnk-logout" class="logout">🚪 Logout</a>
    </div>
  </aside>

  <!-- Overlay (mobile) -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- ===== Main ===== -->
  <div>
    <header>
      <div class="hdr-left">
        <button id="toggleSidebar" class="hamburger" aria-label="Toggle Sidebar" aria-controls="sidebar" aria-expanded="false">☰</button>

        <!-- Dropdown branch (owner only) -->
        <select id="branchSelect" class="input" style="display:none"></select>

        <!-- Label toko sekarang -->
        <div class="current-store">TOKO SEKARANG: <span id="currentStoreName">-</span></div>
      </div>

      <div class="hdr-right">
        <span id="userBadge" class="user-badge">MEMUAT…</span>
        <button id="btnTambah" class="btn btn-primary">+ Tambah Mutasi</button>
      </div>
    </header>

    <!-- KPI -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">KPI Mutasi</h3>

      <!-- Filter tanggal -->
      <div class="filters">
        <div class="field">
          <label for="fFrom">Dari</label>
          <input type="date" id="fFrom" class="input">
        </div>
        <div class="field">
          <label for="fTo">Sampai</label>
          <input type="date" id="fTo" class="input">
        </div>
        <button id="btnApplyFilter" class="btn-sm">Terapkan</button>
        <button id="btnResetFilter" class="btn-sm">Reset</button>
        <span class="pill" id="filterInfo">Filter: -</span>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Total Tambah</div><div id="kpiTambah" class="kpi-value">Rp 0</div></div>
        <div class="kpi-card"><div class="kpi-title">Total Kurang</div><div id="kpiKurang" class="kpi-value">Rp 0</div></div>
        <div class="kpi-card"><div class="kpi-title">Net Change</div><div id="kpiNet" class="kpi-value">Rp 0</div></div>
      </div>
    </div>

    <!-- Riwayat -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Riwayat Mutasi</h3>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>User & Tanggal</th>
            <th>Jenis</th>
            <th>Sumber</th>
            <th>Tujuan</th>
            <th class="num">Saldo Awal</th>
            <th class="num">Nominal</th>
            <th class="num">Admin</th>
            <th class="num">Saldo Akhir</th>
            <th>Keterangan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
      <div class="pager">
        <span class="pill" id="pageInfo">Filter: -</span>
      </div>
    </div>
  </div>
</div>

<button id="fabAdd" class="fab" title="Tambah">+</button>

<!-- ===== MODAL TAMBAH MUTASI ===== -->
<dialog id="modalMutasi">
  <form id="formMutasi" method="dialog">
    <div class="dlg-hd">Tambah Mutasi</div>
    <div class="dlg-bd">

      <!-- Hidden: tanggal otomatis hari ini -->
      <input id="tanggal" name="tanggal" type="date" class="hidden">

      <div class="row">
        <label for="jenis">Jenis Mutasi</label>
        <select id="jenis" name="jenis" class="input w100" required>
          <option value="TAMBAH">Tambah Saldo</option>
          <option value="KURANG">Ambil Saldo</option>
          <option value="PINDAH">Pindah Saldo</option>
          <option value="OPERASIONAL">Operasional</option>
        </select>
      </div>

      <!-- Akun tunggal (Tambah/Ambil/Operasional) -->
      <div id="rowAkunSingle" class="row">
        <label for="akun"><span id="lblAkunSingle">Akun</span></label>
        <select id="akun" name="akun" class="input w100" required></select>
        <div id="hintSingle" style="font-size:12px;color:#64748b;margin-top:4px"></div>
      </div>

      <!-- Akun sumber/tujuan (Pindah) -->
      <div id="rowAkunPindah" class="hidden">
        <div class="row">
          <label for="akunSumber"><span id="lblAkunSumber">Akun Sumber</span></label>
          <select id="akunSumber" name="akunSumber" class="input w100"></select>
          <div id="hintSumber" style="font-size:12px;color:#64748b;margin-top:4px"></div>
        </div>
        <div class="row">
          <label for="akunTujuan"><span id="lblAkunTujuan">Akun Tujuan</span></label>
          <select id="akunTujuan" name="akunTujuan" class="input w100"></select>
          <div id="hintTujuan" style="font-size:12px;color:#64748b;margin-top:4px"></div>
        </div>
      </div>

      <div class="row">
        <label for="nominal">Nominal (Rp ribuan)</label>
        <input id="nominal" name="nominal" class="input w100" placeholder="cth 1.000 / 10.000" required>
      </div>

      <div class="row hidden" id="rowAdmin">
        <label for="admin">Admin Bank (Rp)</label>
        <input id="admin" name="admin" class="input w100" placeholder="cth 2.500" value="0">
      </div>

      <div class="row">
        <label for="keterangan">Keterangan</label>
        <input id="keterangan" name="keterangan" class="input w100" placeholder="catatan (opsional)">
      </div>

      <!-- Hidden untuk branch & user -->
      <input type="hidden" id="branch_code" name="branch_code">
      <input type="hidden" id="created_by" name="created_by">
    </div>
    <div class="dlg-ft">
      <button type="button" id="btnCancel" class="btn btn-sm">Batal</button>
      <button type="submit" id="btnSaveMutasi" class="btn btn-primary">Simpan</button>
    </div>
  </form>
</dialog>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  const $ = id=>document.getElementById(id);
  let me=null, gBranch=null, branchesMap=new Map(), akunCabang=[];

  /* ===== Utils ===== */
  function parseMoney(s){
    if(s==null) return 0;
    const cleaned = String(s).replace(/\./g,'').replace(/,/g,'').trim();
    const n = Number(cleaned||0);
    return isFinite(n) ? Math.round(n) : 0;
  }
  const fmt = (n)=> 'Rp ' + (n||0).toLocaleString('id-ID');

  function getDateRange(){
    const d1 = $('fFrom')?.value || '';
    const d2 = $('fTo')?.value || '';
    return { from: d1 || null, to: d2 || null };
  }
  function setFilterInfo(){
    const {from,to} = getDateRange();
    const txt = (from||'…') + ' → ' + (to||'…');
    $('filterInfo').textContent = 'Filter: ' + txt;
    $('pageInfo').textContent = 'Filter: ' + txt;
  }
  function toLocalTimeStr(ts){
    if(!ts) return '';
    try{
      const d = new Date(ts);
      return d.toLocaleTimeString('id-ID', { hour12:false });
    }catch{ return ''; }
  }

  /* Ambil saldo saat ini dari akun */
  async function getCurrentSaldoByAccountId(accId){
    if(!accId) return 0;
    const { data: acc, error } = await supabase.from('accounts').select('*').eq('id', accId).single();
    if(error) return 0;
    const v = acc?.saldo ?? acc?.balance ?? acc?.amount ?? 0;
    return Number(v)||0;
  }

  /* ===== Boot ===== */
  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session){ location.href='login.html'; return }

    // profil
    const { data: prof } = await supabase.from('profiles')
      .select('id,full_name,email,branch_code,role')
      .eq('id', session.user.id).single();

    me = prof;
    gBranch = (prof.branch_code||'').trim();

    // Badge user
    const nm = (prof.full_name || prof.email || '').trim();
    const firstName = nm ? nm.split(' ')[0] : '';
    const roleRaw = (prof.role||'').trim();
    $('userBadge').textContent = `${firstName}-${roleRaw}`.toUpperCase();

    // branches
    const { data: branches } = await supabase.from('branches').select('code,name').order('name');
    (branches||[]).forEach(b=>branchesMap.set(b.code, b.name));
    const isOwner = roleRaw.toLowerCase()==='owner';

    if(isOwner){
      $('branchSelect').style.display='inline-block';
      $('branchSelect').innerHTML = (branches && branches.length)
        ? branches.map(b=>`<option value="${b.code}">${b.name}</option>`).join('')
        : '<option value="">-- Pilih Toko --</option>';
      $('branchSelect').value = gBranch || (branches?.[0]?.code || '');
      gBranch = $('branchSelect').value;
      $('branchSelect').onchange = async ()=>{
        gBranch = $('branchSelect').value;
        updateCurrentStoreName();
        $('branch_code').value = gBranch;   // ikut cabang
        await loadAkunCabang();
        await refreshAll();                 // ← riwayat & KPI ikut cabang
      };
    }else{
      $('branchSelect').style.display='none';
    }
    updateCurrentStoreName();

    // Default filter = bulan berjalan
    const today = new Date();
    const first = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0,10);
    const tday = today.toISOString().slice(0,10);
    $('fFrom').value = first;
    $('fTo').value = tday;
    setFilterInfo();

    // tombol filter
    $('btnApplyFilter').addEventListener('click', async ()=>{
      const { from, to } = getDateRange();
      if (from && to && from > to) { alert('Tanggal Dari tidak boleh lebih besar dari Sampai'); return; }
      setFilterInfo();
      await refreshAll();
    });
    $('btnResetFilter').addEventListener('click', async ()=>{
      $('fFrom').value = first;
      $('fTo').value = tday;
      setFilterInfo();
      await refreshAll();
    });

    // tombol tambah & fab
    document.getElementById('btnTambah')?.addEventListener('click', openFormAdd);
    document.getElementById('fabAdd')?.addEventListener('click', openFormAdd);

    // modal events
    $('btnCancel').addEventListener('click', closeFormAdd);
    $('formMutasi').addEventListener('submit', onSaveMutasi);
    $('jenis').addEventListener('change', refreshJenisUI);

    initSidebarToggler();

    await loadAkunCabang();   // isi dropdown akun sesuai cabang
    await refreshAll();       // KPI + Riwayat pertama kali
  }

  function updateCurrentStoreName(){
    const name = branchesMap.get(gBranch) || gBranch || '-';
    $('currentStoreName').textContent = name;
  }

  /* ====== Ambil daftar akun untuk cabang aktif ====== */
  async function loadAkunCabang(){
    const { data } = await supabase
      .from('accounts')
      .select('id,name,branch_code')
      .eq('branch_code', gBranch)
      .order('name');

    akunCabang = data || [];
    const opts = akunCabang.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    $('akun').innerHTML = opts || '<option value="">(Belum ada akun)</option>';
    $('akunSumber').innerHTML = opts || '<option value="">(Belum ada akun)</option>';
    $('akunTujuan').innerHTML = opts || '<option value="">(Belum ada akun)</option>';
  }

  /* ====== UI Jenis Mutasi (DINAMIS LABEL + HINT) ====== */
  function refreshJenisUI(){
    const up = String($('jenis').value).toUpperCase();
    const isPindah = (up === 'PINDAH');

    $('rowAkunSingle').classList.toggle('hidden', isPindah);
    $('rowAkunPindah').classList.toggle('hidden', !isPindah);
    $('rowAdmin').classList.toggle('hidden', !isPindah);

    $('akun').required = !isPindah;
    $('akunSumber').required = isPindah;
    $('akunTujuan').required = isPindah;

    const lblSingle = $('lblAkunSingle');
    const lblSumber = $('lblAkunSumber');
    const lblTujuan = $('lblAkunTujuan');
    const hintSingle = $('hintSingle');
    const hintSumber = $('hintSumber');
    const hintTujuan = $('hintTujuan');

    if (isPindah){
      lblSumber.textContent = 'Sumber (diambil dari)';
      lblTujuan.textContent = 'Tujuan (ditambahkan ke)';
      hintSumber.textContent = 'Uang DIAMBIL dari akun ini. Contoh: Laci Tunai, Rekening BRI.';
      hintTujuan.textContent = 'Uang DITAMBAHKAN ke akun ini (tujuan pindah).';
      hintSingle.textContent = '';
    } else if (up === 'TAMBAH'){
      lblSingle.textContent = 'Masuk ke Akun';
      hintSingle.textContent = 'Uang MASUK ke akun ini. Contoh: Laci Tunai, Rekening BRI.';
      hintSumber.textContent = hintTujuan.textContent = '';
    } else if (up === 'KURANG'){
      lblSingle.textContent = 'Keluar dari Akun';
      hintSingle.textContent = 'Uang KELUAR dari akun ini. Contoh: Ambil dari Laci Tunai.';
      hintSumber.textContent = hintTujuan.textContent = '';
    } else {
      lblSingle.textContent = 'Keluar dari Akun (Operasional)';
      hintSingle.textContent = 'Biaya operasional memakai dana dari akun ini.';
      hintSumber.textContent = hintTujuan.textContent = '';
    }
  }

  /* ====== BUKA/TUTUP FORM ====== */
  function openFormAdd(){
    const today = new Date().toISOString().slice(0,10);
    $('tanggal').value = today;
    $('branch_code').value = gBranch || '';
    $('created_by').value = me?.id || '';

    $('jenis').value = 'TAMBAH';
    $('nominal').value = '';
    $('admin').value = '0';
    $('keterangan').value = '';

    refreshJenisUI();
    const dlg=$('modalMutasi'); if(dlg?.dataset?.editId) delete dlg.dataset.editId;
    dlg.showModal();
  }
  function closeFormAdd(){
    const dlg = $('modalMutasi');
    if(dlg.open) dlg.close();
  }

  /* ====== SIMPAN ====== */
  async function onSaveMutasi(ev){
    ev.preventDefault();

    const jenis = $('jenis').value.toLowerCase();
    const nominal = parseMoney($('nominal').value);
    const admin = parseMoney($('admin').value || '0');
    if(nominal <= 0){ alert('Nominal harus > 0'); return; }

    const mapIdToName = id => (akunCabang.find(a=>String(a.id)===String(id))?.name || null);

    let payload = {
      tanggal: $('tanggal').value,
      jenis,
      nominal,
      admin: (jenis==='pindah' ? admin : 0),
      keterangan: $('keterangan').value || null,
      branch_code: $('branch_code').value || gBranch,
      created_by: $('created_by').value || (me?.id||null),

      // tampilkan nama pembuat di tabel
      created_by_name: (me?.full_name || me?.email || null),

      sumber_id: null, sumber_name: null,
      tujuan_id: null, tujuan_name: null,
      akun_id: null,   akun_name: null
    };

    let saldo_awal = 0, saldo_akhir = 0;

    if(jenis==='pindah'){
      const src = $('akunSumber').value, dst = $('akunTujuan').value;
      if(!src || !dst){ alert('Pilih akun sumber & tujuan'); return; }
      if(src===dst){ alert('Akun sumber & tujuan tidak boleh sama'); return; }
      payload.sumber_id = src; payload.sumber_name = mapIdToName(src);
      payload.tujuan_id = dst; payload.tujuan_name = mapIdToName(dst);

      // Saldo awal/akhir ditampilkan untuk SUMBER (uang berkurang)
      saldo_awal = await getCurrentSaldoByAccountId(src);
      saldo_akhir = saldo_awal - nominal - 0; // admin pindah dihitung terpisah jika perlu
    }else{
      const ak = $('akun').value;
      if(!ak){ alert('Pilih akun'); return; }
      payload.akun_id = ak; payload.akun_name = mapIdToName(ak);

      saldo_awal = await getCurrentSaldoByAccountId(ak);
      if (jenis==='tambah') saldo_akhir = saldo_awal + nominal;
      else /* kurang/operasional */ saldo_akhir = saldo_awal - nominal;
    }

    try{
      const rowWithSaldo = { ...payload, saldo_awal, saldo_akhir };

      const { error } = await supabase.from('mutasi_saldo').insert(rowWithSaldo);
      if(error){
        // Jika kolom saldo_awal/akhir belum ada di DB, ulangi tanpa kolom tambahan
        const { error: err2 } = await supabase.from('mutasi_saldo').insert(payload);
        if(err2) throw err2;
      }

      closeFormAdd();
      await refreshAll();
    }catch(err){
      alert('Gagal menyimpan mutasi: ' + (err?.message||err));
    }
  }

  /* ===== Sidebar ===== */
  function initSidebarToggler(){
    const sidebarEl = document.getElementById('sidebar');
    const overlayEl = document.getElementById('overlay');
    const btnHamb = document.getElementById('toggleSidebar');

    function toggleSidebar(open){
      const willOpen = (typeof open==='boolean') ? open : !sidebarEl.classList.contains('open');
      sidebarEl.classList.toggle('open', willOpen);
      overlayEl.classList.toggle('show', willOpen);
      document.body.classList.toggle('noscroll', willOpen);
      if(btnHamb) btnHamb.setAttribute('aria-expanded', String(willOpen));
    }
    btnHamb?.addEventListener('click', ()=> toggleSidebar());
    overlayEl?.addEventListener('click', ()=> toggleSidebar(false));
    window.addEventListener('keyup', (e)=>{ if(e.key==='Escape') toggleSidebar(false); });
    document.querySelectorAll('.sidebar .nav a').forEach(a=>{
      a.addEventListener('click', ()=> toggleSidebar(false));
    });
  }

  /* ====== KPI (menghormati filter tanggal & cabang) ====== */
  async function loadKPI(){
    const { from, to } = getDateRange();

    // Ambil baris sesuai cabang + tanggal, dari VIEW (fallback ke tabel)
    const q1 = supabase.from('v_mutasi_summary').select('jenis, nominal').eq('branch_code', gBranch);
    if (from) q1.gte('tanggal', from);
    if (to)   q1.lte('tanggal', to);
    let { data, error } = await q1;

    if (error){ // fallback ke tabel
      const q2 = supabase.from('mutasi_saldo').select('jenis, nominal').eq('branch_code', gBranch);
      if (from) q2.gte('tanggal', from);
      if (to)   q2.lte('tanggal', to);
      ({ data, error } = await q2);
      if (error){ console.warn('KPI error', error); return; }
    }

    // Hitung KPI (pindah diabaikan)
    let totalTambah = 0, totalKurang = 0;
    (data||[]).forEach(r=>{
      const j = String(r.jenis||'').toLowerCase();
      const n = Number(r.nominal||0);
      if (j === 'tambah') totalTambah += n;
      else if (j === 'kurang' || j === 'operasional') totalKurang += n;
    });

    $('kpiTambah').textContent = fmt(totalTambah);
    $('kpiKurang').textContent = fmt(totalKurang);
    $('kpiNet').textContent    = fmt(totalTambah - totalKurang);
  }

  /* ====== Riwayat (VIEW + fallback) ====== */
  async function loadRiwayat(){
    const { from, to } = getDateRange();

    try{
      let qb = supabase.from('v_mutasi_summary').select('*').eq('branch_code', gBranch)
        .order('created_at', { ascending:false }).limit(200);
      if (from) qb = qb.gte('tanggal', from);
      if (to)   qb = qb.lte('tanggal', to);
      let { data, error } = await qb;

      if(error){
        qb = supabase.from('mutasi_saldo').select('*').eq('branch_code', gBranch)
          .order('created_at', { ascending:false }).limit(200);
        if (from) qb = qb.gte('tanggal', from);
        if (to)   qb = qb.lte('tanggal', to);
        ({ data, error } = await qb);
      }
      if(error){ console.warn('Riwayat error', error); return; }

      const tb = document.getElementById('tb');
      if(!tb) return;

      tb.innerHTML = (data||[]).map((r, i)=>{
        const jenis = String(r.jenis||'').toLowerCase();

        // LOGIKA SUMBER/TUJUAN SESUAI KEBUTUHAN
        const sumberNama = (jenis === 'pindah') ? (r.sumber_name || '-') : (r.akun_name || '-');
        const sumberId   = (jenis === 'pindah') ? (r.sumber_id || '')   : (r.akun_id || '');
        const tujuanNama = (jenis === 'pindah') ? (r.tujuan_name || '-') : '-';
        const tujuanId   = (jenis === 'pindah') ? (r.tujuan_id || '')    : '';

        // Pewarnaan & ikon jenis
        const jenisClass = jenis==='tambah' ? 'jenis-tambah'
                         : (jenis==='kurang' || jenis==='operasional') ? 'jenis-kurang'
                         : jenis==='pindah' ? 'jenis-pindah'
                         : '';
        const jenisIcon = jenis==='tambah' ? '⬆️'
                         : (jenis==='kurang' || jenis==='operasional') ? '⬇️'
                         : jenis==='pindah' ? '↔️'
                         : '';

        // Nama biru + tanggal normal + waktu dari created_at
        const creatorName = (r.created_by_name || r.created_by || '');
        const creatorId   = (r.created_by || '');
        const tgl = (r.tanggal || (r.created_at ? String(r.created_at).slice(0,10) : ''));
        const jam = toLocalTimeStr(r.created_at);

        // Saldo awal/akhir jika ada; jika tidak ada tampil '-'
        const sa = (r.saldo_awal!=null) ? fmt(Number(r.saldo_awal)) : '-';
        const sk = (r.saldo_akhir!=null) ? fmt(Number(r.saldo_akhir)) : '-';

        return `
          <tr>
            <td>${i+1}</td>
            <td>
              <span class="name-blue" title="User ID: ${creatorId}">${creatorName}</span><br>
              <span>${tgl}</span>${jam ? `<br><span class="time">${jam}</span>` : ''}
            </td>
            <td>
              <span class="jenis-badge ${jenisClass}" title="${(r.jenis||'').toString().toUpperCase()}">
                <span class="jenis-ico">${jenisIcon}</span>
                <span>${(r.jenis||'').toString().toUpperCase()}</span>
              </span>
            </td>
            <td title="${sumberId ? 'Sumber/Akun ID: ' + sumberId : ''}">${sumberNama}</td>
            <td title="${tujuanId ? 'Tujuan ID: ' + tujuanId : ''}">${tujuanNama}</td>
            <td class="num">${sa}</td>
            <td class="num">${fmt(r.nominal||0)}</td>
            <td class="num">${fmt(r.admin||0)}</td>
            <td class="num">${sk}</td>
            <td>${r.keterangan||''}</td>
            <td>
              <button class="btn-sm" onclick="editMutasi('${r.id}')">Edit</button>
              <button class="btn-sm" onclick="deleteMutasi('${r.id}')">Hapus</button>
            </td>
          </tr>`;
      }).join('');
    }catch(e){ console.warn(e); }
  }

  async function refreshAll(){
    await loadKPI();
    await loadRiwayat();
  }

  /* ===== Aksi tabel ===== */
  window.deleteMutasi = async function(id){
    if(!confirm('Hapus mutasi ini?')) return;
    const { error } = await supabase.from('mutasi_saldo').delete().eq('id', id);
    if(error){ alert('Gagal hapus: '+error.message); return; }
    await refreshAll();
  }

  window.editMutasi = async function(id){
    const { data, error } = await supabase.from('mutasi_saldo').select('*').eq('id', id).single();
    if(error){ alert('Gagal ambil data'); return; }
    const r = data;
    const j = String(r.jenis||'').toUpperCase();
    const elJenis = document.getElementById('jenis');
    if(elJenis){ elJenis.value = j; elJenis.dispatchEvent(new Event('change')); }

    if(r.akun_id) document.getElementById('akun').value = r.akun_id;
    if(r.sumber_id) document.getElementById('akunSumber').value = r.sumber_id;
    if(r.tujuan_id) document.getElementById('akunTujuan').value = r.tujuan_id;
    document.getElementById('admin').value = (r.admin||0);
    document.getElementById('nominal').value = (r.nominal||0).toLocaleString('id-ID');
    document.getElementById('keterangan').value = r.keterangan||'';

    const dlg = document.getElementById('modalMutasi');
    dlg.dataset.editId = id;
    dlg.showModal();
  }

  /* ===== Logout ===== */
  document.getElementById('lnk-logout').addEventListener('click', async (e)=>{
    e.preventDefault();
    await supabase.auth.signOut();
    location.href='login.html';
  });

  /* ===== Start ===== */
  boot();
</script>
</body>
</html>
