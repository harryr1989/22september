<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mutasi Saldo | AMKO</title>
  <style>
    :root{
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --txt:#0f172a; --ring:#93c5fd33;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);font-size:15px;line-height:1.5}
    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px}
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--pri);color:#fff}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:44px;transition:background .15s,box-shadow .15s}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-sm{height:36px;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid var(--bd);background:#fff}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:22px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:16px;margin:12px 16px}
    .kpi-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px}
    @media(min-width:560px){ .kpi-grid{grid-template-columns:repeat(3,1fr)} }
    .kpi-card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .kpi-title{font-size:12px;color:#475569}
    .kpi-value{font-size:20px;font-weight:800}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden}
    th,td{padding:10px;border:1px solid var(--bd);font-size:14px;text-align:left;vertical-align:top}
    th{background:#f8fafc;position:sticky;top:0;z-index:1;box-shadow:inset 0 -1px #e5e7eb}
    tbody tr:nth-child(odd){background:#fafafa}
    tbody tr:hover{background:#eef2ff}
    td.num,th.num{text-align:right;font-variant-numeric:tabular-nums}
    .pill{background:#f8fafc;border:1px solid var(--bd);padding:2px 8px;border-radius:999px}
    .pager{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center}
    .pager .btn-sm{border-radius:999px}
    .fab{position:fixed;right:14px;bottom:14px;width:56px;height:56px;border-radius:999px;background:#0b63f3;color:#fff;display:none;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(11,99,243,.35);z-index:15;font-size:26px;font-weight:900}
    @media(max-width:900px){.layout{grid-template-columns:1fr}.sidebar{position:sticky;top:0}.fab{display:flex}}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    .input:focus{box-shadow:0 0 0 4px var(--ring);border-color:#bfdbfe}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:13px;color:#475569}
    .modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(2,6,23,.45);z-index:50}
    .dialog{width:min(620px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:92vh}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px;overflow:auto}
    .dlg-ft{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--bd);padding:12px 16px;display:flex;gap:8px;justify-content:flex-end}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b}
    .msgerr{display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px}
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="brand">AMKO</div>
    <nav class="nav">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="master-saldo-akun.html">üí≥ Master Akun</a>
      <a href="transaksi-mini-atm.html">üèß Mini ATM</a>
      <a class="active" href="mutasi-saldo.html">üîÑ Mutasi Saldo</a>
      <a href="#" id="lnk-logout">üö™ Logout</a>
    </nav>
  </aside>

  <div>
    <header>
      <h2 style="margin:0">Mutasi Saldo</h2>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="pill" id="me">memuat‚Ä¶</span>
        <span class="pill" id="branchBadge">branch: -</span>
        <select id="branchSelect" class="input" style="display:none"></select>
        <button id="btnTambah" class="btn btn-primary">+ Tambah Mutasi</button>
      </div>
    </header>

    <!-- KPI -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">KPI Mutasi</h3>
      <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Total Tambah</div><div id="kpiTambah" class="kpi-value">Rp 0</div></div>
        <div class="kpi-card"><div class="kpi-title">Total Kurang</div><div id="kpiKurang" class="kpi-value">Rp 0</div></div>
        <div class="kpi-card"><div class="kpi-title">Net Change</div><div id="kpiNet" class="kpi-value">Rp 0</div></div>
      </div>
    </div>

    <!-- Riwayat -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Riwayat Mutasi</h3>
      <div id="totalRow" style="margin-bottom:6px;font-weight:600">Total = 0</div>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>User & Tanggal</th>
            <th>Jenis</th>
            <th>Sumber</th>
            <th>Tujuan</th>
            <th class="num">Nominal</th>
            <th class="num">Admin</th>
            <th>Keterangan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
      <div class="pager">
        <button class="btn-sm" id="btnPrev">‚ü® Prev</button>
        <span class="pill" id="pageInfo">Hal 1</span>
        <button class="btn-sm" id="btnNext">Next ‚ü©</button>
      </div>
    </div>
  </div>
</div>

<button id="fabAdd" class="fab" title="Tambah">+</button>

<!-- MODAL FORM (sama persis sebelumnya, tidak dipotong di sini demi singkat) -->
<!-- ... isi form tambah mutasi ... -->

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

const $ = id=>document.getElementById(id)
let me=null, gBranch=null

async function boot(){
  const { data:{ session } } = await supabase.auth.getSession()
  if(!session){ location.href='login.html'; return }
  const { data: prof } = await supabase.from('profiles').select('id,full_name,email,branch_code,role').eq('id', session.user.id).single()
  me = prof; gBranch = (prof.branch_code||'').trim()
  $('me').textContent = prof.full_name || prof.email

  if(prof.role==='owner'){
    $('branchSelect').style.display='inline-block'
    $('branchBadge').style.display='none'
    const { data: branches } = await supabase.from('branches').select('code,name').order('name')
    $('branchSelect').innerHTML = (branches||[]).map(b=>`<option value="${b.code}">${b.name}</option>`).join('')
    $('branchSelect').value = gBranch || (branches?.[0]?.code || '')
    gBranch = $('branchSelect').value
    $('branchSelect').onchange = async ()=>{ gBranch=$('branchSelect').value; await loadKPI(); await loadRiwayat() }
  }else{
    $('branchBadge').textContent = 'branch: ' + (gBranch||'-')
  }

  await loadKPI()
  await loadRiwayat()
}
boot()
</script>
</body>
</html>
