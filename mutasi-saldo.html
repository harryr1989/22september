<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mutasi Saldo | AMKO</title>
  <style>
    :root{
      --sidebar-w:240px;
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --txt:#0f172a; --ring:#93c5fd33;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);font-size:15px;line-height:1.5}

    /* ===== Layout ===== */
    .layout{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100vh}

    /* ===== Sidebar (match dashboard/master) ===== */
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px;position:relative;z-index:20}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{padding:0;display:flex;flex-direction:column;gap:6px}
    .nav a{display:flex;align-items:center;gap:10px;color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px;line-height:1.3;min-height:36px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .nav a:hover{background:rgba(255,255,255,.08)}
    .nav a.active{background:#0b3a66;color:#fff}
    .group{margin-top:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .group-hd{padding:8px 10px;background:#0f2238;color:#cfe0f3;font-size:12px;font-weight:800;display:flex;justify-content:space-between;align-items:center;letter-spacing:.2px;text-transform:uppercase}
    .group-bd{padding:8px;background:#0f253f;display:flex;flex-direction:column;gap:6px}
    .sidebar-footer{margin-top:auto;padding-top:10px;font-size:11px;color:#93a3b8}
    .logout{display:block;margin-top:8px;background:#fecdd3;color:#7f1d1d;text-align:center;border-radius:10px;padding:9px 10px;font-weight:800;text-decoration:none}

    /* ===== Header & konten (ori) ===== */
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:44px;transition:background .15s,box-shadow .15s}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-sm{height:36px;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid var(--bd);background:#fff}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:22px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:16px;margin:12px 16px}
    .kpi-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px}
    @media(min-width:560px){ .kpi-grid{grid-template-columns:repeat(3,1fr)} }
    .kpi-card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .kpi-title{font-size:12px;color:#475569}
    .kpi-value{font-size:20px;font-weight:800}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden}
    th,td{padding:10px;border:1px solid var(--bd);font-size:14px;text-align:left;vertical-align:top}
    th{background:#f8fafc;position:sticky;top:0;z-index:1;box-shadow:inset 0 -1px #e5e7eb}
    tbody tr:nth-child(odd){background:#fafafa}
    tbody tr:hover{background:#eef2ff}
    td.num,th.num{text-align:right;font-variant-numeric:tabular-nums}
    .pill{background:#f8fafc;border:1px solid var(--bd);padding:2px 8px;border-radius:999px}
    .pager{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center}
    .pager .btn-sm{border-radius:999px}
    .fab{position:fixed;right:14px;bottom:14px;width:56px;height:56px;border-radius:999px;background:#0b63f3;color:#fff;display:none;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(11,99,243,.35);z-index:15;font-size:26px;font-weight:900}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    .input:focus{box-shadow:0 0 0 4px var(--ring);border-color:#bfdbfe}

    /* ===== Hamburger & Overlay ===== */
    .hamburger{font-size:22px;background:none;border:none;cursor:pointer;padding:8px;display:none}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.45);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:19}
    .overlay.show{opacity:1;pointer-events:auto}
    body.noscroll{overflow:hidden}

    /* ===== Responsive: mobile like dashboard ===== */
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .sidebar{
        position:fixed;left:-240px;top:0;bottom:0;width:var(--sidebar-w);
        transition:left .25s ease; /* off-canvas */
      }
      .sidebar.open{ left:0; }
      .hamburger{ display:block; }          /* tombol muncul di HP */
      .fab{ display:flex; }                 /* seperti versi sebelumnya (jika perlu) */
    }
  </style>
</head>
<body>
<div class="layout">

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Amko MiniLink</div>

    <nav class="nav" id="menuList">
      <!-- Menu utama -->
      <a href="dashboard.html">ðŸ“Š Dashboard</a>
      <a href="transaksi-mini-atm.html">ðŸ§® Transaksi Mini ATM</a>

      <!-- Grup MASTER DATA -->
      <div class="group">
        <div class="group-hd"><span>MASTER DATA</span><span>â–¾</span></div>
        <div class="group-bd">
          <a href="master-saldo-akun.html">ðŸ’° Master Saldo Akun</a>
          <a class="active" href="mutasi-saldo.html">ðŸ”„ Mutasi Saldo</a>
          <a href="saldo-real.html">ðŸ“‘ Saldo Real</a>
        </div>
      </div>

      <!-- Grup LAPORAN -->
      <div class="group">
        <div class="group-hd"><span>LAPORAN</span><span>â–¾</span></div>
        <div class="group-bd">
          <a href="laporan.html">ðŸ“˜ Laporan MiniLink</a>
        </div>
      </div>

      <!-- Grup PENGATURAN -->
      <div class="group">
        <div class="group-hd"><span>PENGATURAN</span><span>â–¾</span></div>
        <div class="group-bd">
          <a href="manajemen-pengguna.html">ðŸ‘¥ Manajemen Pengguna</a>
          <a href="hak-akses.html">ðŸ”‘ Hak Akses</a>
          <a href="absensi.html">ðŸ•’ Absensi</a>
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      Â© Amko MiniLink â€¢ v1
      <a href="#" id="lnk-logout" class="logout">ðŸšª Logout</a>
    </div>
  </aside>

  <!-- Overlay (mobile) -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- ===== Main (logika asli tidak diubah) ===== -->
  <div>
    <header>
      <!-- Hamburger muncul hanya di mobile -->
      <button id="toggleSidebar" class="hamburger" aria-label="Toggle Sidebar" aria-controls="sidebar" aria-expanded="false">â˜°</button>
      <h2 style="margin:0">Mutasi Saldo</h2>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="pill" id="me">memuatâ€¦</span>
        <span class="pill" id="branchBadge">branch: -</span>
        <select id="branchSelect" class="input" style="display:none"></select>
        <button id="btnTambah" class="btn btn-primary">+ Tambah Mutasi</button>
      </div>
    </header>

    <!-- KPI -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">KPI Mutasi</h3>
      <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Total Tambah</div><div id="kpiTambah" class="kpi-value">Rp 0</div></div>
        <div class="kpi-card"><div class="kpi-title">Total Kurang</div><div id="kpiKurang" class="kpi-value">Rp 0</div></div>
        <div class="kpi-card"><div class="kpi-title">Net Change</div><div id="kpiNet" class="kpi-value">Rp 0</div></div>
      </div>
    </div>

    <!-- Riwayat -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Riwayat Mutasi</h3>
      <div id="totalRow" style="margin-bottom:6px;font-weight:600">Total = 0</div>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>User & Tanggal</th>
            <th>Jenis</th>
            <th>Sumber</th>
            <th>Tujuan</th>
            <th class="num">Nominal</th>
            <th class="num">Admin</th>
            <th>Keterangan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
      <div class="pager">
        <button class="btn-sm" id="btnPrev">âŸ¨ Prev</button>
        <span class="pill" id="pageInfo">Hal 1</span>
        <button class="btn-sm" id="btnNext">Next âŸ©</button>
      </div>
    </div>
  </div>
</div>

<button id="fabAdd" class="fab" title="Tambah">+</button>

<!-- MODAL FORM (tetap seperti file aslimu; isi form tidak diubah) -->
<!-- â€¦ -->

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  const $ = id=>document.getElementById(id)
  let me=null, gBranch=null

  /* ======== LOGIKA ASLI (tidak diubah) ======== */
  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }
    const { data: prof } = await supabase.from('profiles').select('id,full_name,email,branch_code,role').eq('id', session.user.id).single()
    me = prof; gBranch = (prof.branch_code||'').trim()
    $('me').textContent = prof.full_name || prof.email

    if(prof.role==='owner'){
      $('branchSelect').style.display='inline-block'
      $('branchBadge').style.display='none'
      const { data: branches } = await supabase.from('branches').select('code,name').order('name')
      $('branchSelect').innerHTML = (branches||[]).map(b=>`<option value="${b.code}">${b.name}</option>`).join('')
      $('branchSelect').value = gBranch || (branches?.[0]?.code || '')
      gBranch = $('branchSelect').value
      $('branchSelect').onchange = async ()=>{ gBranch=$('branchSelect').value; await loadKPI(); await loadRiwayat() }
    }else{
      $('branchBadge').textContent = 'branch: ' + (gBranch||'-')
    }

    await loadKPI()
    await loadRiwayat()
  }
  boot()

  // ======== Sidebar + Overlay (mobile) ========
  const sidebarEl = document.getElementById('sidebar');
  const overlayEl = document.getElementById('overlay');
  const btnHamb = document.getElementById('toggleSidebar');

  function toggleSidebar(open){
    const willOpen = (typeof open==='boolean') ? open : !sidebarEl.classList.contains('open');
    sidebarEl.classList.toggle('open', willOpen);
    overlayEl.classList.toggle('show', willOpen);
    document.body.classList.toggle('noscroll', willOpen);
    if(btnHamb) btnHamb.setAttribute('aria-expanded', String(willOpen));
  }
  btnHamb?.addEventListener('click', ()=> toggleSidebar());
  overlayEl?.addEventListener('click', ()=> toggleSidebar(false));
  window.addEventListener('keyup', (e)=>{ if(e.key==='Escape') toggleSidebar(false); });
  document.querySelectorAll('.sidebar .nav a').forEach(a=>{
    a.addEventListener('click', ()=> toggleSidebar(false));
  });

  // ======== Logout (asli) ========
  document.getElementById('lnk-logout').addEventListener('click', async (e)=>{
    e.preventDefault();
    await supabase.auth.signOut();
    location.href='login.html';
  });
</script>
</body>
</html>
