<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mutasi Saldo | AMKO</title>
  <style>
    :root{
      --sidebar-w:240px;
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --txt:#0f172a; --ring:#93c5fd33;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);font-size:15px;line-height:1.5}

    /* ===== Layout ===== */
    .layout{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100vh}

    /* ===== Sidebar ===== */
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px;position:relative;z-index:20}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{padding:0;display:flex;flex-direction:column;gap:6px}
    .nav a{display:flex;align-items:center;gap:10px;color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px;line-height:1.3;min-height:36px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .nav a:hover{background:rgba(255,255,255,.08)}
    .nav a.active{background:#0b3a66;color:#fff}
    .group{margin-top:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .group-hd{padding:8px 10px;background:#0f2238;color:#cfe0f3;font-size:12px;font-weight:800;display:flex;justify-content:space-between;align-items:center;letter-spacing:.2px;text-transform:uppercase}
    .group-bd{padding:8px;background:#0f253f;display:flex;flex-direction:column;gap:6px}
    .sidebar-footer{margin-top:auto;padding-top:10px;font-size:11px;color:#93a3b8}
    .logout{display:block;margin-top:8px;background:#fecdd3;color:#7f1d1d;text-align:center;border-radius:10px;padding:9px 10px;font-weight:800;text-decoration:none}

    /* ===== Header & konten ===== */
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .hdr-left{display:flex;align-items:center;gap:12px;flex:1 1 auto;min-width:300px}
    .hdr-right{display:flex;align-items:center;gap:8px}
    .current-store{font-weight:800}
    .user-badge{font-weight:800;letter-spacing:.2px;text-transform:uppercase}

    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:44px;transition:background .15s,box-shadow .15s}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-sm{height:36px;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid var(--bd);background:#fff}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:22px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:16px;margin:12px 16px}
    .kpi-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px}
    @media(min-width:560px){ .kpi-grid{grid-template-columns:repeat(3,1fr)} }
    .kpi-card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .kpi-title{font-size:12px;color:#475569}
    .kpi-value{font-size:20px;font-weight:800}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden}
    th,td{padding:10px;border:1px solid var(--bd);font-size:14px;text-align:left;vertical-align:top}
    th{background:#f8fafc;position:sticky;top:0;z-index:1;box-shadow:inset 0 -1px #e5e7eb}
    tbody tr:nth-child(odd){background:#fafafa}
    tbody tr:hover{background:#eef2ff}
    td.num,th.num{text-align:right;font-variant-numeric:tabular-nums}
    .pill{background:#f8fafc;border:1px solid var(--bd);padding:2px 8px;border-radius:999px}
    .pager{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center}
    .pager .btn-sm{border-radius:999px}
    .fab{position:fixed;right:14px;bottom:14px;width:56px;height:56px;border-radius:999px;background:#0b63f3;color:#fff;display:none;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(11,99,243,.35);z-index:15;font-size:26px;font-weight:900}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    .input:focus{box-shadow:0 0 0 4px var(--ring);border-color:#bfdbfe}

    /* ===== Hamburger & Overlay ===== */
    .hamburger{font-size:22px;background:none;border:none;cursor:pointer;padding:8px;display:none}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.45);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:19}
    .overlay.show{opacity:1;pointer-events:auto}
    body.noscroll{overflow:hidden}

    /* ===== Responsive ===== */
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .sidebar{
        position:fixed;left:-240px;top:0;bottom:0;width:var(--sidebar-w);
        transition:left .25s ease;
      }
      .sidebar.open{ left:0; }
      .hamburger{ display:block; }
      .fab{ display:flex; }
    }

    /* ===== Modal (dialog) ===== */
    dialog{border:none;border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.25);padding:0;max-width:640px;width:96%}
    .dlg-hd{padding:14px 16px;border-bottom:1px solid var(--bd);font-weight:800}
    .dlg-bd{padding:16px;display:grid;gap:10px}
    .dlg-ft{padding:12px 16px;border-top:1px solid var(--bd);display:flex;gap:8px;justify-content:flex-end}
    .row{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
    .w100{width:100%}
    .hidden{display:none!important}
  </style>
</head>
<body>
<div class="layout">

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Amko MiniLink</div>

    <nav class="nav" id="menuList">
      <a href="dashboard.html">ðŸ“Š Dashboard</a>
      <a href="transaksi-mini-atm.html">ðŸ§® Transaksi Mini ATM</a>

      <div class="group">
        <div class="group-hd"><span>MASTER DATA</span><span>â–¾</span></div>
        <div class="group-bd">
          <a href="master-saldo-akun.html">ðŸ’° Master Saldo Akun</a>
          <a class="active" href="mutasi-saldo.html">ðŸ”„ Mutasi Saldo</a>
          <a href="saldo-real.html">ðŸ“‘ Saldo Real</a>
        </div>
      </div>

      <div class="group">
        <div class="group-hd"><span>LAPORAN</span><span>â–¾</span></div>
        <div class="group-bd">
          <a href="laporan.html">ðŸ“˜ Laporan MiniLink</a>
        </div>
      </div>

      <div class="group">
        <div class="group-hd"><span>PENGATURAN</span><span>â–¾</span></div>
        <div class="group-bd">
          <a href="manajemen-pengguna.html">ðŸ‘¥ Manajemen Pengguna</a>
          <a href="hak-akses.html">ðŸ”‘ Hak Akses</a>
          <a href="absensi.html">ðŸ•’ Absensi</a>
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      Â© Amko MiniLink â€¢ v1
      <a href="#" id="lnk-logout" class="logout">ðŸšª Logout</a>
    </div>
  </aside>

  <!-- Overlay (mobile) -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- ===== Main ===== -->
  <div>
    <header>
      <div class="hdr-left">
        <button id="toggleSidebar" class="hamburger" aria-label="Toggle Sidebar" aria-controls="sidebar" aria-expanded="false">â˜°</button>

        <!-- Dropdown branch (owner only) -->
        <select id="branchSelect" class="input" style="display:none"></select>

        <!-- Label toko sekarang -->
        <div class="current-store">TOKO SEKARANG: <span id="currentStoreName">-</span></div>
      </div>

      <div class="hdr-right">
        <span id="userBadge" class="user-badge">MEMUATâ€¦</span>
        <button id="btnTambah" class="btn btn-primary">+ Tambah Mutasi</button>
      </div>
    </header>

    <!-- KPI -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">KPI Mutasi</h3>
      <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Total Tambah</div><div id="kpiTambah" class="kpi-value">Rp 0</div></div>
        <div class="kpi-card"><div class="kpi-title">Total Kurang</div><div id="kpiKurang" class="kpi-value">Rp 0</div></div>
        <div class="kpi-card"><div class="kpi-title">Net Change</div><div id="kpiNet" class="kpi-value">Rp 0</div></div>
      </div>
    </div>

    <!-- Riwayat -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Riwayat Mutasi</h3>
      <div id="totalRow" style="margin-bottom:6px;font-weight:600">Total = 0</div>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>User & Tanggal</th>
            <th>Jenis</th>
            <th>Sumber</th>
            <th>Tujuan</th>
            <th class="num">Nominal</th>
            <th class="num">Admin</th>
            <th>Keterangan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
      <div class="pager">
        <button class="btn-sm" id="btnPrev">âŸ¨ Prev</button>
        <span class="pill" id="pageInfo">Hal 1</span>
        <button class="btn-sm" id="btnNext">Next âŸ©</button>
      </div>
    </div>
  </div>
</div>

<button id="fabAdd" class="fab" title="Tambah">+</button>

<!-- ===== MODAL TAMBAH MUTASI ===== -->
<dialog id="modalMutasi">
  <form id="formMutasi" method="dialog">
    <div class="dlg-hd">Tambah Mutasi</div>
    <div class="dlg-bd">

      <!-- Hidden: tanggal otomatis hari ini -->
      <input id="tanggal" name="tanggal" type="date" class="hidden">

      <div class="row">
        <label for="jenis">Jenis Mutasi</label>
        <select id="jenis" name="jenis" class="input w100" required>
          <option value="TAMBAH">Tambah Saldo</option>
          <option value="KURANG">Ambil Saldo</option>
          <option value="PINDAH">Pindah Saldo</option>
          <option value="OPERASIONAL">Operasional</option>
        </select>
      </div>

      <!-- Akun tunggal (Tambah/Ambil/Operasional) -->
      <div id="rowAkunSingle" class="row">
        <label for="akun">Akun</label>
        <select id="akun" name="akun" class="input w100" required></select>
      </div>

      <!-- Akun sumber/tujuan (Pindah) -->
      <div id="rowAkunPindah" class="hidden">
        <div class="row">
          <label for="akunSumber">Akun Sumber</label>
          <select id="akunSumber" name="akunSumber" class="input w100"></select>
        </div>
        <div class="row">
          <label for="akunTujuan">Akun Tujuan</label>
          <select id="akunTujuan" name="akunTujuan" class="input w100"></select>
        </div>
      </div>

      <div class="row">
        <label for="nominal">Nominal (Rp ribuan)</label>
        <input id="nominal" name="nominal" class="input w100" placeholder="cth 1.000 / 10.000" required>
      </div>

      <div class="row hidden" id="rowAdmin">
        <label for="admin">Admin Bank (Rp)</label>
        <input id="admin" name="admin" class="input w100" placeholder="cth 2.500" value="0">
      </div>

      <div class="row">
        <label for="keterangan">Keterangan</label>
        <input id="keterangan" name="keterangan" class="input w100" placeholder="catatan (opsional)">
      </div>

      <!-- Hidden untuk branch & user -->
      <input type="hidden" id="branch_code" name="branch_code">
      <input type="hidden" id="created_by" name="created_by">
    </div>
    <div class="dlg-ft">
      <button type="button" id="btnCancel" class="btn btn-sm">Batal</button>
      <button type="submit" id="btnSaveMutasi" class="btn btn-primary">Simpan</button>
    </div>
  </form>
</dialog>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  const $ = id=>document.getElementById(id);
  let me=null, gBranch=null, branchesMap=new Map(), akunCabang=[];

  function parseMoney(s){
    if(s==null) return 0;
    const cleaned = String(s).replace(/\./g,'').replace(/,/g,'').trim();
    const n = Number(cleaned||0);
    return isFinite(n) ? Math.round(n) : 0;
  }
  function fmt(n){
    return (n||0).toLocaleString('id-ID');
  }

  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session){ location.href='login.html'; return }

    // profil
    const { data: prof } = await supabase.from('profiles')
      .select('id,full_name,email,branch_code,role')
      .eq('id', session.user.id).single();

    me = prof;
    gBranch = (prof.branch_code||'').trim();

    // Badge user: NAMA-ROLE
    const nm = (prof.full_name || prof.email || '').trim();
    const firstName = nm ? nm.split(' ')[0] : '';
    const roleRaw = (prof.role||'').trim();
    $('userBadge').textContent = `${firstName}-${roleRaw}`.toUpperCase();

    // branches
    const { data: branches } = await supabase.from('branches').select('code,name').order('name');
    (branches||[]).forEach(b=>branchesMap.set(b.code, b.name));
    const isOwner = roleRaw.toLowerCase()==='owner';

    if(isOwner){
      $('branchSelect').style.display='inline-block';
      $('branchSelect').innerHTML = (branches && branches.length)
        ? branches.map(b=>`<option value="${b.code}">${b.name}</option>`).join('')
        : '<option value="">-- Pilih Toko --</option>';
      $('branchSelect').value = gBranch || (branches?.[0]?.code || '');
      gBranch = $('branchSelect').value;
      $('branchSelect').onchange = async ()=>{
        gBranch = $('branchSelect').value;
        updateCurrentStoreName();
        await loadAkunCabang();
      };
    }else{
      $('branchSelect').style.display='none';
    }
    updateCurrentStoreName();

    // tombol tambah & fab
    document.getElementById('btnTambah')?.addEventListener('click', openFormAdd);
    document.getElementById('fabAdd')?.addEventListener('click', openFormAdd);

    // modal events
    $('btnCancel').addEventListener('click', closeFormAdd);
    $('formMutasi').addEventListener('submit', onSaveMutasi);
    $('jenis').addEventListener('change', refreshJenisUI);

    initSidebarToggler();

    await loadAkunCabang();   // isi dropdown akun sesuai cabang
    await loadKPI();          // placeholder
    await loadRiwayat();      // placeholder
  }

  function updateCurrentStoreName(){
    const name = branchesMap.get(gBranch) || gBranch || '-';
    $('currentStoreName').textContent = name;
  }

  /* ====== Ambil daftar akun untuk cabang aktif ======
     Asumsi tabel: public.accounts (id,name,branch_code)
     Jika schema Anda berbeda, ubah SELECT di sini.
  */
  async function loadAkunCabang(){
    const { data, error } = await supabase
      .from('accounts')
      .select('id,name,branch_code')
      .eq('branch_code', gBranch)
      .order('name');

    akunCabang = data || [];
    const opts = akunCabang.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    $('akun').innerHTML = opts || '<option value="">(Belum ada akun)</option>';
    $('akunSumber').innerHTML = opts || '<option value="">(Belum ada akun)</option>';
    $('akunTujuan').innerHTML = opts || '<option value="">(Belum ada akun)</option>';
  }

  /* ====== UI Jenis Mutasi ====== */
  function refreshJenisUI(){
    const v = $('jenis').value;
    const isPindah = (v==='PINDAH');
    $('rowAkunSingle').classList.toggle('hidden', isPindah);
    $('rowAkunPindah').classList.toggle('hidden', !isPindah);
    $('rowAdmin').classList.toggle('hidden', !isPindah);
    // set required
    $('akun').required = !isPindah;
    $('akunSumber').required = isPindah;
    $('akunTujuan').required = isPindah;
  }

  /* ====== BUKA/TUTUP FORM ====== */
  function openFormAdd(){
    // Prefill
    const today = new Date().toISOString().slice(0,10);
    $('tanggal').value = today;               // hidden
    $('branch_code').value = gBranch || '';
    $('created_by').value = me?.id || '';

    $('jenis').value = 'TAMBAH';
    $('nominal').value = '';
    $('admin').value = '0';
    $('keterangan').value = '';

    refreshJenisUI();
    $('modalMutasi').showModal();

    // beri hook
    window.dispatchEvent(new CustomEvent('add-mutation', { detail:{ branch:gBranch, user:me } }));
  }
  function closeFormAdd(){
    const dlg = $('modalMutasi');
    if(dlg.open) dlg.close();
  }

  /* ====== SIMPAN ====== */
  async function onSaveMutasi(ev){
    ev.preventDefault();

    const jenis = $('jenis').value;
    const nominal = parseMoney($('nominal').value);
    const admin = parseMoney($('admin').value || '0');
    if(nominal <= 0){ alert('Nominal harus > 0'); return; }

    // map akun id -> name
    const mapIdToName = id => (akunCabang.find(a=>String(a.id)===String(id))?.name || null);

    // rakit payload
    let payload = {
      tanggal: $('tanggal').value,          // hidden (hari ini)
      jenis,
      nominal,
      admin: (jenis==='PINDAH' ? admin : 0),
      keterangan: $('keterangan').value || null,
      branch_code: $('branch_code').value || gBranch,
      created_by: $('created_by').value || (me?.id||null),
      sumber_id: null,
      sumber_name: null,
      tujuan_id: null,
      tujuan_name: null,
      akun_id: null,
      akun_name: null
    };

    if(jenis==='PINDAH'){
      const src = $('akunSumber').value, dst = $('akunTujuan').value;
      if(!src || !dst){ alert('Pilih akun sumber & tujuan'); return; }
      if(src===dst){ alert('Akun sumber & tujuan tidak boleh sama'); return; }
      payload.sumber_id = src;
      payload.sumber_name = mapIdToName(src);
      payload.tujuan_id = dst;
      payload.tujuan_name = mapIdToName(dst);
    }else{
      const ak = $('akun').value;
      if(!ak){ alert('Pilih akun'); return; }
      payload.akun_id = ak;
      payload.akun_name = mapIdToName(ak);
    }

    // hook untuk logika custom Anda
    window.dispatchEvent(new CustomEvent('save-mutation', { detail: payload }));

    try{
      await insertMutasiFallback(payload); // matikan jika Anda override sendiri
      closeFormAdd();
      await loadKPI(); await loadRiwayat();
    }catch(err){
      alert('Gagal menyimpan mutasi: ' + (err?.message||err));
    }
  }

  /* ====== Fallback insert aman ke mutasi_saldo ======
     Sesuaikan kolom dengan schema Anda. Contoh kolom yang cukup umum:
     - jenis, nominal, admin, keterangan, branch_code, created_by, tanggal
     - akun_id/akun_name atau sumber_/tujuan_ untuk pindah
  */
  async function insertMutasiFallback(d){
    const row = {
      tanggal: d.tanggal,
      jenis: d.jenis,
      nominal: d.nominal,
      admin: d.admin,
      keterangan: d.keterangan,
      branch_code: d.branch_code,
      created_by: d.created_by,
      akun_id: d.akun_id,
      akun_name: d.akun_name,
      sumber_id: d.sumber_id,
      sumber_name: d.sumber_name,
      tujuan_id: d.tujuan_id,
      tujuan_name: d.tujuan_name
    };
    const { error } = await supabase.from('mutasi_saldo').insert(row);
    if(error) throw error;
  }

  /* ===== Sidebar ===== */
  function initSidebarToggler(){
    const sidebarEl = document.getElementById('sidebar');
    const overlayEl = document.getElementById('overlay');
    const btnHamb = document.getElementById('toggleSidebar');

    function toggleSidebar(open){
      const willOpen = (typeof open==='boolean') ? open : !sidebarEl.classList.contains('open');
      sidebarEl.classList.toggle('open', willOpen);
      overlayEl.classList.toggle('show', willOpen);
      document.body.classList.toggle('noscroll', willOpen);
      if(btnHamb) btnHamb.setAttribute('aria-expanded', String(willOpen));
    }
    btnHamb?.addEventListener('click', ()=> toggleSidebar());
    overlayEl?.addEventListener('click', ()=> toggleSidebar(false));
    window.addEventListener('keyup', (e)=>{ if(e.key==='Escape') toggleSidebar(false); });
    document.querySelectorAll('.sidebar .nav a').forEach(a=>{
      a.addEventListener('click', ()=> toggleSidebar(false));
    });
  }

  /* ===== Placeholder agar halaman tidak error jika fungsi asli ada di file lain ===== */
  async function loadKPI(){ /* isi sesuai versi Anda */ }
  async function loadRiwayat(){ /* isi sesuai versi Anda */ }

  /* ===== Logout ===== */
  document.getElementById('lnk-logout').addEventListener('click', async (e)=>{
    e.preventDefault();
    await supabase.auth.signOut();
    location.href='login.html';
  });

  boot();
</script>
</body>
</html>
