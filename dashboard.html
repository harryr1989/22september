<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AMKO Dashboard</title>
  <style>
    :root{
      --sidebar-w: 260px;
      --primary:#1769aa; --primary-700:#145a90; --primary-900:#0f4c81;
      --green-600:#1ca85c; --red-600:#e74c3c; --orange-600:#ff8f00;
      --gray-900:#111827; --gray-700:#374151; --gray-500:#6b7280;
      --gray-300:#d1d5db; --gray-200:#e5e7eb; --card:#fff; --ring:#cbd5e1;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;background:#f6f9fb;color:#0f172a;display:flex}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);background:#0f172a;color:#e5e7eb;border-right:1px solid #0b1222;position:fixed;inset:0 auto 0 0;z-index:30;display:flex;flex-direction:column}
    .brand{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,#0f4c81,#0b3a66);color:#fff}
    .brand .logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:#ffffff22;border:1px solid #ffffff33;font-weight:800}
    .brand .title{font-weight:800;letter-spacing:.3px}
    .nav{padding:10px}
    .nav a{display:flex;align-items:center;gap:10px;text-decoration:none;color:#e5e7eb;padding:10px 12px;border-radius:10px;font-size:14px}
    .nav a .ico{width:22px;text-align:center}
    .nav a:hover{background:#1f2937}
    .nav a.active{background:#0b3a66;border:1px solid #1f4f83}
    .group-title{margin:12px 10px 6px;font-size:12px;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px}
    .submenu{margin-left:36px;display:flex;flex-direction:column;gap:4px;margin-top:6px}
    .submenu a{font-size:13px;padding:8px 10px}
    .sidebar-footer{margin-top:auto;padding:10px;border-top:1px solid rgba(255,255,255,.06);font-size:12px;color:#93a3b8}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;min-width:0;display:flex;flex-direction:column}
    .topbar{height:56px;display:flex;align-items:center;gap:10px;padding:0 16px;background:#fff;border-bottom:1px solid var(--gray-200);position:sticky;top:0;z-index:20}
    .toggleBtn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--ring);border-radius:8px;background:#fff;cursor:pointer}
    .container{max-width:1200px;margin:20px auto;padding:0 16px}

    /* Toolbar Filter */
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
    .select,.btn{height:38px;padding:0 12px;border:1px solid var(--ring);border-radius:8px;background:#fff;color:#111;font-size:14px}
    .btn{background:linear-gradient(180deg,#1f7cc5,#1769aa);color:#fff;border:none;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .chip-title{font-size:13px;font-weight:700;letter-spacing:.4px;color:#fff;background:#0f4c81;display:inline-block;padding:6px 10px;border-radius:10px;margin-bottom:8px}

    /* Ribbon Summary */
    .ribbon{background:linear-gradient(180deg,#0e4980,#0b3a66);color:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,76,129,.18);display:grid;grid-template-columns:1.3fr repeat(6,1fr);gap:10px;align-items:stretch;overflow:auto}
    .ribbon .box{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px 12px;min-width:140px}
    .ribbon .box .label{font-size:11px;text-transform:uppercase;opacity:.9;letter-spacing:.5px}
    .ribbon .box .val{font-weight:800;margin-top:6px;font-variant-numeric:tabular-nums;white-space:nowrap}
    .v-blue{color:#cfe8ff}.v-green{color:#b9f7d0}.v-red{color:#ffd0cc}.v-orange{color:#ffe2bf}

    /* Grid Cards */
    .grid{display:grid;gap:16px;margin-top:16px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:700px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1100px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .card{background:var(--card);border:1px solid var(--gray-200);border-radius:16px;overflow:hidden;box-shadow:0 10px 24px rgba(16,24,40,.06)}
    .card-h{background:#1769aa;color:#fff;padding:14px 16px;position:relative;border-top-left-radius:16px;border-top-right-radius:16px}
    .card-h h3{margin:0;font-size:18px}
    .card-h .sub{font-size:12px;opacity:.9;display:flex;gap:8px;align-items:center}
    .chip-trend{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #a7c2de;background:rgba(255,255,255,.15)}
    .card-b{padding:14px 16px}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:8px}
    .kpi{background:#fff;border:1px dashed var(--gray-300);border-radius:10px;padding:10px 12px}
    .kpi .label{font-size:12px;color:#374151}
    .kpi .val{font-weight:800;margin-top:4px;font-variant-numeric:tabular-nums}
    .kpi.green .val{color:var(--green-600)} .kpi.red .val{color:var(--red-600)}
    .kpi.orange .val{color:var(--orange-600)} .kpi.blue .val{color:#145a90}
    .footer-actions{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--gray-200);background:#fafafa}
    .btn-sm{height:34px;padding:0 10px;border-radius:8px;border:1px solid var(--ring);background:#fff;cursor:pointer;font-size:13px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .btn-sm.primary{background:linear-gradient(180deg,#1f7cc5,#1769aa);color:#fff;border:none}

    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:12px 14px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.2);font-size:14px;display:none;z-index:50}
    .empty{margin:28px 0;padding:18px;border:1px dashed var(--gray-300);border-radius:12px;background:#fff;color:#4b5563;text-align:center}
    .muted{color:#6b7280;font-size:12px}
    @media (max-width: 980px){.sidebar{transform:translateX(-100%);transition:transform .25s ease}.sidebar.open{transform:translateX(0)}.main{margin-left:0}}
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">AM</div><div class="title">AMKO Celluler</div>
    </div>
    <nav class="nav">
      <a href="./dashboard.html" class="active"><span class="ico">üìä</span>Dashboard</a>
      <a href="./saldo-real.html"><span class="ico">üìë</span>Saldo Real</a>
      <a href="./master-saldo.html"><span class="ico">üí∞</span>Master Saldo</a>
      <a href="./mutasi-saldo.html"><span class="ico">üîÑ</span>Mutasi Saldo</a>
      <a href="./transaksi-mini-atm.html"><span class="ico">üßÆ</span>Transaksi Mini ATM</a>
      <a href="./laporan.html"><span class="ico">üìà</span>Laporan</a>
      <div class="group-title">Pengaturan</div>
      <a href="./pengaturan.html"><span class="ico">‚öôÔ∏è</span>Pengaturan</a>
      <div class="submenu">
        <a href="./manajemen-pengguna.html">üë• Manajemen Pengguna</a>
        <a href="./hak-akses.html">üîë Hak Akses</a>
      </div>
    </nav>
    <div class="sidebar-footer">¬© AMKO ‚Ä¢ Dashboard v1</div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <button class="toggleBtn" id="toggleSidebar" title="Toggle sidebar">‚ò∞</button>
      <strong>Dashboard</strong>
      <span class="muted" id="topInfo" style="margin-left:auto"></span>
    </div>

    <div class="container">
      <!-- Toolbar Filter -->
      <div class="toolbar">
        <select id="tahun" class="select" aria-label="Tahun"></select>
        <select id="bulan" class="select" aria-label="Bulan">
          <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
          <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
          <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
          <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
        </select>
        <select id="rentang" class="select" aria-label="Rentang">
          <option value="awal-akhir">Awal s.d Akhir</option>
          <option value="mingguan">Mingguan</option>
          <option value="harian">Harian</option>
          <option value="custom">Custom (tgl)</option>
        </select>
        <button id="btnFilter" class="btn">üîé FILTER</button>
        <span class="muted" id="filterNote"></span>
      </div>

      <!-- Ribbon Summary Global -->
      <div id="ribbon" class="ribbon" role="region" aria-label="Ringkasan keseluruhan">
        <div><span class="chip-title">TOTAL KESELURUHAN</span></div>
        <div class="box"><div class="label">ASET CASH</div><div class="val v-blue" id="g_asset_cash">‚Äî</div></div>
        <div class="box"><div class="label">ASET SALDO</div><div class="val v-blue" id="g_asset_saldo">‚Äî</div></div>
        <div class="box"><div class="label">TOTAL ASET</div><div class="val v-blue" id="g_total_asset">‚Äî</div></div>
        <div class="box"><div class="label">PROFIT</div><div class="val v-green" id="g_profit">‚Äî</div></div>
        <div class="box"><div class="label">PENGELUARAN</div><div class="val v-red" id="g_pengeluaran">‚Äî</div></div>
        <div class="box"><div class="label">PROFIT BERSIH</div><div class="val v-green" id="g_profit_bersih">‚Äî</div></div>
      </div>

      <!-- Grid Cabang -->
      <div id="cards" class="grid"></div>
      <div id="emptyState" class="empty" style="display:none">Belum ada cabang / data untuk periode ini.</div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ========= Sidebar ========= */
    const sidebar = document.getElementById('sidebar');
    document.getElementById('toggleSidebar').addEventListener('click', ()=>{ sidebar.classList.toggle('open'); });

    /* ========= Utils ========= */
    const rupiah = (n)=> (n==null||isNaN(n)) ? "‚Äî" : (n<0? "- Rp ":"Rp ")+Math.abs(+n).toLocaleString("id-ID");
    const setText = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
    const toastEl = document.getElementById('toast');
    const showToast=(m,ms=2500)=>{toastEl.textContent=m; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',ms);};
    const getDisplayName = (b)=> (b.display_name?.trim() || b.name?.trim() || b.code);

    /* ========= Supabase Config (punyamu) ========= */
    const SUPABASE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ========= MOCK (fallback jika Supabase gagal) ========= */
    const MOCK_BRANCHES = [
      { code:"AMKO1", display_name:"AMKO111", name:"AMKO111", active:true },
      { code:"AMKO2", display_name:"AMKO2", name:"AMKO2", active:true }
    ];
    const MOCK_METRICS = {
      global:{asset_cash:43714900,asset_saldo:13031798,total_asset:56746698,profit:23773696,pengeluaran:0,profit_bersih:23773696,trends:{profit:0.06,pengeluaran:0,total_asset:0.04}},
      perBranch:{
        AMKO1:{period:"September 2025", total_transaksi:3184, omset:3969924772, pot_bank_operasional:1506500, pengeluaran:0, profit:18652572, profit_bersih:18652572, asset_cash:9159900, asset_saldo:12370631, total_asset:21530531, trends:{omset:0.08,profit_bersih:-0.02}},
        AMKO2:{period:"September 2025", total_transaksi:844, omset:1230791373, pot_bank_operasional:959500, pengeluaran:0, profit:5121124, profit_bersih:5121124, asset_cash:34555000, asset_saldo:661167, total_asset:35216167, trends:{omset:-0.03,profit_bersih:0.05}}
      }
    };

    /* ========= Filter ========= */
    const now=new Date(); const tahunEl=document.getElementById('tahun');
    for(let y=now.getFullYear()-2;y<=now.getFullYear()+1;y++){const o=document.createElement('option');o.value=y;o.textContent=y;if(y===now.getFullYear())o.selected=true;tahunEl.appendChild(o);}
    document.getElementById('bulan').value = (now.getMonth()+1);
    document.getElementById('btnFilter').addEventListener('click', ()=>{ const p=getFilterParams(); document.getElementById('filterNote').textContent=`Periode: ${p.bulanName} ${p.tahun} ‚Ä¢ Rentang: ${p.rentangLabel}`; document.getElementById('topInfo').textContent=`Filter aktif: ${p.bulanName} ${p.tahun}`; loadAll(p); });
    function getFilterParams(){ const tahun=+document.getElementById('tahun').value; const bulan=+document.getElementById('bulan').value; const rentang=document.getElementById('rentang').value; const bulanName=document.getElementById('bulan').selectedOptions[0].textContent; const rentangLabel=document.getElementById('rentang').selectedOptions[0].textContent; return {tahun,bulan,rentang,bulanName,rentangLabel}; }

    /* ========= Helpers URL ========= */
    function buildTransaksiUrl(branchRow){
      const code  = branchRow.code;
      const name  = getDisplayName(branchRow);
      const qs = new URLSearchParams({ branch: code, branch_code: code, branch_name: name });
      return `./transaksi-mini-atm.html?${qs.toString()}`;
    }
    function buildLapTahunanUrl(branchRow, year){
      const code  = branchRow.code;
      const name  = getDisplayName(branchRow);
      const qs = new URLSearchParams({ branch_code: code, branch_name: name, year: String(year || new Date().getFullYear()) });
      return `./lap-tahunan.html?${qs.toString()}`;
    }
    function buildLapBulananUrl(branchRow, year, month){
      const code  = branchRow.code;
      const name  = getDisplayName(branchRow);
      const qs = new URLSearchParams({ branch_code: code, branch_name: name, year: String(year||new Date().getFullYear()), month: String(month|| (new Date().getMonth()+1)) });
      return `./lap-bulanan.html?${qs.toString()}`;
    }

    /* ========= Rendering ========= */
    function renderGlobalRibbon(data){
      setText('g_asset_cash',rupiah(data.asset_cash));
      setText('g_asset_saldo',rupiah(data.asset_saldo));
      setText('g_total_asset',rupiah(data.total_asset));
      setText('g_profit',rupiah(data.profit));
      setText('g_pengeluaran',rupiah(data.pengeluaran));
      setText('g_profit_bersih',rupiah(data.profit_bersih));
    }

    function renderBranchCards(branches, metricsMap){
      const host=document.getElementById('cards'); host.innerHTML="";
      if(!branches||branches.length===0){document.getElementById('emptyState').style.display='block';return;}
      document.getElementById('emptyState').style.display='none';

      branches.forEach(b=>{
        const m = metricsMap[b.code] || {};
        const name = getDisplayName(b);
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <div class="card-h">
            <h3>${name}</h3>
            <div class="sub">
              <span>${m.period||'-'}</span>
              <span class="chip-trend">${(m.trends?.omset??0)>=0?'‚ñ≤':'‚ñº'} Omset</span>
            </div>
          </div>
          <div class="card-b">
            <div class="row">
              <div class="kpi"><div class="label">TOTAL TRANSAKSI</div><div class="val">${(m.total_transaksi||0).toLocaleString('id-ID')}</div></div>
              <div class="kpi green"><div class="label">OMSET</div><div class="val">${rupiah(m.omset)}</div></div>
            </div>
            <div class="row">
              <div class="kpi orange"><div class="label">POT BANK + OPERASIONAL</div><div class="val">${rupiah(m.pot_bank_operasional)}</div></div>
              <div class="kpi red"><div class="label">PENGELUARAN</div><div class="val">${rupiah(m.pengeluaran)}</div></div>
            </div>
            <div class="row">
              <div class="kpi green"><div class="label">PROFIT</div><div class="val">${rupiah(m.profit)}</div></div>
              <div class="kpi green"><div class="label">PROFIT BERSIH</div><div class="val">${rupiah(m.profit_bersih)}</div></div>
            </div>
            <div class="row">
              <div class="kpi blue"><div class="label">ASET CASH</div><div class="val">${rupiah(m.asset_cash)}</div></div>
              <div class="kpi blue"><div class="label">ASET SALDO</div><div class="val">${rupiah(m.asset_saldo)}</div></div>
            </div>
            <div class="row">
              <div class="kpi blue" style="grid-column: span 2;">
                <div class="label">TOTAL ASET</div><div class="val">${rupiah(m.total_asset)}</div>
              </div>
            </div>
          </div>
          <div class="footer-actions">
            <a class="btn-sm" href="${buildLapTahunanUrl(b, window.currentFilter?.tahun)}">üìÑ Lap. Tahunan</a>
            <a class="btn-sm" href="${buildLapBulananUrl(b, window.currentFilter?.tahun, window.currentFilter?.bulan)}">üóìÔ∏è Lap. Bulanan</a>
            <a class="btn-sm primary" href="${buildTransaksiUrl(b)}">üßÆ Mode Transaksi</a>
          </div>`;
        host.appendChild(card);
      });
    }

    /* ========= Loader utama ========= */
    async function trySupabaseOrMock(params){
      let active=false, reason='unknown';
      try{
        // ping ringan
        const { error: ep } = await sb.from('branches').select('code').limit(1);
        if (ep) { reason = ep.message || 'policy/izin'; throw ep; }

        // ambil cabang aktif dari Manajemen Pengguna
        const { data: b, error: eb } = await sb
          .from('branches')
          .select('code, display_name, name, active')
          .eq('active', true)
          .order('code', { ascending: true });
        if (eb) { reason = eb.message; throw eb; }

        // metrik: sementara mock; nanti sambungkan ke view kamu
        const perBranch = {};
        b.forEach(row => { perBranch[row.code] = MOCK_METRICS.perBranch[row.code] || {}; });

        active = true;
        return { active, branches: b, global: MOCK_METRICS.global, perBranch, reason: null };
      } catch (e) {
        return { active, reason, branches: MOCK_BRANCHES, global: MOCK_METRICS.global, perBranch: MOCK_METRICS.perBranch };
      }
    }

    async function loadAll(params){
      try{
        window.currentFilter = params; // simpan filter aktif
        const { active, branches, global, perBranch, reason } = await trySupabaseOrMock(params);
        renderGlobalRibbon(global);
        renderBranchCards(branches, perBranch);
        if (!active) showToast(`‚ö† Supabase tidak aktif, pakai data mock (${reason||'unknown'})`);
        else showToast('‚úÖ Supabase aktif', 1600);
      }catch(err){
        console.error(err); showToast("Gagal memuat data dashboard.");
      }
    }

    /* ========= Boot ========= */
    (function boot(){
      const p=getFilterParams();
      document.getElementById('filterNote').textContent=`Periode: ${p.bulanName} ${p.tahun} ‚Ä¢ Rentang: ${p.rentangLabel}`;
      document.getElementById('topInfo').textContent=`Filter aktif: ${p.bulanName} ${p.tahun}`;
      loadAll(p);
    })();
  </script>
</body>
</html>
