<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amko MiniLink — Dashboard</title>
  <style>
    :root{
      --sidebar-w:240px;
      --brand:#0a5eb6;
      --gray-100:#f1f5f9; --gray-200:#e5e7eb; --gray-300:#d1d5db; --gray-400:#94a3b8;
      --text:#0f172a; --muted:#64748b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;background:#f6f9fb;color:var(--text);display:flex;min-height:100vh}

    /* ===== Sidebar ===== */
    .sidebar{width:var(--sidebar-w);background:#0f172a;color:#e5e7eb;position:fixed;inset:0 auto 0 0;z-index:30;display:flex;flex-direction:column}
    .brand{padding:12px 14px;font-weight:800;font-size:15px;background:linear-gradient(180deg,#0f4c81,#0b3a66)}
    .nav{padding:6px}
    .nav a{display:block;padding:8px 10px;color:#e5e7eb;text-decoration:none;border-radius:8px;font-size:13px}
    .nav a.active{background:#0b3a66}
    .group{margin-top:6px;border:1px solid rgba(255,255,255,.08);border-radius:8px;overflow:hidden}
    .group-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#0e223a;cursor:pointer;font-size:12px;color:#c6d3e1}
    .group-header .title{display:flex;gap:8px;align-items:center;font-weight:700;text-transform:uppercase;letter-spacing:.2px}
    .chev{transition:transform .2s ease}
    .group.collapsed .chev{transform:rotate(-90deg)}
    .group-body{padding:6px;background:#0f253f}
    .group-body a{background:transparent}
    .sidebar-footer{margin-top:auto;padding:8px;font-size:11px;color:#93a3b8}

    /* ===== Main ===== */
    .main{margin-left:var(--sidebar-w);flex:1;min-width:0;display:flex;flex-direction:column}
    .topbar{height:50px;display:flex;align-items:center;gap:10px;padding:0 12px;background:#fff;border-bottom:1px solid var(--gray-200)}
    .toggleBtn{width:32px;height:32px;border:1px solid var(--gray-300);border-radius:6px;background:#fff;cursor:pointer}
    .badge{margin-left:auto;font-weight:700;font-size:13px}
    .container{max-width:1200px;margin:14px auto;padding:0 12px}

    /* ===== Ringkasan ===== */
    .summary{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px 12px;background:#fff;border:1px solid var(--gray-200);border-radius:10px}
    .greet{font-weight:700;font-size:15px}
    .dateshift{color:#4b5563;font-size:12px;margin-top:2px}
    .summary-right label{font-size:11px}
    .select{height:32px;border:1px solid var(--gray-300);border-radius:6px;background:#fff;padding:0 8px;font-size:13px;min-width:160px}
    .spacer{height:12px}

    /* ===== BIG KPI CARD ===== */
    .bigcard{background:#e6f0fb;border:2px solid var(--brand);border-radius:14px;overflow:hidden}
    .bigcard-head{background:#0a5eb6;color:#fff;padding:10px 14px;font-size:13px;display:flex;justify-content:space-between}
    .bigcard-body{padding:12px}
    .panel{background:#f6f7fb;border:1px solid #dbe3f3;border-radius:10px;padding:10px}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .item{background:#fff;border:1px solid var(--gray-200);border-radius:8px;padding:8px 10px;display:flex;flex-direction:column;gap:4px;min-height:64px}
    .label{font-size:11px;color:#6b7280;font-weight:700;text-transform:uppercase}
    .value{font-size:17px;font-weight:900}
    .divider{height:1px;background:#cbd5e1;margin:10px 0}
    .center{text-align:center}
    .total-title{font-size:11px;font-weight:700;color:#6b7280}
    .total-value{font-size:20px;font-weight:900;color:#084c97}
    .muted{color:var(--muted);font-size:11px}

    .btnrow{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
    .btn{background:#0d63c2;color:#fff;padding:8px;border-radius:6px;text-align:center;font-weight:700;font-size:13px;text-decoration:none}
    .btn-full{grid-column:1/-1;background:#0e8d4f}

    .skeleton{border-radius:4px;background:linear-gradient(90deg,#f1f5f9,#e5e7eb,#f1f5f9);background-size:200% 100%;animation:shimmer 1.1s infinite;height:16px;width:60%}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    @media (max-width:640px){
      .grid2{grid-template-columns:1fr}
      .btnrow{grid-template-columns:1fr}
    }
    @media (max-width:980px){
      .sidebar{transform:translateX(-100%);transition:transform .25s ease}
      .sidebar.open{transform:translateX(0)}
      .main{margin-left:0}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Amko MiniLink</div>
    <nav class="nav" id="menuList">
      <!-- di-render via JS -->
    </nav>
    <div class="sidebar-footer">© Amko MiniLink • v1</div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <button class="toggleBtn" id="toggleSidebar">☰</button>
      <strong>Dashboard</strong>
      <span class="badge" id="roleBadge">USER-ROLE</span>
    </div>

    <div class="container">
      <!-- Ringkasan -->
      <section class="summary">
        <div>
          <div class="greet" id="greetText">Selamat Datang</div>
          <div class="dateshift" id="dateShiftText">Tanggal • Shift</div>
        </div>
        <div class="summary-right" id="branchArea" style="display:none">
          <label for="branchSelect">Cabang</label>
          <select id="branchSelect" class="select"><option value="__ALL__">Semua Cabang</option></select>
        </div>
      </section>

      <div class="spacer"></div>

      <!-- KPI Card -->
      <section class="bigcard">
        <div class="bigcard-head">
          <div id="cardBranchTitle">CABANG</div>
          <div id="cardMonth">Bulan Tahun</div>
        </div>
        <div class="bigcard-body">
          <div class="panel">
            <div class="grid2">
              <div class="item"><div class="label">Total Transaksi</div><div class="value" id="kpiTxCount"><span class="skeleton"></span></div></div>
              <div class="item"><div class="label">Omzet</div><div class="value" id="kpiOmzet"><span class="skeleton"></span></div></div>
              <div class="item"><div class="label">Pot Bank + Operasional</div><div class="value" id="kpiPot"><span class="skeleton"></span></div></div>
              <div class="item"><div class="label">Profit</div><div class="value" id="kpiProfitAdmin"><span class="skeleton"></span></div></div>
              <div class="item"><div class="label">Pengeluaran</div><div class="value" id="kpiExpense"><span class="skeleton"></span></div></div>
              <div class="item"><div class="label">Profit Bersih</div><div class="value" id="kpiNet"><span class="skeleton"></span></div></div>
              <div class="item"><div class="label">Aset Cash</div><div class="value" id="kpiCash"><span class="skeleton"></span></div></div>
              <div class="item"><div class="label">Aset Saldo</div><div class="value" id="kpiSaldo"><span class="skeleton"></span></div></div>
            </div>
            <div class="divider"></div>
            <div class="center">
              <div class="total-title">Total Aset</div>
              <div class="total-value" id="kpiAsset"><span class="skeleton"></span></div>
            </div>
            <div class="btnrow">
              <a class="btn" href="./laporan.html#tahun">Lap. Tahunan</a>
              <a class="btn" href="./laporan.html#bulan">Lap. Bulanan</a>
              <a class="btn btn-full" href="./transaksi-mini-atm.html">Mode Transaksi</a>
            </div>
          </div>
          <div class="muted" id="lastUpdated" style="margin-top:6px;">Last updated —</div>
        </div>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== Supabase Init ======
    const SUPABASE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== Auth Guard ======
    async function guard(){
      try{
        const { data:{ session } } = await sb.auth.getSession();
        if(!session) window.location.replace("./login.html");
      }catch{ window.location.replace("./login.html"); }
    }
    guard();
    sb.auth.onAuthStateChange(ev=>{ if(ev==="SIGNED_OUT") window.location.replace("./login.html"); });

    // ====== Toggle Sidebar ======
    const sidebar=document.getElementById("sidebar");
    document.getElementById("toggleSidebar").addEventListener("click",()=>sidebar.classList.toggle("open"));

    // ====== Role & User (badge) ======
    let role=(localStorage.getItem("user_role")||"kasir").toLowerCase();
    let username=localStorage.getItem("user_name")||"USER";
    document.getElementById("roleBadge").textContent=username.toUpperCase()+"-"+role.toUpperCase();

    // ====== MENU MODEL (grup & item) ======
    // item: {type:"item", label, icon, link, ownerOnly?}
    // group: {type:"group", key, title, icon, items:[item,...], ownerOnly?}
    const menuModel = [
      { type:"item", label:"Dashboard", icon:"📊", link:"./dashboard.html" },
      { type:"item", label:"Transaksi Mini ATM", icon:"🧮", link:"./transaksi-mini-atm.html" },
      {
        type:"group", key:"grp_master", title:"Master Data", icon:"📂",
        items: [
          { type:"item", label:"Master Saldo Akun", icon:"💰", link:"./master-saldo-akun.html" },
          { type:"item", label:"Mutasi Saldo", icon:"🔄", link:"./mutasi-saldo.html" },
          { type:"item", label:"Saldo Real", icon:"📑", link:"./saldo-real.html" }
        ]
      },
      { type:"item", label:"Laporan", icon:"📘", link:"./laporan.html", ownerOnly:true },
      {
        type:"group", key:"grp_pengaturan", title:"Pengaturan", icon:"⚙️",
        items: [
          { type:"item", label:"Manajemen Pengguna", icon:"👥", link:"./manajemen-pengguna.html", ownerOnly:true },
          { type:"item", label:"Hak Akses", icon:"🔑", link:"./hak-akses.html", ownerOnly:true }
        ],
        ownerOnly:true
      }
    ];

    // ====== Render Sidebar with collapsible groups ======
    function isActive(link){
      const here = location.pathname.split("/").pop() || "dashboard.html";
      return (link||"").endsWith(here);
    }
    function getGroupState(key){
      const st = JSON.parse(localStorage.getItem("sidebar_groups_state")||"{}");
      return st[key]!==false; // default expanded
    }
    function setGroupState(key, open){
      const st = JSON.parse(localStorage.getItem("sidebar_groups_state")||"{}");
      st[key]=!!open; localStorage.setItem("sidebar_groups_state", JSON.stringify(st));
    }

    function renderSidebar(){
      const nav=document.getElementById("menuList");
      nav.innerHTML="";

      menuModel.forEach(node=>{
        // hide ownerOnly untuk non-owner
        if(node.ownerOnly && role!=="owner") return;

        if(node.type==="item"){
          const a=document.createElement("a");
          a.href=node.link;
          a.textContent=`${node.icon} ${node.label}`;
          if(isActive(node.link)) a.classList.add("active");
          nav.appendChild(a);
        }else if(node.type==="group"){
          const group=document.createElement("div");
          group.className="group";
          if(!getGroupState(node.key)) group.classList.add("collapsed");

          const head=document.createElement("div");
          head.className="group-header";
          head.innerHTML=`<div class="title">${node.icon} ${node.title}</div><div class="chev">▾</div>`;
          head.addEventListener("click",()=>{
            const open = group.classList.toggle("collapsed") ? false : true;
            if(open) group.classList.remove("collapsed"); else group.classList.add("collapsed");
            setGroupState(node.key, open);
          });

          const body=document.createElement("div");
          body.className="group-body";

          (node.items||[]).forEach(it=>{
            if(it.ownerOnly && role!=="owner") return;
            const a=document.createElement("a");
            a.href=it.link;
            a.textContent=`${it.icon} ${it.label}`;
            if(isActive(it.link)) a.classList.add("active");
            body.appendChild(a);
          });

          group.appendChild(head);
          group.appendChild(body);
          nav.appendChild(group);

          // apply open/close state
          const open = getGroupState(node.key);
          if(!open) group.classList.add("collapsed");
        }
      });
    }
    renderSidebar();

    // ===== Ringkasan tanggal + sapaan =====
    function fullDateShift(){
      const hari=["Min","Sen","Sel","Rab","Kam","Jum","Sab"];
      const now=new Date();const h=now.getHours();
      const shift=(h<13)?"Shift Pagi":(h<20)?"Shift Siang":"Shift Malam";
      return `${hari[now.getDay()]}, ${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()} • ${shift}`;
    }
    document.getElementById("greetText").textContent="Selamat Datang, "+(username.split(" ")[0]||username);
    document.getElementById("dateShiftText").textContent=fullDateShift();
    document.getElementById("cardMonth").textContent=new Date().toLocaleDateString("id-ID",{month:"long",year:"numeric"});

    // ===== Dropdown Cabang (OWNER saja) — skema code/name seperti file awal =====
    const branchArea=document.getElementById("branchArea");
    const branchSelect=document.getElementById("branchSelect");
    const cardBranchTitle=document.getElementById("cardBranchTitle");

    async function resolveBranchTitle(code){
      if(!code || code==="__ALL__"){ cardBranchTitle.textContent="SEMUA CABANG"; return; }
      try{
        const { data, error } = await sb.from("branches").select("name").eq("code", code).maybeSingle();
        if (error || !data) { cardBranchTitle.textContent="CABANG"; return; }
        cardBranchTitle.textContent = (data?.name || "CABANG").toUpperCase();
      }catch{ cardBranchTitle.textContent="CABANG"; }
    }
    async function loadBranchesToSelect(){
      if(role!=="owner"){branchArea.style.display="none";return;}
      branchArea.style.display="";
      branchSelect.innerHTML='<option value="__ALL__">Semua Cabang</option>';
      try{
        const {data,error}=await sb.from("branches").select("code,name").order("name",{ascending:true});
        if(!error && data){
          data.forEach(b=>{
            const opt=document.createElement("option");
            opt.value=b.code; opt.textContent=b.name; // nama saja
            branchSelect.appendChild(opt);
          });
        }
      }catch(e){ console.warn(e); }
      const saved = localStorage.getItem("selected_branch_code") || "__ALL__";
      branchSelect.value = saved;
      await resolveBranchTitle(saved);
      branchSelect.onchange = async ()=>{
        localStorage.setItem("selected_branch_code", branchSelect.value);
        await resolveBranchTitle(branchSelect.value);
        refreshKPI();
      };
    }
    if (role==="owner") loadBranchesToSelect();

    // ===== KPI =====
    const elTxCount=document.getElementById("kpiTxCount");
    const elOmzet=document.getElementById("kpiOmzet");
    const elPot=document.getElementById("kpiPot");
    const elProfitAdmin=document.getElementById("kpiProfitAdmin");
    const elExpense=document.getElementById("kpiExpense");
    const elNet=document.getElementById("kpiNet");
    const elCash=document.getElementById("kpiCash");
    const elSaldo=document.getElementById("kpiSaldo");
    const elAsset=document.getElementById("kpiAsset");
    const lastUpdatedEl=document.getElementById("lastUpdated");

    function fmtRupiah(n){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0}).format(n||0)}
    function todayRange(){
      const now=new Date();
      const start=new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0);
      const end=new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);
      return { start:start.toISOString(), end:end.toISOString() };
    }
    function selectedBranchCode(){
      if (role==="owner") return localStorage.getItem("selected_branch_code") || "__ALL__";
      return localStorage.getItem("user_branch_code") || ""; // untuk kasir jika diperlukan
    }

    async function refreshKPI(){
      lastUpdatedEl.textContent="Last updated —";
      const s=`<span class="skeleton"></span>`;
      [elTxCount,elOmzet,elPot,elProfitAdmin,elExpense,elNet,elCash,elSaldo,elAsset].forEach(el=>el.innerHTML=s);

      const br = selectedBranchCode();
      const { start, end } = todayRange();

      let omzet=0, txCount=0, adminIn=0, bankFee=0, expense=0;
      let cash=0, bank=0, pulsa=0;

      try{
        // Transaksi harian (v_tx_summary -> fallback transactions_mini_atm)
        let dataTx=null;
        let q = sb.from("v_tx_summary")
          .select("amount, admin_in, bank_fee, jenis, branch_code, created_at")
          .gte("created_at", start).lte("created_at", end);
        if (br && br!=="__ALL__") q = q.eq("branch_code", br);
        let r = await q; if(!r.error) dataTx = r.data;

        if(!dataTx || !dataTx.length){
          let q2 = sb.from("transactions_mini_atm")
            .select("amount, admin_in, bank_fee, jenis, branch_code, created_at")
            .gte("created_at", start).lte("created_at", end);
          if (br && br!=="__ALL__") q2 = q2.eq("branch_code", br);
          const r2 = await q2; if(!r2.error) dataTx = r2.data;
        }
        if (dataTx && dataTx.length){
          const facing=["tarik","transfer","pulsa","jasa"];
          dataTx.forEach(row=>{
            const jenis=(row.jenis||"").toString().toLowerCase();
            if (facing.includes(jenis)){
              txCount += 1;
              omzet   += (+row.amount || 0);
              adminIn += (+row.admin_in || 0);
              bankFee += (+row.bank_fee || 0);
            }
          });
        }

        // Pengeluaran harian (v_mutasi_summary -> fallback mutasi_saldo)
        let dataMut=null;
        let q3 = sb.from("v_mutasi_summary")
          .select("jenis, amount, branch_code, created_at")
          .gte("created_at", start).lte("created_at", end);
        if (br && br!=="__ALL__") q3 = q3.eq("branch_code", br);
        const r3 = await q3; if(!r3.error) dataMut = r3.data;

        if(!dataMut || !dataMut.length){
          let q4 = sb.from("mutasi_saldo")
            .select("jenis, nominal, branch_code, created_at")
            .gte("created_at", start).lte("created_at", end);
          if (br && br!=="__ALL__") q4 = q4.eq("branch_code", br);
          const r4 = await q4;
          if(!r4.error){
            dataMut = (r4.data||[]).map(x=>({ jenis:x.jenis, amount:x.nominal, branch_code:x.branch_code, created_at:x.created_at }));
          }
        }
        if (dataMut && dataMut.length){
          dataMut.forEach(row=>{
            if ((row.jenis||"").toString().toLowerCase()==="operasional"){
              expense += (+row.amount || 0);
            }
          });
        }

        // Aset (accounts)
        let qAcc = sb.from("accounts").select("type, is_locked, balance, branch_code");
        if (br && br!=="__ALL__") qAcc = qAcc.eq("branch_code", br);
        const acc = await qAcc;
        if(!acc.error && acc.data){
          acc.data.forEach(a=>{
            const t=(a.type||"").toString().toLowerCase();
            const bal=(+a.balance || 0);
            if (t==="cash" && a.is_locked) cash += bal;
            else if (t==="bank") bank += bal;
            else if (t==="server_pulsa") pulsa += bal;
          });
        }

        // Hitung KPI
        const pot = bankFee + expense;
        const profitAdmin = adminIn - bankFee;
        const net = profitAdmin - expense;
        const totalSaldo = bank + pulsa;
        const totalAsset = cash + totalSaldo;

        // Render
        elTxCount.textContent     = `${txCount}x`;
        elOmzet.textContent       = fmtRupiah(omzet);
        elPot.textContent         = fmtRupiah(pot);
        elProfitAdmin.textContent = fmtRupiah(profitAdmin);
        elExpense.textContent     = fmtRupiah(expense);
        elNet.textContent         = fmtRupiah(net);
        elCash.textContent        = fmtRupiah(cash);
        elSaldo.textContent       = fmtRupiah(totalSaldo);
        elAsset.textContent       = fmtRupiah(totalAsset);

        lastUpdatedEl.textContent = "Last updated "+new Date().toLocaleTimeString("id-ID");
      }catch(err){
        console.error("refreshKPI:", err);
        [elTxCount,elOmzet,elPot,elProfitAdmin,elExpense,elNet,elCash,elSaldo,elAsset].forEach(el=>el.textContent="—");
      }
    }
    refreshKPI();
  </script>
</body>
</html>
