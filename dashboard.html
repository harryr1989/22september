<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AMKO Dashboard</title>
  <style>
    :root{
      --sidebar-w: 260px;
      --primary:#1769aa;
      --primary-700:#145a90;
      --primary-900:#0f4c81;
      --gray-900:#111827;
      --gray-700:#374151;
      --gray-500:#6b7280;
      --gray-300:#d1d5db;
      --gray-200:#e5e7eb;
      --card:#ffffff;
      --ring:#cbd5e1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
      background:#f6f9fb; color:#0f172a; display:flex;
    }

    .sidebar{
      width:var(--sidebar-w);
      background:#0f172a; color:#e5e7eb;
      border-right:1px solid #0b1222;
      position:fixed; inset:0 auto 0 0; z-index:30;
      display:flex; flex-direction:column;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg,#0f4c81,#0b3a66); color:#fff;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:10px; display:grid; place-items:center;
      background:#ffffff22; border:1px solid #ffffff33; font-weight:800
    }
    .brand .title{font-weight:800; letter-spacing:.3px}
    .nav{padding:10px}
    .nav a{
      display:flex; align-items:center; gap:10px; text-decoration:none; color:#e5e7eb;
      padding:10px 12px; border-radius:10px; font-size:14px;
    }
    .nav a .ico{width:22px; text-align:center}
    .nav a:hover{background:#1f2937}
    .nav a.active{background:#0b3a66; border:1px solid #1f4f83}
    .nav .group-title{
      margin:12px 10px 6px; font-size:12px; color:#9ca3af; text-transform:uppercase; letter-spacing:.5px;
    }
    .submenu a{font-size:13px; padding:8px 10px; margin-left:36px}
    .sidebar-footer{margin-top:auto; padding:10px; border-top:1px solid rgba(255,255,255,.06); font-size:12px; color:#93a3b8}

    .main{margin-left:var(--sidebar-w); flex:1; min-width:0; display:flex; flex-direction:column}
    .topbar{
      height:56px; display:flex; align-items:center; gap:10px; padding:0 16px;
      background:#fff; border-bottom:1px solid var(--gray-200); position:sticky; top:0; z-index:20;
    }
    .toggleBtn{
      display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px;
      border:1px solid var(--ring); border-radius:8px; background:#fff; cursor:pointer;
    }
    .btn-logout{
      margin-left:10px; padding:6px 12px; border-radius:8px;
      border:1px solid var(--ring); background:#fff; cursor:pointer; font-size:13px;
    }
    .btn-logout:hover{background:#fee2e2; border-color:#fca5a5; color:#b91c1c}

    .container{max-width:1200px; margin:20px auto; padding:0 16px}
    .empty{
      margin:28px 0; padding:28px; border:1px dashed var(--gray-300); border-radius:12px; background:#fff; color:#4b5563;
      text-align:center; font-size:18px; font-weight:700;
    }
    .muted{color:#6b7280; font-size:12px}

    @media (max-width: 980px){
      .sidebar{transform:translateX(-100%); transition:transform .25s ease}
      .sidebar.open{transform:translateX(0)}
      .main{margin-left:0}
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">AM</div>
      <div class="title">AMKO Celluler</div>
    </div>
    <nav class="nav" id="menuList"></nav>
    <div class="sidebar-footer">Â© AMKO â€¢ Dashboard v1</div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <button class="toggleBtn" id="toggleSidebar" title="Toggle sidebar">â˜°</button>
      <strong>Dashboard</strong>
      <span class="muted" id="roleBadge" style="margin-left:auto"></span>
      <button id="btnLogout" class="btn-logout">ðŸšª Logout</button>
    </div>
    <div class="container">
      <div class="empty">Selamat Datang</div>
    </div>
  </main>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const sidebar = document.getElementById('sidebar');
    document.getElementById('toggleSidebar').addEventListener('click', ()=> sidebar.classList.toggle('open'));

    let role = (localStorage.getItem("user_role") || "kasir").toLowerCase();
    const roleBadge = document.getElementById('roleBadge');
    roleBadge.textContent = "Role: " + role.toUpperCase();

    const menuConfig = [
      { label:"Dashboard", icon:"ðŸ“Š", link:"./dashboard.html", ownerOnly:true },
      { label:"Transaksi Mini ATM", icon:"ðŸ§®", link:"./transaksi-mini-atm.html" },
      { label:"Saldo Real", icon:"ðŸ“‘", link:"./saldo-real.html" },
      { label:"Master Saldo Akun", icon:"ðŸ’°", link:"./master-saldo-akun.html" },
      { label:"Mutasi Saldo", icon:"ðŸ”„", link:"./mutasi-saldo.html" },
      { label:"Laporan", icon:"ðŸ§®", link:"./laporan.html", ownerOnly:true },
      { group:"Pengaturan", ownerOnly:true },
      { label:"Manajemen Pengguna", icon:"ðŸ‘¥", link:"./manajemen-pengguna.html", parent:"Pengaturan", ownerOnly:true },
      { label:"Hak Akses", icon:"ðŸ”‘", link:"./hak-akses.html", parent:"Pengaturan", ownerOnly:true }
    ];

    function renderSidebar(){
      const nav = document.getElementById("menuList");
      nav.innerHTML = "";
      let currentGroup = "";
      menuConfig.forEach(item=>{
        if(item.ownerOnly && role !== "owner") return;
        if(item.group){
          const div = document.createElement("div");
          div.className = "group-title"; div.textContent = item.group; nav.appendChild(div);
          currentGroup = item.group; return;
        }
        const a = document.createElement("a");
        a.href = item.link;
        a.innerHTML = `<span class="ico">${item.icon}</span>${item.label}`;
        if(item.parent && item.parent === currentGroup){
          a.style.marginLeft="36px"; a.style.fontSize="13px";
        }
        nav.appendChild(a);
      });
      markActive(nav);
    }
    function markActive(nav){
      const links = nav.querySelectorAll("a[href]");
      const here = location.pathname.split("/").pop() || "dashboard.html";
      links.forEach(a=>{ if(a.getAttribute("href").endsWith(here)) a.classList.add("active"); });
    }
    renderSidebar();

    // ==== Logout ====
    document.getElementById("btnLogout").addEventListener("click", async ()=>{
      try{
        await sb.auth.signOut();
      }catch(e){ console.warn("SignOut error:", e); }
      localStorage.removeItem("user_role");
      window.location.href = "./login.html";
    });

    // ==== Sync role from Supabase session ====
    async function syncRole(){
      const { data: { session } } = await sb.auth.getSession();
      if(!session || !session.user) return;
      let r = session.user.user_metadata?.role || session.user.app_metadata?.role || "";
      if(!r){
        const { data: prof } = await sb.from("profiles").select("role").eq("id", session.user.id).maybeSingle();
        r = prof?.role || "kasir";
      }
      r = r.toLowerCase();
      if(r !== role){
        role = r; localStorage.setItem("user_role", role);
        roleBadge.textContent = "Role: " + role.toUpperCase();
        renderSidebar();
      }
    }
    syncRole();
    sb.auth.onAuthStateChange(()=> syncRole());
  </script>
</body>
</html>
