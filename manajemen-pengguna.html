<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Manajemen Pengguna | AMKO</title>
  <style>
    :root{
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --muted:#64748b; --txt:#0f172a;
      --shadow:0 6px 18px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt)}
    button,input,select,textarea{font-family:inherit}

    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px}
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--pri);color:#fff}
    header{position:sticky;top:0;z-index:9;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .content{padding:16px;max-width:1100px;margin:0 auto}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f9fafb;font-size:12px}

    .section{margin-top:16px}
    .section h3{margin:0 0 10px 0;font-size:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:18px;box-shadow:var(--shadow);padding:14px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;height:44px;outline:none}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:44px}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-ghost{background:#f1f5f9}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .rowcard{display:grid;grid-template-columns:200px 1fr 120px 140px 120px;gap:8px;align-items:center;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:10px}
    .muted{color:#64748b}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:800;color:#fff}
    .badge-owner{background:#0ea5e9}
    .badge-admin{background:#22c55e}
    .badge-kasir{background:#d97706}

    .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
    .dialog{width:min(560px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px}
    .dlg-ft{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--bd);background:#fafafa}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    .icon-input{display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff}
    .icon-input input,.icon-input select{border:none;outline:none;flex:1;font-size:15px;background:transparent}
    .error{display:none;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px}
    .ok{display:none;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:10px}

    @media (max-width: 840px){
      .layout{grid-template-columns:1fr}
      .sidebar{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:10}
      .brand{margin:0}
      .content{padding:12px}
      .row{grid-template-columns:1fr}
      .rowcard{grid-template-columns:1fr;gap:6px}
      .toolbar{gap:6px}
    }
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="brand">AMKO</div>
    <nav class="nav" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="master-saldo-akun.html">üí≥ Master Akun</a>
      <a href="transaksi-mini-atm.html">üèß Mini ATM</a>
      <a class="active" href="manajemen-pengguna.html">‚öôÔ∏è Manajemen</a>
      <a href="#" id="lnk-logout">üö™ Logout</a>
    </nav>
  </aside>

  <div>
    <header>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Manajemen Pengguna</h2>
        <span class="pill">Tambah & Edit user (server-verified)</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="me" class="pill">memuat‚Ä¶</div>
        <div id="roleBadge" class="pill">role: ‚Ä¶</div>
        <div id="branchBadge" class="pill">branch: ‚Ä¶</div>
      </div>
    </header>

    <div class="content">
      <!-- CABANG -->
      <div class="section">
        <h3>Cabang</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qBranch" class="input" placeholder="Cari cabang‚Ä¶"/>
            <button id="btnAddBranch" class="btn btn-primary">+ Tambah Cabang</button>
          </div>
          <div id="branchesWrap">
            <div id="branchesList" style="display:grid;gap:8px"></div>
            <div id="noBranch" class="muted" style="padding:8px 2px;display:none">Belum ada cabang.</div>
          </div>
        </div>
      </div>

      <!-- USER -->
      <div class="section">
        <h3>Pengguna</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qUser" class="input" placeholder="Cari nama / email‚Ä¶"/>
            <select id="fltBranch" class="input">
              <option value="">Semua cabang</option>
            </select>
            <select id="fltRole" class="input">
              <option value="">Semua role</option>
              <option value="owner">owner</option>
              <option value="admin">admin</option>
              <option value="kasir">kasir</option>
            </select>
            <button id="btnAddUser" class="btn btn-ghost">+ Tambah User</button>
          </div>

          <div id="usersList" style="display:grid;gap:8px"></div>
          <div id="noUser" class="muted" style="padding:8px 2px;display:none">Belum ada pengguna.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Tambah Cabang -->
<div class="modal" id="modalBranch">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Tambah Cabang</span>
      <button class="btn btn-ghost" id="btnCloseBranch">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div id="msgErrBranch" class="error"></div>
      <div id="msgOkBranch" class="ok"></div>

      <div>
        <label>Nama Cabang</label>
        <div class="icon-input">
          <span>üè¢</span>
          <input id="b_name" placeholder="Contoh: Cabang Samarinda"/>
        </div>
      </div>
      <div>
        <label>Kode Cabang (unik, tanpa spasi)</label>
        <div class="icon-input">
          <span>#</span>
          <input id="b_code" placeholder="Contoh: SMR01"/>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelBranch">Batal</button>
      <button class="btn btn-primary" id="btnSaveBranch">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Tambah User -->
<div class="modal" id="modalUser">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Tambah User</span>
      <button class="btn btn-ghost" id="btnCloseUser">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrUser"></div>
      <div class="ok" id="msgOkUser"></div>

      <div class="row">
        <div>
          <label>Nama Lengkap</label>
          <div class="icon-input">
            <span>üë§</span>
            <input id="u_name" placeholder="Nama"/>
          </div>
        </div>
        <div>
          <label>Email</label>
          <div class="icon-input">
            <span>‚úâÔ∏è</span>
            <input id="u_email" placeholder="email@contoh.com"/>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Role</label>
          <div class="icon-input">
            <select id="u_role">
              <option value="kasir">kasir</option>
              <option value="admin">admin</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div>
          <label>Cabang</label>
          <div class="icon-input">
            <select id="u_branch"></select>
          </div>
        </div>
      </div>

      <div>
        <label>Password (opsional)</label>
        <div class="icon-input">
          <span>üîë</span>
          <input id="u_password" placeholder="Minimal 6 karakter (atau kosongkan ‚Üí auto-generate)"/>
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px">Kosongkan bila ingin password sementara & reset link.</div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelUser">Tutup</button>
      <button class="btn btn-primary" id="btnSaveUser">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Edit User -->
<div class="modal" id="modalEdit">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Edit User</span>
      <button class="btn btn-ghost" id="btnCloseEdit">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrEdit"></div>
      <div class="ok" id="msgOkEdit"></div>

      <input type="hidden" id="e_id"/>

      <div class="row">
        <div>
          <label>Nama Lengkap</label>
          <div class="icon-input">
            <span>üë§</span>
            <input id="e_name" placeholder="Nama"/>
          </div>
        </div>
        <div>
          <label>Email (read-only)</label>
          <div class="icon-input">
            <span>‚úâÔ∏è</span>
            <input id="e_email" placeholder="email@contoh.com" readonly/>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Role</label>
          <div class="icon-input">
            <select id="e_role">
              <option value="kasir">kasir</option>
              <option value="admin">admin</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div>
          <label>Cabang</label>
          <div class="icon-input">
            <select id="e_branch"></select>
          </div>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelEdit">Tutup</button>
      <button class="btn btn-primary" id="btnSaveEdit">Simpan</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  // ===== Supabase (frontend pakai ANON) =====
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y"; // ANON
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  // ===== Edge Functions =====
  const FUNC_CREATE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/clever-processor";      // Buat user
  const FUNC_UPDATE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/super-endpoint";         // Edit user

  const $ = (id)=>document.getElementById(id)
  const showErr = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},3500) }
  const showOk  = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},2500) }
  const pill = (r)=> r==='owner' ? 'badge-owner' : (r==='admin'?'badge-admin':'badge-kasir')

  let gRole=null, gBranch=null
  let branches=[], users=[]

  function openModal(id){ $(id).style.display='flex' }
  function closeModal(id){ $(id).style.display='none' }

  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }

    const { data: prof, error } = await supabase
      .from('profiles').select('id,full_name,email,role,branch_code')
      .eq('id', session.user.id).single()
    if(error){ alert('Gagal ambil profil: '+error.message); return }

    gRole = prof.role; gBranch = prof.branch_code
    $('me').textContent = `${prof.full_name || prof.email}`
    $('roleBadge').textContent = `role: ${prof.role}`
    $('branchBadge').textContent = `branch: ${prof.branch_code}`

    await Promise.all([loadBranches(), loadUsers()])
    renderBranches(); renderUsers(); fillBranchFilters()
  }

  async function loadBranches(){
    let q = supabase.from('branches').select('id,code,name')
    if(gRole!=='owner') q = q.eq('code', gBranch)
    const { data, error } = await q.order('name')
    if(error){ console.error(error); branches=[]; return }
    branches = data||[]
  }

  async function loadUsers(){
    let q = supabase.from('profiles').select('id,full_name,email,role,branch_code')
    if(gRole!=='owner') q = q.eq('branch_code', gBranch)
    const { data, error } = await q.order('full_name', { nullsFirst:true })
    if(error){ console.error(error); users=[]; return }
    users = data||[]
  }

  function renderBranches(){
    const q = $('qBranch').value.trim().toLowerCase()
    const list = (branches||[]).filter(b => !q || (b.name||'').toLowerCase().includes(q) || (b.code||'').toLowerCase().includes(q))
    $('branchesList').innerHTML = list.map(b=>`
      <div class="rowcard">
        <div><strong>${b.name}</strong></div>
        <div class="muted">Kode: ${b.code}</div>
        <div>${(users||[]).filter(u=>u.branch_code===b.code).length} user</div>
        <div></div>
        <div style="text-align:right"><span class="muted">-</span></div>
      </div>
    `).join('')
    $('noBranch').style.display = list.length ? 'none' : 'block'
  }

  function renderUsers(){
    const q = $('qUser').value.trim().toLowerCase()
    const fB = $('fltBranch').value
    const fR = $('fltRole').value
    const list = (users||[]).filter(function(u){
      if(q && !((u.full_name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q))) return false
      if(fB && u.branch_code!==fB) return false
      if(fR && u.role!==fR) return false
      return true
    })
    $('usersList').innerHTML = list.map(function(u){
      return `
        <div class="rowcard">
          <div><strong>${u.full_name || '-'}</strong></div>
          <div class="muted">${u.email||'-'}</div>
          <div><span class="badge ${pill(u.role)}">${u.role}</span></div>
          <div><span class="pill">branch: ${u.branch_code||'-'}</span></div>
          <div style="text-align:right">
            <button class="btn btn-ghost" data-edit="${u.id}">Edit</button>
          </div>
        </div>`
    }).join('')
    $('noUser').style.display = list.length ? 'none' : 'block'
  }

  function fillBranchFilters(){
    const sel = $('fltBranch'); const selAdd = $('u_branch'); const selEdit = $('e_branch')
    sel.innerHTML = ['<option value="">Semua cabang</option>']
      .concat((branches||[]).map(function(b){ return `<option value="${b.code}">${b.name} (${b.code})</option>` })).join('')
    const opts = (branches||[]).map(function(b){ return `<option value="${b.code}">${b.name} (${b.code})</option>` }).join('')
    selAdd.innerHTML = opts
    selEdit.innerHTML = opts
    selAdd.value = gBranch || ''
  }

  // events filter
  $('qBranch').addEventListener('input', renderBranches)
  $('qUser').addEventListener('input', renderUsers)
  $('fltBranch').addEventListener('change', renderUsers)
  $('fltRole').addEventListener('change', renderUsers)

  // Tambah Cabang
  $('btnAddBranch').addEventListener('click', function(){
    $('b_name').value=''; $('b_code').value='';
    $('msgErrBranch').style.display='none'; $('msgOkBranch').style.display='none';
    openModal('modalBranch')
  })
  $('btnCloseBranch').onclick = function(){ closeModal('modalBranch') }
  $('btnCancelBranch').onclick = function(){ closeModal('modalBranch') }

  $('btnSaveBranch').addEventListener('click', async function(){
    const name = $('b_name').value.trim()
    const code = $('b_code').value.trim()
    if(!name || !code){ showErr($('msgErrBranch'),'Nama & Kode wajib'); return }
    if(/\s/.test(code)){ showErr($('msgErrBranch'),'Kode tanpa spasi'); return }
    const existRes = await supabase.from('branches').select('id').eq('code', code).maybeSingle()
    if(existRes.error){ showErr($('msgErrBranch'),'Cek kode: '+existRes.error.message); return }
    if(existRes.data){ showErr($('msgErrBranch'),'Kode sudah dipakai'); return }
    const ins = await supabase.from('branches').insert({ name, code })
    if(ins.error){ showErr($('msgErrBranch'),'Gagal tambah cabang: '+ins.error.message); return }
    showOk($('msgOkBranch'),'Cabang ditambahkan')
    await loadBranches(); renderBranches(); fillBranchFilters()
    setTimeout(function(){ closeModal('modalBranch') }, 700)
  })

  // Tambah User
  $('btnAddUser').addEventListener('click', function(){
    $('u_name').value=''; $('u_email').value='';
    $('u_role').value='kasir'; $('u_branch').value = gBranch || '';
    $('u_password').value='';
    $('msgErrUser').style.display='none'; $('msgOkUser').style.display='none';
    openModal('modalUser')
  })
  $('btnCloseUser').onclick = function(){ closeModal('modalUser') }
  $('btnCancelUser').onclick = function(){ closeModal('modalUser') }

  $('btnSaveUser').addEventListener('click', async function(){
    const full_name = $('u_name').value.trim()
    const email = $('u_email').value.trim().toLowerCase()
    const role = $('u_role').value
    const branch_code = $('u_branch').value
    const password = $('u_password').value.trim()
    const errBox=$('msgErrUser'), okBox=$('msgOkUser')

    function showErrUser(t){ errBox.textContent=t; errBox.style.display='block'; okBox.style.display='none' }
    function showOkUser(t){ okBox.textContent=t; okBox.style.display='block'; errBox.style.display='none' }

    if(!email || !branch_code){ showErrUser('Email & cabang wajib'); return }
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){ showErrUser('Format email tidak valid'); return }
    if(password && password.length < 6){ showErrUser('Password minimal 6 karakter'); return }

    const sess = await supabase.auth.getSession()
    const session = sess && sess.data ? sess.data.session : null
    if(!session){ showErrUser('Session habis, login ulang'); return }

    try{
      const res = await fetch(FUNC_CREATE_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization': 'Bearer '+session.access_token },
        body: JSON.stringify({ email, full_name, role, branch_code, password: password || undefined })
      })
      const out = await res.json()
      if(!res.ok){ showErrUser(out.error || 'Gagal membuat user'); return }
      var msg = 'User berhasil dibuat.'
      if(out.temp_password){ msg += ' Password sementara: '+out.temp_password }
      if(out.reset_link){ msg += ' | Reset link: '+out.reset_link }
      showOkUser(msg)
      await loadUsers(); renderUsers()
      setTimeout(function(){ closeModal('modalUser') }, 1400)
    }catch(e){
      showErrUser('Network error: '+ e.message)
    }
  })

  // Edit User - delegasi klik (tanpa TypeScript)
  $('usersList').addEventListener('click', function(e){
    var target = e.target;
    if(!(target instanceof Element)) return;
    var btn = target.closest('[data-edit]');
    if(!btn) return;
    var id = btn.getAttribute('data-edit');
    var u = (users||[]).find(function(x){ return x.id === id });
    if(!u) return;
    $('e_id').value = u.id;
    $('e_name').value = u.full_name || '';
    $('e_email').value = u.email || '';
    $('e_role').value = u.role || 'kasir';
    $('e_branch').value = u.branch_code || '';
    $('msgErrEdit').style.display='none'; $('msgOkEdit').style.display='none';
    openModal('modalEdit');
  });

  $('btnCloseEdit').onclick = function(){ closeModal('modalEdit') }
  $('btnCancelEdit').onclick = function(){ closeModal('modalEdit') }

  $('btnSaveEdit').addEventListener('click', async function(){
    const id = $('e_id').value;
    const full_name = $('e_name').value.trim();
    const role = $('e_role').value;
    const branch_code = $('e_branch').value;
    const errBox=$('msgErrEdit'), okBox=$('msgOkEdit')

    function showErrEdit(t){ errBox.textContent=t; errBox.style.display='block'; okBox.style.display='none' }
    function showOkEdit(t){ okBox.textContent=t; okBox.style.display='block'; errBox.style.display='none' }

    if(!id){ showErrEdit('User tidak ditemukan'); return }
    if(!branch_code){ showErrEdit('Cabang wajib diisi'); return }

    const sess = await supabase.auth.getSession()
    const session = sess && sess.data ? sess.data.session : null
    if(!session){ showErrEdit('Session habis, login ulang'); return }

    try{
      const res = await fetch(FUNC_UPDATE_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization': 'Bearer '+session.access_token },
        body: JSON.stringify({ user_id:id, full_name, role, branch_code })
      })
      const out = await res.json()
      if(!res.ok){ showErrEdit(out.error || 'Gagal menyimpan perubahan'); return }
      showOkEdit('Perubahan disimpan')
      await loadUsers(); renderUsers()
      setTimeout(function(){ closeModal('modalEdit') }, 900)
    }catch(e){
      showErrEdit('Network error: '+ e.message)
    }
  })

  // Logout
  $('lnk-logout').addEventListener('click', async function(){
    await supabase.auth.signOut(); location.href="login.html"
  })

  boot()
</script>
</body>
</html>
