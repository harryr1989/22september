<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Manajemen Pengguna | AMKO</title>
  <style>
    :root{
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --muted:#64748b; --txt:#0f172a;
      --blue:#1d4ed8; --amber:#d97706; --green:#16a34a; --red:#be123c; --gray:#64748b;
      --shadow:0 6px 18px rgba(15,23,42,.08); --touch:48px; --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt)}
    button,input,select,textarea{font-family:inherit}

    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px}
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--pri);color:#fff}
    header{position:sticky;top:0;z-index:9;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .content{padding:16px;max-width:1100px;margin:0 auto}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f9fafb;font-size:12px}

    .section{margin-top:16px}
    .section h3{margin:0 0 10px 0;font-size:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:18px;box-shadow:var(--shadow);padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;height:44px;outline:none}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:44px}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .rowcard{display:grid;grid-template-columns:200px 1fr 120px 140px 120px;gap:8px;align-items:center;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:10px}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:800;color:#fff}
    .badge-owner{background:#0ea5e9}
    .badge-admin{background:#22c55e}
    .badge-kasir{background:#d97706}
    .muted{color:#64748b}

    @media (max-width: 840px){
      .layout{grid-template-columns:1fr}
      .sidebar{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:10}
      .brand{margin:0}
      .content{padding:12px}
      .row{grid-template-columns:1fr}
      .rowcard{grid-template-columns:1fr;gap:6px}
    }
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="brand">AMKO</div>
    <nav class="nav" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="master-saldo-akun.html">üí≥ Master Akun</a>
      <a href="transaksi-mini-atm.html">üèß Mini ATM</a>
      <a class="active" href="manajemen-pengguna.html">‚öôÔ∏è Manajemen</a>
      <a href="#" id="lnk-logout">üö™ Logout</a>
    </nav>
  </aside>

  <div>
    <header>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Manajemen Pengguna</h2>
        <span class="pill">Owner bisa tambah user langsung (tanpa undangan)</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="me" class="pill">memuat‚Ä¶</div>
        <div id="roleBadge" class="pill">role: ‚Ä¶</div>
        <div id="branchBadge" class="pill">branch: ‚Ä¶</div>
      </div>
    </header>

    <div class="content">
      <!-- CABANG -->
      <div class="section">
        <h3>Cabang</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qBranch" class="input" placeholder="Cari cabang‚Ä¶"/>
            <button id="btnAddBranch" class="btn btn-primary">+ Tambah Cabang</button>
          </div>
          <div id="branchesWrap">
            <table class="table">
              <tbody id="branchesBody"></tbody>
            </table>
            <div id="noBranch" class="muted" style="padding:8px 2px;display:none">Belum ada cabang.</div>
          </div>
        </div>
      </div>

      <!-- USER -->
      <div class="section">
        <h3>Pengguna</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qUser" class="input" placeholder="Cari nama / email‚Ä¶"/>
            <select id="fltBranch" class="input">
              <option value="">Semua cabang</option>
            </select>
            <select id="fltRole" class="input">
              <option value="">Semua role</option>
              <option value="owner">owner</option>
              <option value="admin">admin</option>
              <option value="kasir">kasir</option>
            </select>
            <button id="btnAddUser" class="btn btn-ghost">+ Tambah User</button>
          </div>

          <div id="usersList" style="display:grid;gap:8px"></div>
          <div id="noUser" class="muted" style="padding:8px 2px;display:none">Belum ada pengguna.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Tambah Cabang -->
<div class="modal" id="modalBranch" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,.45);align-items:center;justify-content:center;padding:12px;z-index:50">
  <div class="dialog" style="width:min(560px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column">
    <div class="dlg-hd" style="background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center">
      <span>Tambah Cabang</span>
      <button class="btn btn-ghost" id="btnCloseBranch">‚úñ</button>
    </div>
    <div class="dlg-bd" style="padding:14px;display:grid;gap:12px">
      <div id="msgErrBranch" class="error" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px"></div>
      <div id="msgOkBranch" class="ok" style="display:none;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:10px"></div>
      <div>
        <label>Nama Cabang</label>
        <div class="icon-input" style="display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff">
          <span>üè¢</span><input id="b_name" placeholder="Contoh: Cabang Samarinda" style="border:none;outline:none;flex:1;font-size:15px;background:transparent"/>
        </div>
      </div>
      <div>
        <label>Kode Cabang (unik, tanpa spasi)</label>
        <div class="icon-input" style="display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff">
          <span>#</span><input id="b_code" placeholder="Contoh: SMR01" style="border:none;outline:none;flex:1;font-size:15px;background:transparent"/>
        </div>
      </div>
    </div>
    <div class="dlg-ft" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--bd);background:#fafafa">
      <button class="btn" id="btnCancelBranch">Batal</button>
      <button class="btn btn-primary" id="btnSaveBranch">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Tambah User -->
<div class="modal" id="modalUser" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,.45);align-items:center;justify-content:center;padding:12px;z-index:50">
  <div class="dialog" style="width:min(560px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column">
    <div class="dlg-hd" style="background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center">
      <span>Tambah User (Owner)</span>
      <button class="btn btn-ghost" id="btnCloseUser">‚úñ</button>
    </div>
    <div class="dlg-bd" style="padding:14px;display:grid;gap:12px">
      <div class="error" id="msgErrUser" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px"></div>
      <div class="ok" id="msgOkUser" style="display:none;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:10px"></div>

      <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Nama Lengkap</label>
          <div class="icon-input" style="display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff">
            <span>üë§</span><input id="u_name" placeholder="Nama" style="border:none;outline:none;flex:1;font-size:15px;background:transparent"/>
          </div>
        </div>
        <div>
          <label>Email</label>
          <div class="icon-input" style="display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff">
            <span>‚úâÔ∏è</span><input id="u_email" placeholder="email@contoh.com" style="border:none;outline:none;flex:1;font-size:15px;background:transparent"/>
          </div>
        </div>
      </div>

      <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Role</label>
          <div class="icon-input" style="display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff">
            <select id="u_role" style="border:none;outline:none;flex:1;font-size:15px;background:transparent">
              <option value="kasir">kasir</option>
              <option value="admin">admin</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div>
          <label>Cabang</label>
          <div class="icon-input" style="display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff">
            <select id="u_branch" style="border:none;outline:none;flex:1;font-size:15px;background:transparent"></select>
          </div>
        </div>
      </div>

      <div>
        <label>Password (opsional)</label>
        <div class="icon-input" style="display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff">
          <span>üîë</span><input id="u_password" placeholder="Minimal 6 karakter (atau kosongkan ‚Üí auto generate)" style="border:none;outline:none;flex:1;font-size:15px;background:transparent" />
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px">Jika dikosongkan, sistem akan membuat password sementara & menampilkan ke kamu. Ada juga link reset password untuk user.</div>
      </div>
    </div>
    <div class="dlg-ft" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--bd);background:#fafafa">
      <button class="btn" id="btnCancelUser">Tutup</button>
      <button class="btn btn-primary" id="btnSaveUser">Simpan</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  // Project kamu
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4QyI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  // URL Edge Function
  const FUNC_URL = "https://kfqcdcvcnyhisbmwftzb.functions.supabase.co/admin-create-user";

  const $ = (id)=>document.getElementById(id)
  let gRole=null, gBranch=null
  let branches=[], users=[]

  function openModal(id){ $(id).style.display='flex' }
  function closeModal(id){ $(id).style.display='none' }
  const showErr = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},3500) }
  const showOk  = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},2500) }
  const pill = (r)=> r==='owner' ? 'badge-owner' : (r==='admin'?'badge-admin':'badge-kasir')

  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }
    const { data: prof, error } = await supabase.from('profiles').select('id,full_name,email,role,branch_code').eq('id', session.user.id).single()
    if(error){ alert('Gagal ambil profil: '+error.message); return }
    gRole = prof.role; gBranch = prof.branch_code
    $('me').textContent = `${prof.full_name || prof.email}`
    $('roleBadge').textContent = `role: ${prof.role}`
    $('branchBadge').textContent = `branch: ${prof.branch_code}`

    if(gRole!=='owner'){ $('btnAddBranch').style.display='none' } // hanya owner

    await Promise.all([loadBranches(), loadUsers()])
    renderBranches(); renderUsers(); fillBranchFilters()
  }

  async function loadBranches(){
    let q = supabase.from('branches').select('id,code,name')
    if(gRole!=='owner') q = q.eq('code', gBranch)
    const { data } = await q.order('name'); branches = data||[]
  }

  async function loadUsers(){
    let q = supabase.from('profiles').select('id,full_name,email,role,branch_code')
    if(gRole!=='owner') q = q.eq('branch_code', gBranch)
    const { data } = await q.order('full_name', { nullsFirst:true }); users = data||[]
  }

  function renderBranches(){
    const q = $('qBranch').value.trim().toLowerCase()
    const list = (branches||[]).filter(b => !q || (b.name||'').toLowerCase().includes(q) || (b.code||'').toLowerCase().includes(q))
    $('branchesBody').innerHTML = list.map(b=>`
      <tr><td>
        <div class="rowcard">
          <div><strong>${b.name}</strong></div>
          <div class="muted">Kode: ${b.code}</div>
          <div>${(users||[]).filter(u=>u.branch_code===b.code).length} user</div>
          <div></div><div style="text-align:right"><span class="muted">-</span></div>
        </div>
      </td></tr>`).join('')
    $('noBranch').style.display = list.length ? 'none' : 'block'
  }

  function renderUsers(){
    const q = $('qUser').value.trim().toLowerCase()
    const fB = $('fltBranch').value
    const fR = $('fltRole').value
    const list = (users||[]).filter(u=>{
      if(q && !((u.full_name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q))) return false
      if(fB && u.branch_code!==fB) return false
      if(fR && u.role!==fR) return false
      return true
    })
    $('usersList').innerHTML = list.map(u=>`
      <div class="rowcard">
        <div><strong>${u.full_name || '-'}</strong></div>
        <div class="muted">${u.email||'-'}</div>
        <div><span class="badge ${pill(u.role)}">${u.role}</span></div>
        <div><span class="pill">branch: ${u.branch_code||'-'}</span></div>
        <div style="text-align:right"><button class="btn btn-ghost" disabled>Detail</button></div>
      </div>`).join('')
    $('noUser').style.display = list.length ? 'none' : 'block'
  }

  function fillBranchFilters(){
    const sel = $('fltBranch'); const sel2 = $('u_branch')
    sel.innerHTML = ['<option value="">Semua cabang</option>'].concat((branches||[]).map(b=>`<option value="${b.code}">${b.name} (${b.code})</option>`)).join('')
    sel2.innerHTML = (branches||[]).map(b=>`<option value="${b.code}">${b.name} (${b.code})</option>`).join('')
    sel2.value = gBranch || ''
  }

  // Events
  $('qBranch').addEventListener('input', renderBranches)
  $('qUser').addEventListener('input', renderUsers)
  $('fltBranch').addEventListener('change', renderUsers)
  $('fltRole').addEventListener('change', renderUsers)

  // Cabang modal (opsional ‚Äî sama seperti sebelumnya)
  $('btnAddBranch').addEventListener('click', ()=>{ $('b_name').value=''; $('b_code').value=''; $('msgErrBranch').style.display='none'; $('msgOkBranch').style.display='none'; openModal('modalBranch') })
  $('btnCloseBranch').onclick = ()=>closeModal('modalBranch')
  $('btnCancelBranch').onclick = ()=>closeModal('modalBranch')
  $('btnSaveBranch').addEventListener('click', async ()=>{
    if(gRole!=='owner'){ alert('Hanya Owner'); return }
    const name = $('b_name').value.trim(); const code = $('b_code').value.trim()
    if(!name || !code) { showErr($('msgErrBranch'),'Nama & Kode wajib'); return }
    if(/\s/.test(code)) { showErr($('msgErrBranch'),'Kode tanpa spasi'); return }
    const { data:exist, error:errChk } = await supabase.from('branches').select('id').eq('code', code).maybeSingle()
    if(errChk){ showErr($('msgErrBranch'),'Cek kode: '+errChk.message); return }
    if(exist){ showErr($('msgErrBranch'),'Kode sudah dipakai'); return }
    const { error } = await supabase.from('branches').insert({ name, code })
    if(error){ showErr($('msgErrBranch'),'Gagal tambah: '+error.message); return }
    showOk($('msgOkBranch'),'Cabang ditambahkan'); await loadBranches(); renderBranches(); fillBranchFilters(); setTimeout(()=>closeModal('modalBranch'), 700)
  })

  // Tambah user (panggil Edge Function)
  $('btnAddUser').addEventListener('click', ()=>{
    if(gRole!=='owner'){ alert('Hanya Owner'); return }
    $('u_name').value=''; $('u_email').value=''; $('u_role').value='kasir'; $('u_branch').value=gBranch||''; $('u_password').value=''
    $('msgErrUser').style.display='none'; $('msgOkUser').style.display='none'
    openModal('modalUser')
  })
  $('btnCloseUser').onclick = ()=>closeModal('modalUser')
  $('btnCancelUser').onclick = ()=>closeModal('modalUser')

  $('btnSaveUser').addEventListener('click', async ()=>{
    if(gRole!=='owner'){ alert('Hanya Owner'); return }
    const full_name = $('u_name').value.trim()
    const email = $('u_email').value.trim().toLowerCase()
    const role = $('u_role').value
    const branch_code = $('u_branch').value
    const password = $('u_password').value.trim()
    const errBox=$('msgErrUser'), okBox=$('msgOkUser')
    const showErrUser = (t)=>{ errBox.textContent=t; errBox.style.display='block'; okBox.style.display='none' }
    const showOkUser  = (t)=>{ okBox.textContent=t; okBox.style.display='block'; errBox.style.display='none' }

    if(!email || !branch_code){ showErrUser('Email & cabang wajib'); return }
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){ showErrUser('Format email tidak valid'); return }
    if(password && password.length < 6){ showErrUser('Password minimal 6 karakter'); return }

    // Token session utk Authorization Bearer
    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ showErrUser('Session habis, login ulang'); return }

    try{
      const res = await fetch(FUNC_URL, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization': `Bearer ${session.access_token}`
        },
        body: JSON.stringify({ email, full_name, role, branch_code, password: password || undefined })
      })
      const out = await res.json()
      if(!res.ok){
        showErrUser(out.error || 'Gagal membuat user'); return
      }
      let msg = 'User berhasil dibuat.'
      if(out.temp_password){ msg += ` Password sementara: ${out.temp_password}` }
      if(out.reset_link){ msg += ` | Link reset: ${out.reset_link}` }
      showOkUser(msg)
      await loadUsers(); renderUsers()
      setTimeout(()=>closeModal('modalUser'), 1400)
    }catch(e){
      showErrUser('Network error: '+ e.message)
    }
  })

  // Logout
  $('lnk-logout').addEventListener('click', async ()=>{
    await supabase.auth.signOut(); location.href="login.html"
  })

  boot()
</script>
</body>
</html>
