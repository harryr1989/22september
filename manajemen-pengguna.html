<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Manajemen Pengguna | Amko MiniLink (v1.2)</title>
  <style>
    :root{
      --bg:#f6f8fb; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --muted:#64748b; --txt:#0f172a;
      --shadow:0 6px 18px rgba(15,23,42,.08);
      --sidebar-w:240px;

      /* Sidebar selaras */
      --sb:#0f172a;        /* latar sidebar */
      --sbfg:#e5e7eb;      /* teks menu */
      --sb-brand:#0a5eb6;  /* bar brand */
      --sb-active:#0b3a66; /* item aktif */
      --accent:#38bdf8;    /* garis aktif kiri */
      --success:#16a34a;
      --danger:#dc2626;
      --toast-bg:#0b1220;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt)}
    button,input,select,textarea{font-family:inherit}

    /* ===== Layout ===== */
    .layout{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100vh}

    /* ===== Sidebar (gaya baru selaras) ===== */
    .sidebar{
      background:var(--sb);color:var(--sbfg);
      display:flex;flex-direction:column;
      padding:0; position:relative;z-index:20;
      transition:left .25s ease;
    }
    .brand{background:var(--sb-brand);color:#fff;font-weight:800;font-size:15px;padding:12px 14px;margin:0;}
    .nav{padding:6px;display:flex;flex-direction:column;gap:0;overflow:auto}
    .nav a{
      display:flex;align-items:center;gap:8px;
      text-decoration:none;color:var(--sbfg);
      font-size:13px;font-weight:500;
      padding:8px 10px;border-radius:8px;line-height:1.2;position:relative
    }
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--sb-active);color:#fff;}
    .nav a.active::before{content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:3px; background:var(--accent);}

    .group{margin-top:6px;border:1px solid rgba(255,255,255,.08);border-radius:8px;overflow:hidden;}
    .group-hd{padding:8px 10px;background:#0e223a;color:#cfe0f3;font-size:12px;font-weight:500;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
    .group-hd .chev{transition:transform .2s ease}
    .group.collapsed .group-hd .chev{transform:rotate(-90deg)}
    .group-bd{padding:6px;background:#0f253f}
    .group.collapsed .group-bd{display:none}

    .sidebar-footer{margin-top:auto;padding:8px 8px 10px;font-size:11px;color:#93a3b8}
    .logout{display:block;margin-top:8px;background:#fecdd3;color:#7f1d1d;text-align:center;border-radius:10px;padding:9px 10px;font-weight:800;text-decoration:none}

    /* ===== Header / Content ===== */
    header{position:sticky;top:0;z-index:9;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .content{padding:16px;max-width:1100px;margin:0 auto; padding-bottom:64px}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f9fafb;font-size:12px;white-space:nowrap}

    .section{margin-top:16px}
    .section h3{margin:0 0 10px 0;font-size:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:18px;box-shadow:var(--shadow);padding:14px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;height:44px;outline:none;min-width:0}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:800;height:44px;white-space:nowrap;font-size:15px}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b}
    .btn[aria-busy="true"]{position:relative;pointer-events:none;opacity:.8}
    .btn[aria-busy="true"]::after{
      content:""; position:absolute; right:10px; top:50%; width:16px; height:16px; transform:translateY(-50%);
      border:2px solid rgba(255,255,255,.6); border-left-color:transparent; border-radius:50%;
      animation:spin .9s linear infinite;
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
    .rowcard{
      display:grid;
      grid-template-columns: minmax(160px,1.2fr) minmax(140px,1fr) minmax(110px,.7fr) minmax(160px,1fr) minmax(220px,1fr);
      gap:8px;align-items:center;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:10px;min-width:0
    }
    .rowcard + .rowcard{margin-top:6px}
    .rowcard > *{min-width:0}
    .rowcard strong, .rowcard .muted, .rowcard span, .rowcard div{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .muted{color:#64748b}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:800;color:#fff}
    .badge-owner{background:#0ea5e9}
    .badge-admin{background:#22c55e}
    .badge-kasir{background:#d97706}
    .actions{display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap}
    .actions .btn{height:36px;padding:8px 10px;border-radius:10px}

    /* ===== Modal ===== */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:50;opacity:0}
    .modal.show{display:flex;opacity:1}
    .dialog{width:min(560px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:92vh; transform:translateY(10px); opacity:0}
    .modal.show .dialog{animation:fadeInUp .22s ease forwards}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px;overflow:auto}
    .dlg-ft{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--bd);background:#fafafa}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    .icon-input{display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff}
    .icon-input input,.icon-input select{border:none;outline:none;flex:1;font-size:15px;background:transparent;min-width:0}
    .error{display:none;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px}
    .ok{display:none;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:10px}

    /* ===== Toast ===== */
    .toast{position:fixed; right:16px; bottom:16px; z-index:60; display:flex; flex-direction:column; gap:8px;}
    .toast-item{background:var(--toast-bg); color:#e5e7eb; border:1px solid #1f2937; padding:10px 14px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.18); animation:toastIn .25s ease forwards; font-size:14px; max-width:min(420px, 90vw);}
    .toast-item.success{ border-color:#14532d; color:#dcfce7 }
    .toast-item.error{ border-color:#7f1d1d; color:#fee2e2 }

    /* ===== Loader ===== */
    .loader{display:inline-block; width:18px; height:18px; border:3px solid #cbd5e1; border-left-color:transparent; border-radius:50%; animation:spin .9s linear infinite}
    .loading-line{height:12px; background:#eef2f7; border-radius:6px; animation:pulse 1.2s ease-in-out infinite}
    .skeleton-card{border:1px solid var(--bd); border-radius:12px; padding:10px; background:#fff}
    .skeleton-grid{display:grid; gap:8px}

    /* ===== Hamburger & Overlay ===== */
    .hamburger{font-size:22px;background:none;border:none;cursor:pointer;padding:8px;display:none}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.45);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:19}
    .overlay.show{opacity:1;pointer-events:auto}
    body.noscroll{overflow:hidden}

    /* ===== Responsive (‚â§980px): sidebar off-canvas) ===== */
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .sidebar{ position:fixed; left:calc(-1 * var(--sidebar-w)); top:0; bottom:0; width:var(--sidebar-w); }
      .sidebar.open{ left:0; }
      .hamburger{ display:block; }
      .content{padding:12px}
      .row{grid-template-columns:1fr}
      .rowcard{grid-template-columns:1fr;gap:6px}
      .toolbar{gap:6px}
    }

    /* ===== Animations ===== */
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
    @keyframes fadeInUp{from{opacity:0; transform:translateY(10px)}to{opacity:1; transform:translateY(0)}}
    @keyframes toastIn{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:translateY(0)}}
  </style>

<script>
// v1.6 add Edge Function constant
const FUNC_DELETE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/delete_user";
</script>
</head>
<body>
<div class="layout">
  <!-- ===== Sidebar (baru) ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Amko MiniLink</div>

    <nav class="nav">
      <!-- Menu utama -->
      <a href="dashboard.html">üìä Dashboard</a>
      <a href="transaksi-mini-atm.html">üßÆ Transaksi Mini ATM</a>

      <!-- Grup MASTER DATA -->
      <div class="group" data-key="grp_master">
        <div class="group-hd">
          <span>üìÇ Master Data</span>
          <span class="chev">‚ñæ</span>
        </div>
        <div class="group-bd">
          <a href="master-saldo-akun.html">üí∞ Master Saldo Akun</a>
          <a href="mutasi-saldo.html">üîÑ Mutasi Saldo</a>
          <a href="saldo-real.html">üìë Saldo Real</a>
        </div>
      </div>

      <!-- Grup LAPORAN -->
      <div class="group" data-key="grp_laporan">
        <div class="group-hd">
          <span>üìò Laporan</span>
          <span class="chev">‚ñæ</span>
        </div>
        <div class="group-bd">
          <a href="laporan.html">üìò Laporan MiniLink</a>
        </div>
      </div>

      <!-- Grup PENGATURAN -->
      <div class="group" data-key="grp_pengaturan">
        <div class="group-hd">
          <span>‚öôÔ∏è Pengaturan</span>
          <span class="chev">‚ñæ</span>
        </div>
        <div class="group-bd">
          <a class="active" href="manajemen-pengguna.html">üë• Manajemen Pengguna</a>
          <a href="hak-akses.html">üîë Hak Akses</a>
          <a href="absensi.html">üïí Absensi</a>
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      ¬© Amko MiniLink ‚Ä¢ v1.2
      <a href="#" id="lnk-logout" class="logout">üö™ Logout</a>
    </div>
  </aside>

  <!-- Overlay untuk mobile -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- ===== Main ===== -->
  <div>
    <header>
      <!-- Tombol hamburger -->
      <button id="toggleSidebar" class="hamburger" aria-label="Toggle Sidebar" aria-controls="sidebar" aria-expanded="false">‚ò∞</button>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Manajemen Pengguna</h2>
        <span class="pill">Tambah ‚Ä¢ Edit ‚Ä¢ Reset Password ‚Ä¢ Aktif/Nonaktif ‚Ä¢ Kelola Cabang ‚Ä¢ Hapus User</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="me" class="pill">memuat‚Ä¶</div>
        <div id="roleBadge" class="pill">role: ‚Ä¶</div>
        <div id="branchBadge" class="pill">branch: ‚Ä¶</div>
      </div>
    </header>

    <div class="content">
      <!-- CABANG -->
      <div class="section">
        <h3>Cabang</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qBranch" class="input" placeholder="Cari cabang‚Ä¶"/>
            <button id="btnAddBranch" class="btn btn-primary">+ Tambah Cabang</button>
            <span id="loadingBranches" class="pill" style="display:none"><span class="loader"></span> &nbsp;Memuat cabang‚Ä¶</span>
          </div>
          <div id="branchesWrap">
            <div id="branchesList" style="display:grid;gap:8px"></div>
            <div id="noBranch" class="muted" style="padding:8px 2px;display:none">Belum ada cabang.</div>
          </div>
        </div>
      </div>

      <!-- USER -->
      <div class="section">
        <h3>Pengguna</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qUser" class="input" placeholder="Cari nama / email‚Ä¶"/>
            <select id="fltBranch" class="input">
              <option value="">Semua cabang</option>
            </select>
            <select id="fltRole" class="input">
              <option value="">Semua role</option>
              <option value="owner">owner</option>
              <option value="admin">admin</option>
              <option value="kasir">kasir</option>
            </select>
            <button id="btnAddUser" class="btn btn-ghost">+ Tambah User</button>
            <span id="loadingUsers" class="pill" style="display:none"><span class="loader"></span> &nbsp;Memuat pengguna‚Ä¶</span>
          </div>

          <div id="usersList" style="display:grid;gap:8px"></div>
          <div id="noUser" class="muted" style="padding:8px 2px;display:none">Belum ada pengguna.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Tambah Cabang -->
<div class="modal" id="modalBranch" aria-hidden="true" role="dialog" aria-labelledby="titleBranch">
  <div class="dialog">
    <div class="dlg-hd">
      <span id="titleBranch">Tambah Cabang</span>
      <button class="btn btn-ghost" id="btnCloseBranch" aria-label="Tutup">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div id="msgErrBranch" class="error"></div>
      <div id="msgOkBranch" class="ok"></div>

      <input type="hidden" id="b_id"/>
      <div>
        <label>Nama Cabang</label>
        <div class="icon-input">
          <span>üè¢</span>
          <input id="b_name" placeholder="Contoh: Cabang Samarinda"/>
        </div>
      </div>
      <div>
        <label>Kode Cabang (unik, tanpa spasi)</label>
        <div class="icon-input">
          <span>#</span>
          <input id="b_code" placeholder="Contoh: SMR01"/>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelBranch">Batal</button>
      <button class="btn btn-primary" id="btnSaveBranch">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Hapus Cabang -->
<div class="modal" id="modalDelBranch" aria-hidden="true" role="dialog">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Hapus Cabang</span>
      <button class="btn btn-ghost" id="btnCloseDelBranch" aria-label="Tutup">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrDelBranch" style="display:none"></div>
      <p id="delText" style="margin:0">Yakin ingin menghapus cabang ini?</p>
      <input type="hidden" id="del_id"/>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelDelBranch">Batal</button>
      <button class="btn btn-danger" id="btnDoDelBranch">Hapus</button>
    </div>
  </div>
</div>

<!-- MODAL: Tambah User -->
<div class="modal" id="modalUser" aria-hidden="true" role="dialog">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Tambah User</span>
      <button class="btn btn-ghost" id="btnCloseUser" aria-label="Tutup">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrUser"></div>
      <div class="ok" id="msgOkUser"></div>

      <div class="row">
        <div>
          <label>Nama Lengkap</label>
          <div class="icon-input">
            <span>üë§</span>
            <input id="u_name" placeholder="Nama"/>
          </div>
        </div>
        <div>
          <label>Email</label>
          <div class="icon-input">
            <span>‚úâÔ∏è</span>
            <input id="u_email" placeholder="email@contoh.com"/>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Role</label>
          <div class="icon-input">
            <select id="u_role">
              <option value="kasir">kasir</option>
              <option value="admin">admin</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div id="wrap_u_branch">
          <label>Cabang</label>
          <div class="icon-input">
            <select id="u_branch"></select>
          </div>
        </div>
      </div>

      <div>
        <label>Password (opsional)</label>
        <div class="icon-input">
          <span>üîë</span>
          <input id="u_password" placeholder="Minimal 6 karakter (atau kosongkan ‚Üí auto-generate)"/>
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px">Kosongkan bila ingin password sementara & reset link.</div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelUser">Tutup</button>
      <button class="btn btn-primary" id="btnSaveUser">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Edit User -->
<div class="modal" id="modalEdit" aria-hidden="true" role="dialog">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Edit User</span>
      <button class="btn btn-ghost" id="btnCloseEdit" aria-label="Tutup">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrEdit"></div>
      <div class="ok" id="msgOkEdit"></div>

      <input type="hidden" id="e_id"/>

      <div class="row">
        <div>
          <label>Nama Lengkap</label>
          <div class="icon-input">
            <span>üë§</span>
            <input id="e_name" placeholder="Nama"/>
          </div>
        </div>
        <div>
          <label>Email (read-only)</label>
          <div class="icon-input">
            <span>‚úâÔ∏è</span>
            <input id="e_email" placeholder="email@contoh.com" readonly/>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Role</label>
          <div class="icon-input">
            <select id="e_role">
              <option value="kasir">kasir</option>
              <option value="admin">admin</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div id="wrap_e_branch">
          <label>Cabang</label>
          <div class="icon-input">
            <select id="e_branch"></select>
          </div>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelEdit">Tutup</button>
      <button class="btn btn-primary" id="btnSaveEdit">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Hapus User -->
<div class="modal" id="modalDelUser" aria-hidden="true" role="dialog">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Hapus User</span>
      <button class="btn btn-ghost" id="btnCloseDelUser" aria-label="Tutup">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrDelUser" style="display:none"></div>
      <p id="delUserText" style="margin:0">Yakin ingin menghapus user ini?</p>
      <input type="hidden" id="del_user_id"/>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelDelUser">Batal</button>
      <button class="btn btn-danger" id="btnDoDelUser">Hapus</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast" id="toast"></div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  /* ===== Supabase (frontend pakai ANON) ===== */
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  /* ===== Edge Functions ===== */
  const FUNC_CREATE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/clever-processor";
  const FUNC_UPDATE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/super-endpoint";
  const FUNC_RESET_URL  = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/admin-reset-password";
  const FUNC_TOGGLE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/admin-set-user-active";

  const $ = (id)=>document.getElementById(id)
  const showErr = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},3500) }
  const showOk  = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},2500) }
  const pill = (r)=> r==='owner' ? 'badge-owner' : (r==='admin'?'badge-admin':'badge-kasir')

  /* ===== Toast ===== */
  function showToast(msg, type='info'){
    const box = $('toast');
    const item = document.createElement('div');
    item.className = 'toast-item '+(type==='success'?'success':(type==='error'?'error':''));
    item.textContent = msg;
    box.appendChild(item);
    setTimeout(()=>{ item.style.opacity='0'; item.style.transform='translateY(6px)'; }, 2200);
    setTimeout(()=>{ item.remove(); }, 2600);
  }

  /* ===== Busy state helper ===== */
  function setBusy(btn, busy=true){
    if(!btn) return;
    btn.setAttribute('aria-busy', busy?'true':'false');
    btn.disabled = !!busy;
  }

  /* ===== Loading helper ===== */
  function setLoadingList(targetId, isLoading){
    const el = $(targetId);
    if(!el) return;
    if(isLoading){
      el.innerHTML = '<div class="skeleton-grid">'+
        '<div class="skeleton-card"><div class="loading-line" style="width:60%"></div></div>'+
        '<div class="skeleton-card"><div class="loading-line" style="width:45%"></div></div>'+
        '<div class="skeleton-card"><div class="loading-line" style="width:70%"></div></div>'+
      '</div>';
    }
  }

  let gRole=null, gBranch=null
  let branches=[], users=[]

  function openModal(id){
    const el = $(id);
    if(!el) return;
    el.classList.add('show');
    el.style.display='flex';
    el.setAttribute('aria-hidden','false');
  }
  function closeModal(id){
    const el = $(id);
    if(!el) return;
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
    setTimeout(()=>{ el.style.display='none' }, 150);
  }

  // ==== Sembunyikan field cabang saat role=owner ====
  function applyBranchFieldByRole(roleSelId, branchWrapId, branchSelId){
    const roleSel = $(roleSelId)
    const brWrap  = $(branchWrapId)
    const brSel   = $(branchSelId)
    if(!roleSel || !brWrap) return
    if(roleSel.value === 'owner'){
      brWrap.style.display = 'none'
      if(brSel) brSel.value = ''
    }else{
      brWrap.style.display = ''
      if(roleSelId==='u_role' && brSel && !brSel.value){
        brSel.value = gBranch || (branches[0]?.code || '')
      }
    }
  }

  // ===== Boot =====
  async function boot(){
    $('loadingBranches').style.display = 'inline-flex';
    $('loadingUsers').style.display = 'inline-flex';
    setLoadingList('branchesList', true);
    setLoadingList('usersList', true);

    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }

    const { data: prof, error } = await supabase
      .from('profiles').select('id,full_name,email,role,branch_code')
      .eq('id', session.user.id).single()
    if(error){ showToast('Gagal ambil profil: '+error.message, 'error'); return }

    gRole = (prof.role||'').toLowerCase(); gBranch = prof.branch_code
    $('me').textContent = `${prof.full_name || prof.email}`
    $('roleBadge').textContent = `role: ${gRole}`
    $('branchBadge').textContent = `branch: ${prof.branch_code}`

    await Promise.all([loadBranches(), loadUsers()])
    renderBranches(); renderUsers(); fillBranchFilters()

    applyBranchFieldByRole('u_role','wrap_u_branch','u_branch')
    applyBranchFieldByRole('e_role','wrap_e_branch','e_branch')

    $('u_role').addEventListener('change', ()=> applyBranchFieldByRole('u_role','wrap_u_branch','u_branch'))
    $('e_role').addEventListener('change', ()=> applyBranchFieldByRole('e_role','wrap_e_branch','e_branch'))

    initSidebarToggler();
    initSidebarGroups();

    $('loadingBranches').style.display = 'none';
    $('loadingUsers').style.display = 'none';
  }

  // ===== Load data =====
  async function loadBranches(){
    setLoadingList('branchesList', true);
    const { data, error } = await supabase
      .from('branches')
      .select('id,code,name')
      .order('name');
    if(error){ console.error(error); branches=[]; showToast('Gagal memuat cabang','error'); return }
    branches = data || []
  }

  async function loadUsers(){
    setLoadingList('usersList', true);
    let q = supabase.from('profiles').select('id,full_name,email,role,branch_code,is_active')
    if(gRole!=='owner') q = q.eq('branch_code', gBranch)
    const { data, error } = await q.order('full_name', { nullsFirst:true })
    if(error){ console.error(error); users=[]; showToast('Gagal memuat pengguna','error'); return }
    users = data || []
  }

  // ===== Render =====
  function renderBranches(){
    const q = $('qBranch').value?.trim().toLowerCase() || ''
    const list = (branches||[]).filter(b => !q || (b.name||'').toLowerCase().includes(q) || (b.code||'').toLowerCase().includes(q))
    $('branchesList').innerHTML = list.map(b=>`
      <div class="rowcard">
        <div title="${b.name||''}"><strong>${b.name||'-'}</strong></div>
        <div class="muted">Kode: ${b.code||'-'}</div>
        <div>${(users||[]).filter(u=>u.branch_code===b.code).length} user</div>
        <div></div>
        <div class="actions">
          <button class="btn btn-ghost" data-bedit="${b.id}">Edit</button>
          <button class="btn btn-danger" data-bdel="${b.id}" data-bname="${(b.name||'').replace(/"/g,'&quot;')}">Hapus</button>
        </div>
      </div>
    `).join('')
    $('noBranch').style.display = list.length ? 'none' : 'block'
  }

  function renderUsers(){
    const q = $('qUser').value?.trim().toLowerCase() || ''
    const fB = $('fltBranch').value
    const fR = $('fltRole').value
    const list = (users||[]).filter(function(u){
      if(q && !((u.full_name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q))) return false
      if(fB && u.branch_code!==fB) return false
      if(fR && u.role!==fR) return false
      return true
    })
    $('usersList').innerHTML = list.map(function(u){
      const isActive = (u.is_active !== false)
      const statusPill = isActive
        ? '<span class="pill" style="border-color:#86efac;background:#ecfdf5;color:#166534">aktif</span>'
        : '<span class="pill" style="border-color:#fecaca;background:#fef2f2;color:#991b1b">nonaktif</span>';
      const toggleBtn = (gRole==='owner')
        ? `<button class="btn btn-ghost" data-toggle="${u.id}" data-enabled="${isActive ? '0' : '1'}">${isActive ? 'Nonaktifkan' : 'Aktifkan'}</button>`
        : '';
      const resetBtn = (gRole==='owner') ? `<button class="btn btn-ghost" data-reset="${u.id}">Reset PW</button>` : '';
      const delBtn = (gRole==='owner') ? `<button class="btn btn-danger" data-udel="${u.id}" data-uname="${(u.full_name||'').replace(/"/g,'&quot;')}" data-uemail="${(u.email||'').replace(/"/g,'&quot;')}">üóëÔ∏è Hapus</button>` : '';
      return `
        <div class="rowcard">
          <div title="${u.full_name||''}"><strong>${u.full_name || '-'}</strong></div>
          <div class="muted" title="${u.email||''}">${u.email||'-'}</div>
          <div><span class="badge ${pill(u.role)}">${u.role}</span></div>
          <div><span class="pill">branch: ${u.branch_code||'-'}</span> &nbsp; ${statusPill}</div>
          <div class="actions">
            <button class="btn btn-ghost" data-edit="${u.id}">Edit</button>
            ${resetBtn}
            ${toggleBtn}
            ${delBtn}
          </div>
        </div>`
    }).join('')
    $('noUser').style.display = list.length ? 'none' : 'block'
  }

  function fillBranchFilters(){
    const sel = $('fltBranch'); const selAdd = $('u_branch'); const selEdit = $('e_branch')
    sel.innerHTML = ['<option value="">Semua cabang</option>']
      .concat((branches||[]).map(b=> `<option value="${b.code}">${b.name} (${b.code})</option>`)).join('')
    const opts = (branches||[]).map(b=> `<option value="${b.code}">${b.name} (${b.code})</option>`).join('')
    selAdd.innerHTML = opts
    selEdit.innerHTML = opts
    selAdd.value = gBranch || ''

    applyBranchFieldByRole('u_role','wrap_u_branch','u_branch')
    applyBranchFieldByRole('e_role','wrap_e_branch','e_branch')
  }

  // ===== Events =====
  $('qBranch').addEventListener('input', renderBranches)
  $('qUser').addEventListener('input', renderUsers)
  $('fltBranch').addEventListener('change', renderUsers)
  $('fltRole').addEventListener('change', renderUsers)

  // Cabang: Tambah
  $('btnAddBranch').addEventListener('click', function(){
    $('titleBranch').textContent = 'Tambah Cabang'
    $('b_id').value = ''
    $('b_name').value=''; $('b_code').value='';
    $('msgErrBranch').style.display='none'; $('msgOkBranch').style.display='none';
    openModal('modalBranch')
  })
  $('btnCloseBranch').onclick = ()=> closeModal('modalBranch')
  $('btnCancelBranch').onclick = ()=> closeModal('modalBranch')

  // Cabang: Simpan (tambah / edit)
  $('btnSaveBranch').addEventListener('click', async function(){
    const btn = this;
    setBusy(btn, true);
    const id = $('b_id').value
    const name = $('b_name').value.trim()
    const code = $('b_code').value.trim()
    if(!name || !code){ showErr($('msgErrBranch'),'Nama & Kode wajib'); setBusy(btn,false); return }
    if(/\\s/.test(code)){ showErr($('msgErrBranch'),'Kode tanpa spasi'); setBusy(btn,false); return }

    const exist = await supabase.from('branches').select('id,code').eq('code', code).maybeSingle()
    if(exist.error && exist.error.code!=='PGRST116'){ showErr($('msgErrBranch'),'Cek kode: '+exist.error.message); setBusy(btn,false); return }
    if(exist.data && (!id || exist.data.id!==id)){ showErr($('msgErrBranch'),'Kode sudah dipakai'); setBusy(btn,false); return }

    let res
    if(id){ res = await supabase.from('branches').update({ name, code }).eq('id', id) }
    else  { res = await supabase.from('branches').insert({ name, code }) }
    if(res.error){ showErr($('msgErrBranch'), (id?'Gagal menyimpan: ':'Gagal tambah cabang: ')+res.error.message); setBusy(btn,false); return }
    showOk($('msgOkBranch'), id?'Perubahan disimpan':'Cabang ditambahkan')
    showToast(id?'Perubahan cabang disimpan':'Cabang baru ditambahkan','success')
    await loadBranches(); renderBranches(); fillBranchFilters()
    setBusy(btn,false);
    setTimeout(()=> closeModal('modalBranch'), 700)
  })

  // Cabang: Edit & Hapus
  $('branchesList').addEventListener('click', function(e){
    const t = e.target.closest('[data-bedit],[data-bdel]')
    if(!t) return
    if(t.hasAttribute('data-bedit')){
      const id = t.getAttribute('data-bedit')
      const b = (branches||[]).find(x=> x.id===id)
      if(!b) return
      $('titleBranch').textContent = 'Edit Cabang'
      $('b_id').value = b.id
      $('b_name').value = b.name || ''
      $('b_code').value = b.code || ''
      $('msgErrBranch').style.display='none'; $('msgOkBranch').style.display='none';
      openModal('modalBranch')
    }else if(t.hasAttribute('data-bdel')){
      const id = t.getAttribute('data-bdel')
      const nm = t.getAttribute('data-bname') || ''
      $('del_id').value = id
      $('msgErrDelBranch').style.display='none'
      $('delText').innerHTML = `Yakin ingin menghapus cabang <strong>${nm}</strong>?<br/>Data terkait (user/akun) bisa menghalangi penghapusan.`
      openModal('modalDelBranch')
    }
  })

  // Cabang: Konfirmasi Hapus
  $('btnCloseDelBranch').onclick = ()=> closeModal('modalDelBranch')
  $('btnCancelDelBranch').onclick = ()=> closeModal('modalDelBranch')
  $('btnDoDelBranch').addEventListener('click', async function(){
    const btn = this; setBusy(btn,true);
    const id = $('del_id').value
    if(!id){ setBusy(btn,false); return }
    const del = await supabase.from('branches').delete().eq('id', id)
    if(del.error){
      const box = $('msgErrDelBranch')
      box.textContent = 'Gagal hapus: '+ del.error.message + ' (Pastikan tidak ada user/akun yang masih pakai kode cabang ini)'
      box.style.display='block'
      showToast('Gagal menghapus cabang','error')
      setBusy(btn,false);
      return
    }
    await loadBranches(); renderBranches(); fillBranchFilters()
    showToast('Cabang dihapus','success')
    setBusy(btn,false);
    closeModal('modalDelBranch')
  })

  // Tambah User
  $('btnAddUser').addEventListener('click', function(){
    $('u_name').value=''; $('u_email').value='';
    $('u_role').value='kasir';
    $('u_branch').value = gBranch || (branches[0]?.code || '');
    $('u_password').value='';
    $('msgErrUser').style.display='none'; $('msgOkUser').style.display='none';
    applyBranchFieldByRole('u_role','wrap_u_branch','u_branch')
    openModal('modalUser')
  })
  $('btnCloseUser').onclick = ()=> closeModal('modalUser')
  $('btnCancelUser').onclick = ()=> closeModal('modalUser')

  // Simpan Tambah User
  $('btnSaveUser').addEventListener('click', async function(){
    const btn = this; setBusy(btn,true);
    const full_name = $('u_name').value.trim()
    const email = $('u_email').value.trim().toLowerCase()
    const role = $('u_role').value
    let branch_code = $('u_branch').value
    const password = $('u_password').value.trim()
    const errBox=$('msgErrUser'), okBox=$('msgOkUser')

    function showErrUser(t){ errBox.textContent=t; errBox.style.display='block'; okBox.style.display='none' }
    function showOkUser(t){ okBox.textContent=t; okBox.style.display='block'; errBox.style.display='none' }

    if(!email){ showErrUser('Email wajib'); setBusy(btn,false); return }
    if(role!=='owner' && !branch_code){ showErrUser('Cabang wajib untuk role non-owner'); setBusy(btn,false); return }
    if(!/^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$/.test(email)){ showErrUser('Format email tidak valid'); setBusy(btn,false); return }
    if(password && password.length < 6){ showErrUser('Password minimal 6 karakter'); setBusy(btn,false); return }

    if(role==='owner') branch_code = null

    const sess = await supabase.auth.getSession()
    const session = sess?.data?.session
    if(!session){ showErrUser('Session habis, login ulang'); setBusy(btn,false); return }

    try{
      const payload = { email, full_name, role }
      if(branch_code !== null) payload.branch_code = branch_code
      if(password) payload.password = password

      const res = await fetch(FUNC_CREATE_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization': 'Bearer '+session.access_token },
        body: JSON.stringify(payload)
      })
      const out = await res.json()
      if(!res.ok){ showErrUser(out.error || 'Gagal membuat user'); showToast(out.error || 'Gagal membuat user','error'); setBusy(btn,false); return }
      let msg = 'User berhasil dibuat.'
      if(out.temp_password){ msg += ' Password sementara: '+out.temp_password }
      if(out.reset_link){ msg += ' | Reset link: '+out.reset_link }
      showOkUser(msg)
      showToast('User berhasil dibuat','success')
      await loadUsers(); renderUsers()
      setBusy(btn,false);
      setTimeout(()=> closeModal('modalUser'), 1200)
    }catch(e){
      showErrUser('Network error: '+ e.message)
      showToast('Network error: '+ e.message,'error')
      setBusy(btn,false);
    }
  })

  // Edit / Reset / Toggle / Delete User (open modal)
  $('usersList').addEventListener('click', async function(e){
    const btnEdit = e.target.closest('[data-edit]')
    const btnReset= e.target.closest('[data-reset]')
    const btnTog  = e.target.closest('[data-toggle]')
    const btnDel  = e.target.closest('[data-udel]')

    if(btnEdit){
      const id = btnEdit.getAttribute('data-edit');
      const u = (users||[]).find(x=> x.id === id);
      if(!u) return;
      $('e_id').value = u.id;
      $('e_name').value = u.full_name || '';
      $('e_email').value = u.email || '';
      $('e_role').value = u.role || 'kasir';
      $('e_branch').value = u.branch_code || '';
      $('msgErrEdit').style.display='none'; $('msgOkEdit').style.display='none';
      applyBranchFieldByRole('e_role','wrap_e_branch','e_branch')
      openModal('modalEdit');
      return;
    }

    if(btnReset){
      if(gRole!=='owner'){ showToast('Hanya owner yang bisa reset password','error'); return }
      const id = btnReset.getAttribute('data-reset');

      const sess = await supabase.auth.getSession()
      const session = sess?.data?.session
      if(!session){ showToast('Session habis, login ulang','error'); return }

      try{
        const res = await fetch(FUNC_RESET_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization': 'Bearer '+session.access_token },
          body: JSON.stringify({ user_id:id })
        })
        const out = await res.json()
        if(!res.ok){ showToast(out.error || 'Gagal membuat link reset','error'); return }
        try { await navigator.clipboard.writeText(out.reset_link || '') } catch(_e){}
        showToast('Link reset dibuat & disalin ke clipboard', 'success')
      }catch(err){
        showToast('Network error: '+ err.message, 'error')
      }
      return;
    }

    if(btnTog){
      if(gRole!=='owner'){ showToast('Hanya owner yang bisa mengubah status','error'); return }
      const id = btnTog.getAttribute('data-toggle');
      const enable = btnTog.getAttribute('data-enabled') === '1';

      const sess = await supabase.auth.getSession()
      const session = sess?.data?.session
      if(!session){ showToast('Session habis, login ulang','error'); return }

      try{
        const res = await fetch(FUNC_TOGGLE_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+session.access_token },
          body: JSON.stringify({ user_id: id, enable })
        })
        const out = await res.json()
        if(!res.ok){ showToast(out.error || 'Gagal mengubah status','error'); return }
        await loadUsers(); renderUsers()
        showToast('Status pengguna diperbarui','success')
      }catch(err){
        showToast('Network error: '+err.message,'error')
      }
      return;
    }

    if(btnDel){
      if(gRole!=='owner'){ showToast('Hanya owner yang bisa menghapus user','error'); return }
      const id = btnDel.getAttribute('data-udel');
      const nm = btnDel.getAttribute('data-uname') || '';
      const em = btnDel.getAttribute('data-uemail') || '';
      $('del_user_id').value = id;
      $('msgErrDelUser').style.display='none';
      $('delUserText').innerHTML = `Yakin ingin menghapus user <strong>${nm}</strong> &lt;${em}&gt; ?<br/>Tindakan ini tidak bisa dibatalkan.`;
      openModal('modalDelUser');
      return;
    }
  })

  // Konfirmasi Hapus User (do delete)
  $('btnCloseDelUser').onclick = ()=> closeModal('modalDelUser')
  $('btnCancelDelUser').onclick = ()=> closeModal('modalDelUser')
  $('btnDoDelUser').addEventListener('click', async function(){
    const btn = this; setBusy(btn,true);
    const id = $('del_user_id').value;
    if(!id){ setBusy(btn,false); return }

    // Cegah menghapus diri sendiri secara tidak sengaja
    const { data:{ session } } = await supabase.auth.getSession();
    if(session && session.user && session.user.id === id){
      const box = $('msgErrDelUser');
      box.textContent = 'Tidak dapat menghapus akun yang sedang login.';
      box.style.display = 'block';
      showToast('Tidak dapat menghapus akun yang sedang login','error');
      setBusy(btn,false);
      return;
    }

    // Coba hapus profile (asumsi ada RLS/Edge Function yang mengizinkan owner)
    const del = await supabase.from('profiles').delete().eq('id', id);
    if(del.error){
      const box = $('msgErrDelUser');
      box.textContent = 'Gagal menghapus user: ' + del.error.message + '. Pastikan tidak ada constraint terkait (transaksi/relasi) atau izinkan via policy.';
      box.style.display='block';
      showToast('Gagal menghapus user','error');
      setBusy(btn,false);
      return;
    }

    await loadUsers(); renderUsers();
    showToast('User berhasil dihapus','success');
    setBusy(btn,false);
    closeModal('modalDelUser');
  })

  // Simpan Edit User
  $('btnSaveEdit').addEventListener('click', async function(){
    const btn = this; setBusy(btn,true);
    const id = $('e_id').value;
    const full_name = $('e_name').value.trim();
    const role = $('e_role').value;
    let branch_code = $('e_branch').value;
    const errBox=$('msgErrEdit'), okBox=$('msgOkEdit')

    function showErrEdit(t){ errBox.textContent=t; errBox.style.display='block'; okBox.style.display='none' }
    function showOkEdit(t){ okBox.textContent=t; okBox.style.display='block'; errBox.style.display='none' }

    if(!id){ showErrEdit('User tidak ditemukan'); setBusy(btn,false); return }
    if(role!=='owner' && !branch_code){ showErrEdit('Cabang wajib untuk role non-owner'); setBusy(btn,false); return }
    if(role==='owner') branch_code = null

    const sess = await supabase.auth.getSession()
    const session = sess?.data?.session
    if(!session){ showErrEdit('Session habis, login ulang'); setBusy(btn,false); return }

    try{
      const payload = { user_id:id, full_name, role }
      if(branch_code !== null) payload.branch_code = branch_code

      const res = await fetch(FUNC_UPDATE_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization': 'Bearer '+session.access_token },
        body: JSON.stringify(payload)
      })
      const out = await res.json()
      if(!res.ok){ showErrEdit(out.error || 'Gagal menyimpan perubahan'); showToast(out.error || 'Gagal menyimpan perubahan','error'); setBusy(btn,false); return }
      showOkEdit('Perubahan disimpan')
      showToast('Perubahan user disimpan','success')
      await loadUsers(); renderUsers()
      setBusy(btn,false);
      setTimeout(()=> closeModal('modalEdit'), 900)
    }catch(e){
      showErrEdit('Network error: '+ e.message)
      showToast('Network error: '+ e.message,'error')
      setBusy(btn,false);
    }
  })

  // Logout
  $('lnk-logout').addEventListener('click', async function(e){
    e.preventDefault();
    await supabase.auth.signOut(); location.href="login.html"
  })

  /* ===== Sidebar: toggler + collapse state ===== */
  const sidebarEl = document.getElementById('sidebar');
  const overlayEl = document.getElementById('overlay');
  const btnHamb   = document.getElementById('toggleSidebar');

  function toggleSidebar(open){
    const willOpen = (typeof open==='boolean') ? open : !sidebarEl.classList.contains('open');
    sidebarEl.classList.toggle('open', willOpen);
    overlayEl.classList.toggle('show', willOpen);
    document.body.classList.toggle('noscroll', willOpen);
    if(btnHamb) btnHamb.setAttribute('aria-expanded', String(willOpen));
  }
  function initSidebarToggler(){
    btnHamb?.addEventListener('click', ()=> toggleSidebar());
    overlayEl?.addEventListener('click', ()=> toggleSidebar(false));
    window.addEventListener('keyup', (e)=>{ if(e.key==='Escape') toggleSidebar(false); });
    document.querySelectorAll('.sidebar .nav a').forEach(a=>{
      a.addEventListener('click', ()=> toggleSidebar(false));
    });
  }

  // Simpan/baca state group di localStorage
  function getGroupState(k){
    const st = JSON.parse(localStorage.getItem("sidebar_groups_state") || "{}");
    return st[k] !== false; // default: terbuka
  }
  function setGroupState(k, open){
    const st = JSON.parse(localStorage.getItem("sidebar_groups_state") || "{}");
    st[k] = !!open;
    localStorage.setItem("sidebar_groups_state", JSON.stringify(st));
  }
  function initSidebarGroups(){
    document.querySelectorAll('.sidebar .group').forEach(g=>{
      const key = g.getAttribute('data-key')||'';
      if(key && !getGroupState(key)) g.classList.add('collapsed');
      const hd = g.querySelector('.group-hd');
      hd?.addEventListener('click', ()=>{
        const open = !g.classList.contains('collapsed');
        if(open) g.classList.add('collapsed'); else g.classList.remove('collapsed');
        if(key) setGroupState(key, !open);
      });
    });
  }

  // Start
  boot()
</script>

<script>
// v1.6 runtime patch: replace delete flow to use Edge Function, and wire modal edit close buttons
(function(){
  function byId(id){ return document.getElementById(id); }
  // Replace delete action on confirm button, if present
  var btn = byId('btnDoDelUser');
  if(btn && !btn.__patched){
    btn.__patched = true;
    btn.addEventListener('click', async function(){
      const self = this;
      if(typeof setBusy==='function') setBusy(self,true);
      const id = byId('del_user_id') ? byId('del_user_id').value : null;
      try{
        const sess = await supabase.auth.getSession();
        const session = sess && sess.data ? sess.data.session : null;
        if(session && session.user && session.user.id === id){
          var box = byId('msgErrDelUser');
          if(box){ box.textContent = 'Tidak dapat menghapus akun yang sedang login.'; box.style.display='block'; }
          if(typeof showToast==='function') showToast('Tidak dapat menghapus akun yang sedang login','error');
          if(typeof setBusy==='function') setBusy(self,false);
          return;
        }
        if(!session){
          var box2 = byId('msgErrDelUser');
          if(box2){ box2.textContent = 'Session habis, login ulang'; box2.style.display='block'; }
          if(typeof showToast==='function') showToast('Session habis, login ulang','error');
          if(typeof setBusy==='function') setBusy(self,false);
          return;
        }
        const res = await fetch(FUNC_DELETE_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer '+session.access_token },
          body: JSON.stringify({ user_id:id })
        });
        let out = {};
        try{ out = await res.json(); }catch(_){}
        if(!res.ok){
          var box3 = byId('msgErrDelUser');
          if(box3){ box3.textContent = 'Gagal menghapus user: ' + (out.error || res.statusText); box3.style.display='block'; }
          if(typeof showToast==='function') showToast('‚ùå Gagal menghapus user','error');
          if(typeof setBusy==='function') setBusy(self,false);
          return;
        }
        if(typeof loadUsers==='function') await loadUsers();
        if(typeof renderUsers==='function') renderUsers();
        if(typeof showToast==='function') showToast('‚úÖ User berhasil dihapus','success');
        if(typeof setBusy==='function') setBusy(self,false);
        if(typeof closeModal==='function') closeModal('modalDelUser');
      }catch(e){
        var box4 = byId('msgErrDelUser');
        if(box4){ box4.textContent = 'Network error: ' + e.message; box4.style.display='block'; }
        if(typeof showToast==='function') showToast('‚ùå Network error','error');
        if(typeof setBusy==='function') setBusy(self,false);
      }
    }, { once:false });
  }
  // Wire delete button in list (owner-only): rely on existing handler to open modal; if not, add minimal handler
  var usersList = byId('usersList');
  if(usersList && !usersList.__delWire){
    usersList.__delWire = true;
    usersList.addEventListener('click', function(e){
      var btnDel = e.target.closest && e.target.closest('[data-udel]');
      if(!btnDel) return;
      e.preventDefault();
      if(typeof gRole!=='undefined' && gRole!=='owner'){
        if(typeof showToast==='function') showToast('Hanya owner yang bisa menghapus user','error');
        return;
      }
      var id = btnDel.getAttribute('data-udel');
      var nm = btnDel.getAttribute('data-uname') || '';
      var em = btnDel.getAttribute('data-uemail') || '';
      if(byId('del_user_id')) byId('del_user_id').value = id;
      var msgBox = byId('msgErrDelUser'); if(msgBox) msgBox.style.display='none';
      if(byId('delUserText')) byId('delUserText').innerHTML = 'Yakin ingin menghapus user <strong>'+nm+'</strong> &lt;'+em+'&gt; ?<br/>Tindakan ini tidak bisa dibatalkan.';
      if(typeof openModal==='function') openModal('modalDelUser');
    });
  }
  // Wire edit modal close buttons (both X and Tutup) to close either modalEditUser or modalEdit
  function closeEditModal(){
    ['modalEditUser','modalEdit'].forEach(function(mid){
      var el = byId(mid);
      if(el){ el.classList.remove('show'); el.style.display='none'; el.setAttribute('aria-hidden','true'); }
    });
  }
  var xBtn = byId('btnCloseEdit'); if(xBtn) xBtn.onclick = closeEditModal;
  var tutupBtn = byId('btnCancelEdit'); if(tutupBtn) tutupBtn.onclick = closeEditModal;
})();
</script>

</body>
</html>