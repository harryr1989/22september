<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Manajemen Pengguna | AMKO</title>
  <style>
    :root{
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --muted:#64748b; --txt:#0f172a;
      --blue:#1d4ed8; --amber:#d97706; --green:#16a34a; --red:#be123c;
      --shadow:0 6px 18px rgba(15,23,42,.08); --touch:48px; --radius:16px;
      --safe-bottom: env(safe-area-inset-bottom, 0);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);-webkit-tap-highlight-color: transparent}
    button,input,select,textarea{font-family:inherit}

    /* Layout */
    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px;line-height:1.2}
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--pri);color:#fff}
    header{position:sticky;top:0;z-index:9;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .content{padding:16px;max-width:1100px;margin:0 auto}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f9fafb;font-size:12px}

    /* Cards/sections */
    .section{margin-top:16px}
    .section h3{margin:0 0 10px 0;font-size:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:18px;box-shadow:var(--shadow);padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;height:44px;outline:none}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:44px}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:#6b7280;text-align:left;padding:0 10px}
    .rowcard{display:grid;grid-template-columns:200px 1fr 120px 140px 120px;gap:8px;align-items:center;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:10px}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:800;color:#fff}
    .badge-owner{background:#0ea5e9}
    .badge-admin{background:#22c55e}
    .badge-kasir{background:#d97706}
    .muted{color:#64748b}
    .hint{font-size:12px;color:#475569}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
    .modal.show{display:flex}
    .dialog{width:min(560px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    .icon-input{display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff}
    .icon-input input,.icon-input select{border:none;outline:none;flex:1;font-size:15px;background:transparent}
    .dlg-ft{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--bd);background:#fafafa}
    .error{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px;display:none}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:10px;display:none}

    /* Mobile */
    @media (max-width: 840px){
      .layout{grid-template-columns:1fr}
      .sidebar{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:10}
      .brand{margin:0}
      .content{padding:12px}
      .row{grid-template-columns:1fr}
      .rowcard{grid-template-columns:1fr;gap:6px}
      .toolbar{gap:6px}
    }
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="brand">AMKO</div>
    <nav class="nav" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="master-saldo-akun.html">üí≥ Master Akun</a>
      <a href="transaksi-mini-atm.html">üèß Mini ATM</a>
      <a class="active" href="manajemen-pengguna.html">‚öôÔ∏è Manajemen</a>
      <a href="#" id="lnk-logout">üö™ Logout</a>
    </nav>
  </aside>

  <div>
    <header>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Manajemen Pengguna</h2>
        <span class="pill">Kelola cabang & user (owner)</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="me" class="pill">memuat‚Ä¶</div>
        <div id="roleBadge" class="pill">role: ‚Ä¶</div>
        <div id="branchBadge" class="pill">branch: ‚Ä¶</div>
      </div>
    </header>

    <div class="content">

      <!-- CABANG -->
      <div class="section">
        <h3>Cabang</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qBranch" class="input" placeholder="Cari cabang‚Ä¶"/>
            <button id="btnAddBranch" class="btn btn-primary">+ Tambah Cabang</button>
            <span class="hint">Owner bisa tambah cabang baru (kode unik)</span>
          </div>
          <div id="branchesWrap">
            <table class="table">
              <thead>
                <tr><th>Nama</th><th>Kode</th><th>Jumlah User</th><th>Aksi</th></tr>
              </thead>
              <tbody id="branchesBody">
                <!-- rows injected -->
              </tbody>
            </table>
            <div id="noBranch" class="muted" style="padding:8px 2px;display:none">Belum ada cabang.</div>
          </div>
        </div>
      </div>

      <!-- USER -->
      <div class="section">
        <h3>Pengguna</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qUser" class="input" placeholder="Cari nama / email‚Ä¶"/>
            <select id="fltBranch" class="input">
              <option value="">Semua cabang</option>
            </select>
            <select id="fltRole" class="input">
              <option value="">Semua role</option>
              <option value="owner">owner</option>
              <option value="admin">admin</option>
              <option value="kasir">kasir</option>
            </select>
            <button id="btnAddUser" class="btn btn-ghost">+ Tambah User</button>
            <span class="hint">Tambah user perlu jalur ‚Äúinvite‚Äù (akan kita aktifkan di step berikutnya)</span>
          </div>

          <div id="usersWrap">
            <div class="muted" style="margin:6px 0">Menampilkan pengguna berdasarkan kebijakan akses (RLS) kamu.</div>
            <div id="usersList" style="display:grid;gap:8px">
              <!-- rowcards -->
            </div>
            <div id="noUser" class="muted" style="padding:8px 2px;display:none">Belum ada pengguna.</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODAL: Tambah Cabang -->
<div class="modal" id="modalBranch">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Tambah Cabang</span>
      <button class="btn btn-ghost" id="btnCloseBranch">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div id="msgErrBranch" class="error"></div>
      <div id="msgOkBranch" class="ok"></div>

      <div>
        <label>Nama Cabang</label>
        <div class="icon-input">
          <span>üè¢</span>
          <input id="b_name" placeholder="Contoh: Cabang Samarinda"/>
        </div>
      </div>
      <div>
        <label>Kode Cabang (unik, huruf/angka tanpa spasi)</label>
        <div class="icon-input">
          <span>#</span>
          <input id="b_code" placeholder="Contoh: SMR01"/>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelBranch">Batal</button>
      <button class="btn btn-primary" id="btnSaveBranch">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Tambah User (UI only / disabled action) -->
<div class="modal" id="modalUser">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Tambah User (UI)</span>
      <button class="btn btn-ghost" id="btnCloseUser">‚úñ</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrUser" style="display:block">
        Untuk menambah user lewat UI, kita perlu jalur **invite** (admin API / edge function).  
        Di versi wireframe ini, tombol Simpan dimatikan dulu agar aman. Kita aktifkan di step berikutnya. üôÇ
      </div>

      <div class="row">
        <div>
          <label>Nama Lengkap</label>
          <div class="icon-input">
            <span>üë§</span>
            <input id="u_name" placeholder="Nama"/>
          </div>
        </div>
        <div>
          <label>Email</label>
          <div class="icon-input">
            <span>‚úâÔ∏è</span>
            <input id="u_email" placeholder="email@contoh.com"/>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Role</label>
          <div class="icon-input">
            <select id="u_role">
              <option value="kasir">kasir</option>
              <option value="admin">admin</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div>
          <label>Cabang</label>
          <div class="icon-input">
            <select id="u_branch"></select>
          </div>
        </div>
      </div>

      <div class="hint">Nantinya: klik ‚ÄúSimpan‚Äù akan mengirim **undangan** (magic link) dan buat profile dengan role & cabang yang dipilih.</div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelUser">Tutup</button>
      <button class="btn btn-primary" id="btnSaveUser" disabled>Simpan (nonaktif)</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  // === Supabase (punya kamu)
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  const $ = (id)=>document.getElementById(id)
  const cls = (q)=>document.querySelector(q)

  let gRole=null, gBranch=null, gMe=null
  let branches=[], users=[]

  const showErr = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},3500) }
  const showOk  = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},2000) }

  function pillRole(r){
    if(r==='owner') return '<span class="badge badge-owner">owner</span>'
    if(r==='admin') return '<span class="badge badge-admin">admin</span>'
    return '<span class="badge badge-kasir">kasir</span>'
  }

  function ensureOwner(action){
    if(gRole!=='owner'){ alert('Hanya Owner yang boleh '+action); return false }
    return true
  }

  // ====== Boot ======
  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }

    const { data: prof, error } = await supabase
      .from('profiles').select('id,full_name,email,role,branch_code')
      .eq('id', session.user.id).single()
    if(error){ alert('Gagal ambil profil: '+error.message); return }

    gMe = prof
    gRole = prof.role
    gBranch = prof.branch_code
    $('me').textContent = `${prof.full_name || prof.email}`
    $('roleBadge').textContent = `role: ${prof.role}`
    $('branchBadge').textContent = `branch: ${prof.branch_code}`

    // sembunyikan tombol tambah cabang untuk non-owner
    if(gRole!=='owner'){ $('btnAddBranch').style.display='none' }

    await Promise.all([loadBranches(), loadUsers()])
    renderBranches()
    renderUsers()
    fillBranchFilters()
  }

  // ====== Load Data ======
  async function loadBranches(){
    // kalau RLS membatasi, owner boleh lihat semua; pengguna biasa bisa kita batasi per branch
    let query = supabase.from('branches').select('id,code,name')
    if(gRole!=='owner'){ query = query.eq('code', gBranch) }
    const { data, error } = await query.order('name')
    if(error){ console.error(error); branches=[]; return }
    branches = data||[]
  }

  async function loadUsers(){
    // tampilkan user; untuk non-owner batasi ke branch sendiri
    let query = supabase.from('profiles')
      .select('id,full_name,email,role,branch_code')
    if(gRole!=='owner'){ query = query.eq('branch_code', gBranch) }
    const { data, error } = await query.order('full_name', { nullsFirst:true })
    if(error){ console.error(error); users=[]; return }
    users = data||[]
  }

  // ====== Render ======
  function renderBranches(){
    const tbody = $('branchesBody')
    const q = $('qBranch').value.trim().toLowerCase()
    const list = (branches||[]).filter(b => !q || (b.name||'').toLowerCase().includes(q) || (b.code||'').toLowerCase().includes(q))

    tbody.innerHTML = list.map(b=>{
      const userCount = (users||[]).filter(u=>u.branch_code===b.code).length
      const aksi = (gRole==='owner') ? `<button class="btn btn-ghost" data-edit-branch="${b.id}">Edit</button>` : `<span class="muted">-</span>`
      return `
        <tr>
          <td>
            <div class="rowcard">
              <div><strong>${b.name}</strong></div>
              <div class="muted">Kode: ${b.code}</div>
              <div>${userCount} user</div>
              <div></div>
              <div style="text-align:right">${aksi}</div>
            </div>
          </td>
        </tr>
      `
    }).join('')

    $('noBranch').style.display = list.length ? 'none' : 'block'
  }

  function renderUsers(){
    const wrap = $('usersList')
    const q = $('qUser').value.trim().toLowerCase()
    const fBranch = $('fltBranch').value
    const fRole = $('fltRole').value

    const list = (users||[]).filter(u=>{
      if(q && !((u.full_name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q))) return false
      if(fBranch && u.branch_code!==fBranch) return false
      if(fRole && u.role!==fRole) return false
      return true
    })

    wrap.innerHTML = list.map(u=>{
      return `
        <div class="rowcard">
          <div><strong>${u.full_name || '-'}</strong></div>
          <div class="muted">${u.email || '-'}</div>
          <div>${pillRole(u.role)}</div>
          <div><span class="pill">branch: ${u.branch_code||'-'}</span></div>
          <div style="text-align:right">
            <button class="btn btn-ghost" data-edit-user="${u.id}">Detail</button>
          </div>
        </div>
      `
    }).join('')

    $('noUser').style.display = list.length ? 'none' : 'block'
  }

  function fillBranchFilters(){
    const sel = $('fltBranch'); const sel2 = $('u_branch')
    const opts = ['<option value="">Semua cabang</option>'].concat(
      (branches||[]).map(b=>`<option value="${b.code}">${b.name} (${b.code})</option>`)
    )
    sel.innerHTML = opts.join('')
    sel2.innerHTML = (branches||[]).map(b=>`<option value="${b.code}">${b.name} (${b.code})</option>`).join('')
  }

  // ====== Modal helpers ======
  function openModal(id){ $(id).classList.add('show') }
  function closeModal(id){ $(id).classList.remove('show') }

  // ====== Events ======
  $('qBranch').addEventListener('input', renderBranches)
  $('qUser').addEventListener('input', renderUsers)
  $('fltBranch').addEventListener('change', renderUsers)
  $('fltRole').addEventListener('change', renderUsers)

  $('btnAddBranch').addEventListener('click', ()=>{
    if(!ensureOwner('menambah cabang')) return
    $('b_name').value=''; $('b_code').value=''
    $('msgErrBranch').style.display='none'; $('msgOkBranch').style.display='none'
    openModal('modalBranch')
  })
  $('btnCloseBranch').onclick = ()=>closeModal('modalBranch')
  $('btnCancelBranch').onclick = ()=>closeModal('modalBranch')

  $('btnSaveBranch').addEventListener('click', async ()=>{
    if(!ensureOwner('menambah cabang')) return
    const name = $('b_name').value.trim()
    const code = $('b_code').value.trim()
    if(!name || !code){ showErr($('msgErrBranch'), 'Nama & Kode wajib diisi'); return }
    if(/\s/.test(code)){ showErr($('msgErrBranch'),'Kode tidak boleh mengandung spasi'); return }

    // Cek unik
    const { data:exist, error:errChk } = await supabase.from('branches').select('id').eq('code', code).maybeSingle()
    if(errChk){ showErr($('msgErrBranch'), 'Gagal cek kode: '+errChk.message); return }
    if(exist){ showErr($('msgErrBranch'), 'Kode sudah dipakai cabang lain'); return }

    const { error } = await supabase.from('branches').insert({ name, code })
    if(error){ showErr($('msgErrBranch'), 'Gagal menambah cabang: '+error.message); return }
    showOk($('msgOkBranch'),'Cabang berhasil ditambahkan')
    await loadBranches(); renderBranches(); fillBranchFilters()
    setTimeout(()=>closeModal('modalBranch'), 600)
  })

  $('btnAddUser').addEventListener('click', ()=>{
    // UI saja dulu ‚Äî aksi simpan dimatikan
    $('u_name').value=''; $('u_email').value=''; $('u_role').value='kasir'
    $('msgErrUser').style.display='block'
    openModal('modalUser')
  })
  $('btnCloseUser').onclick = ()=>closeModal('modalUser')
  $('btnCancelUser').onclick = ()=>closeModal('modalUser')

  // Logout
  $('lnk-logout').addEventListener('click', async ()=>{
    await supabase.auth.signOut(); location.href="login.html"
  })

  boot()
</script>
</body>
</html>
