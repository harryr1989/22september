<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Manajemen Pengguna | Amko MiniLink</title>
  <style>
    :root{
      --bg:#f6f8fb; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --muted:#64748b; --txt:#0f172a;
      --shadow:0 6px 18px rgba(15,23,42,.08);
      --sidebar-w:240px;

      /* Sidebar selaras */
      --sb:#0f172a;        /* latar sidebar */
      --sbfg:#e5e7eb;      /* teks menu */
      --sb-brand:#0a5eb6;  /* bar brand */
      --sb-active:#0b3a66; /* item aktif */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt)}
    button,input,select,textarea{font-family:inherit}

    /* ===== Layout ===== */
    .layout{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100vh}

    /* ===== Sidebar (gaya baru selaras) ===== */
    .sidebar{
      background:var(--sb);color:var(--sbfg);
      display:flex;flex-direction:column;
      padding:0; /* nol seperti referensi */
      position:relative;z-index:20;
      transition:left .25s ease;
    }
    .brand{
      background:var(--sb-brand);color:#fff;
      font-weight:800;font-size:15px;
      padding:12px 14px;margin:0;
    }
    .nav{padding:6px;display:flex;flex-direction:column;gap:0;overflow:auto}
    .nav a{
      display:block;text-decoration:none;color:var(--sbfg);
      font-size:13px;font-weight:400;
      padding:8px 10px;border-radius:8px;line-height:1.2;
    }
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--sb-active);color:#fff}

    .group{
      margin-top:6px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:8px;overflow:hidden;
    }
    .group-hd{
      padding:8px 10px;background:#0e223a;color:#cfe0f3;
      font-size:12px;font-weight:400;
      display:flex;justify-content:space-between;align-items:center;cursor:pointer;
    }
    .group-hd .chev{transition:transform .2s ease}
    .group.collapsed .group-hd .chev{transform:rotate(-90deg)}
    .group-bd{padding:6px;background:#0f253f}
    .group.collapsed .group-bd{display:none}

    .sidebar-footer{margin-top:auto;padding:8px 8px 10px;font-size:11px;color:#93a3b8}
    .logout{display:block;margin-top:8px;background:#fecdd3;color:#7f1d1d;text-align:center;border-radius:10px;padding:9px 10px;font-weight:800;text-decoration:none}

    /* ===== Header / Content ===== */
    header{position:sticky;top:0;z-index:9;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .content{padding:16px;max-width:1100px;margin:0 auto}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f9fafb;font-size:12px;white-space:nowrap}

    .section{margin-top:16px}
    .section h3{margin:0 0 10px 0;font-size:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:18px;box-shadow:var(--shadow);padding:14px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 12px;font-size:15px;height:44px;outline:none;min-width:0}
    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:44px;white-space:nowrap}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
    .rowcard{
      display:grid;
      grid-template-columns: minmax(160px,1.2fr) minmax(140px,1fr) minmax(110px,.7fr) minmax(160px,1fr) minmax(160px,1fr);
      gap:8px;align-items:center;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:10px;min-width:0
    }
    .rowcard > *{min-width:0}
    .rowcard strong, .rowcard .muted, .rowcard span, .rowcard div{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .muted{color:#64748b}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:800;color:#fff}
    .badge-owner{background:#0ea5e9}
    .badge-admin{background:#22c55e}
    .badge-kasir{background:#d97706}
    .actions{display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap}
    .actions .btn{height:36px;padding:8px 10px;border-radius:10px}

    .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
    .dialog{width:min(560px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:92vh}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px;overflow:auto}
    .dlg-ft{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--bd);background:#fafafa}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    .icon-input{display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff}
    .icon-input input,.icon-input select{border:none;outline:none;flex:1;font-size:15px;background:transparent;min-width:0}
    .error{display:none;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px}
    .ok{display:none;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:10px}

    /* ===== Hamburger & Overlay ===== */
    .hamburger{font-size:22px;background:none;border:none;cursor:pointer;padding:8px;display:none}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.45);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:19}
    .overlay.show{opacity:1;pointer-events:auto}
    body.noscroll{overflow:hidden}

    /* ===== Responsive (≤980px): sidebar off-canvas) ===== */
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .sidebar{
        position:fixed; left:calc(-1 * var(--sidebar-w)); top:0; bottom:0; width:var(--sidebar-w);
      }
      .sidebar.open{ left:0; }
      .hamburger{ display:block; }
      .content{padding:12px}
      .row{grid-template-columns:1fr}
      .rowcard{grid-template-columns:1fr;gap:6px}
      .toolbar{gap:6px}
    }
  </style>
</head>
<body>
<div class="layout">
  <!-- ===== Sidebar (baru) ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Amko MiniLink</div>

    <nav class="nav">
      <!-- Menu utama -->
      <a href="dashboard.html">📊 Dashboard</a>
      <a href="transaksi-mini-atm.html">🧮 Transaksi Mini ATM</a>

      <!-- Grup MASTER DATA -->
      <div class="group" data-key="grp_master">
        <div class="group-hd">
          <span>📂 Master Data</span>
          <span class="chev">▾</span>
        </div>
        <div class="group-bd">
          <a href="master-saldo-akun.html">💰 Master Saldo Akun</a>
          <a href="mutasi-saldo.html">🔄 Mutasi Saldo</a>
          <a href="saldo-real.html">📑 Saldo Real</a>
        </div>
      </div>

      <!-- Grup LAPORAN -->
      <div class="group" data-key="grp_laporan">
        <div class="group-hd">
          <span>📘 Laporan</span>
          <span class="chev">▾</span>
        </div>
        <div class="group-bd">
          <a href="laporan.html">📘 Laporan MiniLink</a>
        </div>
      </div>

      <!-- Grup PENGATURAN -->
      <div class="group" data-key="grp_pengaturan">
        <div class="group-hd">
          <span>⚙️ Pengaturan</span>
          <span class="chev">▾</span>
        </div>
        <div class="group-bd">
          <a class="active" href="manajemen-pengguna.html">👥 Manajemen Pengguna</a>
          <a href="hak-akses.html">🔑 Hak Akses</a>
          <a href="absensi.html">🕒 Absensi</a>
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      © Amko MiniLink • v1
      <a href="#" id="lnk-logout" class="logout">🚪 Logout</a>
    </div>
  </aside>

  <!-- Overlay untuk mobile -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- ===== Main ===== -->
  <div>
    <header>
      <!-- Tombol hamburger -->
      <button id="toggleSidebar" class="hamburger" aria-label="Toggle Sidebar" aria-controls="sidebar" aria-expanded="false">☰</button>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Manajemen Pengguna</h2>
        <span class="pill">Tambah • Edit • Reset Password • Aktif/Nonaktif • Kelola Cabang</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="me" class="pill">memuat…</div>
        <div id="roleBadge" class="pill">role: …</div>
        <div id="branchBadge" class="pill">branch: …</div>
      </div>
    </header>

    <div class="content">
      <!-- CABANG -->
      <div class="section">
        <h3>Cabang</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qBranch" class="input" placeholder="Cari cabang…"/>
            <button id="btnAddBranch" class="btn btn-primary">+ Tambah Cabang</button>
          </div>
          <div id="branchesWrap">
            <div id="branchesList" style="display:grid;gap:8px"></div>
            <div id="noBranch" class="muted" style="padding:8px 2px;display:none">Belum ada cabang.</div>
          </div>
        </div>
      </div>

      <!-- USER -->
      <div class="section">
        <h3>Pengguna</h3>
        <div class="card">
          <div class="toolbar">
            <input id="qUser" class="input" placeholder="Cari nama / email…"/>
            <select id="fltBranch" class="input">
              <option value="">Semua cabang</option>
            </select>
            <select id="fltRole" class="input">
              <option value="">Semua role</option>
              <option value="owner">owner</option>
              <option value="admin">admin</option>
              <option value="kasir">kasir</option>
            </select>
            <button id="btnAddUser" class="btn btn-ghost">+ Tambah User</button>
          </div>

          <div id="usersList" style="display:grid;gap:8px"></div>
          <div id="noUser" class="muted" style="padding:8px 2px;display:none">Belum ada pengguna.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Tambah Cabang -->
<div class="modal" id="modalBranch">
  <div class="dialog">
    <div class="dlg-hd">
      <span id="titleBranch">Tambah Cabang</span>
      <button class="btn btn-ghost" id="btnCloseBranch">✖</button>
    </div>
    <div class="dlg-bd">
      <div id="msgErrBranch" class="error"></div>
      <div id="msgOkBranch" class="ok"></div>

      <input type="hidden" id="b_id"/>
      <div>
        <label>Nama Cabang</label>
        <div class="icon-input">
          <span>🏢</span>
          <input id="b_name" placeholder="Contoh: Cabang Samarinda"/>
        </div>
      </div>
      <div>
        <label>Kode Cabang (unik, tanpa spasi)</label>
        <div class="icon-input">
          <span>#</span>
          <input id="b_code" placeholder="Contoh: SMR01"/>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelBranch">Batal</button>
      <button class="btn btn-primary" id="btnSaveBranch">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Hapus Cabang -->
<div class="modal" id="modalDelBranch">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Hapus Cabang</span>
      <button class="btn btn-ghost" id="btnCloseDelBranch">✖</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrDelBranch" style="display:none"></div>
      <p id="delText" style="margin:0">Yakin ingin menghapus cabang ini?</p>
      <input type="hidden" id="del_id"/>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelDelBranch">Batal</button>
      <button class="btn btn-danger" id="btnDoDelBranch">Hapus</button>
    </div>
  </div>
</div>

<!-- MODAL: Tambah User -->
<div class="modal" id="modalUser">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Tambah User</span>
      <button class="btn btn-ghost" id="btnCloseUser">✖</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrUser"></div>
      <div class="ok" id="msgOkUser"></div>

      <div class="row">
        <div>
          <label>Nama Lengkap</label>
          <div class="icon-input">
            <span>👤</span>
            <input id="u_name" placeholder="Nama"/>
          </div>
        </div>
        <div>
          <label>Email</label>
          <div class="icon-input">
            <span>✉️</span>
            <input id="u_email" placeholder="email@contoh.com"/>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Role</label>
          <div class="icon-input">
            <select id="u_role">
              <option value="kasir">kasir</option>
              <option value="admin">admin</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div id="wrap_u_branch">
          <label>Cabang</label>
          <div class="icon-input">
            <select id="u_branch"></select>
          </div>
        </div>
      </div>

      <div>
        <label>Password (opsional)</label>
        <div class="icon-input">
          <span>🔑</span>
          <input id="u_password" placeholder="Minimal 6 karakter (atau kosongkan → auto-generate)"/>
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px">Kosongkan bila ingin password sementara & reset link.</div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelUser">Tutup</button>
      <button class="btn btn-primary" id="btnSaveUser">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: Edit User -->
<div class="modal" id="modalEdit">
  <div class="dialog">
    <div class="dlg-hd">
      <span>Edit User</span>
      <button class="btn btn-ghost" id="btnCloseEdit">✖</button>
    </div>
    <div class="dlg-bd">
      <div class="error" id="msgErrEdit"></div>
      <div class="ok" id="msgOkEdit"></div>

      <input type="hidden" id="e_id"/>

      <div class="row">
        <div>
          <label>Nama Lengkap</label>
          <div class="icon-input">
            <span>👤</span>
            <input id="e_name" placeholder="Nama"/>
          </div>
        </div>
        <div>
          <label>Email (read-only)</label>
          <div class="icon-input">
            <span>✉️</span>
            <input id="e_email" placeholder="email@contoh.com" readonly/>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Role</label>
          <div class="icon-input">
            <select id="e_role">
              <option value="kasir">kasir</option>
              <option value="admin">admin</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div id="wrap_e_branch">
          <label>Cabang</label>
          <div class="icon-input">
            <select id="e_branch"></select>
          </div>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn" id="btnCancelEdit">Tutup</button>
      <button class="btn btn-primary" id="btnSaveEdit">Simpan</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  /* ===== Supabase (frontend pakai ANON) ===== */
  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  /* ===== Edge Functions ===== */
  const FUNC_CREATE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/clever-processor";
  const FUNC_UPDATE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/super-endpoint";
  const FUNC_RESET_URL  = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/admin-reset-password";
  const FUNC_TOGGLE_URL = "https://kfqcdcvcnyhisbmwftzb.supabase.co/functions/v1/admin-set-user-active";

  const $ = (id)=>document.getElementById(id)
  const showErr = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},3500) }
  const showOk  = (el, t)=>{ el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none'},2500) }
  const pill = (r)=> r==='owner' ? 'badge-owner' : (r==='admin'?'badge-admin':'badge-kasir')

  let gRole=null, gBranch=null
  let branches=[], users=[]

  function openModal(id){ $(id).style.display='flex' }
  function closeModal(id){ $(id).style.display='none' }

  // ==== Sembunyikan field cabang saat role=owner ====
  function applyBranchFieldByRole(roleSelId, branchWrapId, branchSelId){
    const roleSel = $(roleSelId)
    const brWrap  = $(branchWrapId)
    const brSel   = $(branchSelId)
    if(!roleSel || !brWrap) return
    if(roleSel.value === 'owner'){
      brWrap.style.display = 'none'
      if(brSel) brSel.value = ''
    }else{
      brWrap.style.display = ''
      if(roleSelId==='u_role' && brSel && !brSel.value){
        brSel.value = gBranch || (branches[0]?.code || '')
      }
    }
  }

  // ===== Boot =====
  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href='login.html'; return }

    const { data: prof, error } = await supabase
      .from('profiles').select('id,full_name,email,role,branch_code')
      .eq('id', session.user.id).single()
    if(error){ alert('Gagal ambil profil: '+error.message); return }

    gRole = (prof.role||'').toLowerCase(); gBranch = prof.branch_code
    $('me').textContent = `${prof.full_name || prof.email}`
    $('roleBadge').textContent = `role: ${gRole}`
    $('branchBadge').textContent = `branch: ${prof.branch_code}`

    await Promise.all([loadBranches(), loadUsers()])
    renderBranches(); renderUsers(); fillBranchFilters()

    applyBranchFieldByRole('u_role','wrap_u_branch','u_branch')
    applyBranchFieldByRole('e_role','wrap_e_branch','e_branch')

    $('u_role').addEventListener('change', ()=> applyBranchFieldByRole('u_role','wrap_u_branch','u_branch'))
    $('e_role').addEventListener('change', ()=> applyBranchFieldByRole('e_role','wrap_e_branch','e_branch'))

    initSidebarToggler();
    initSidebarGroups();
  }

  // ===== Load data =====
  async function loadBranches(){
    const { data, error } = await supabase
      .from('branches')
      .select('id,code,name')
      .order('name');
    if(error){ console.error(error); branches=[]; return }
    branches = data || []
  }

  async function loadUsers(){
    let q = supabase.from('profiles').select('id,full_name,email,role,branch_code,is_active')
    if(gRole!=='owner') q = q.eq('branch_code', gBranch)
    const { data, error } = await q.order('full_name', { nullsFirst:true })
    if(error){ console.error(error); users=[]; return }
    users = data || []
  }

  // ===== Render =====
  function renderBranches(){
    const q = $('qBranch').value?.trim().toLowerCase() || ''
    const list = (branches||[]).filter(b => !q || (b.name||'').toLowerCase().includes(q) || (b.code||'').toLowerCase().includes(q))
    $('branchesList').innerHTML = list.map(b=>`
      <div class="rowcard">
        <div title="${b.name||''}"><strong>${b.name||'-'}</strong></div>
        <div class="muted">Kode: ${b.code||'-'}</div>
        <div>${(users||[]).filter(u=>u.branch_code===b.code).length} user</div>
        <div></div>
        <div class="actions">
          <button class="btn btn-ghost" data-bedit="${b.id}">Edit</button>
          <button class="btn btn-danger" data-bdel="${b.id}" data-bname="${(b.name||'').replace(/"/g,'&quot;')}">Hapus</button>
        </div>
      </div>
    `).join('')
    $('noBranch').style.display = list.length ? 'none' : 'block'
  }

  function renderUsers(){
    const q = $('qUser').value?.trim().toLowerCase() || ''
    const fB = $('fltBranch').value
    const fR = $('fltRole').value
    const list = (users||[]).filter(function(u){
      if(q && !((u.full_name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q))) return false
      if(fB && u.branch_code!==fB) return false
      if(fR && u.role!==fR) return false
      return true
    })
    $('usersList').innerHTML = list.map(function(u){
      const isActive = (u.is_active !== false)
      const statusPill = isActive
        ? '<span class="pill" style="border-color:#86efac;background:#ecfdf5;color:#166534">aktif</span>'
        : '<span class="pill" style="border-color:#fecaca;background:#fef2f2;color:#991b1b">nonaktif</span>';
      const toggleBtn = (gRole==='owner')
        ? `<button class="btn btn-ghost" data-toggle="${u.id}" data-enabled="${isActive ? '0' : '1'}">${isActive ? 'Nonaktifkan' : 'Aktifkan'}</button>`
        : '';
      return `
        <div class="rowcard">
          <div title="${u.full_name||''}"><strong>${u.full_name || '-'}</strong></div>
          <div class="muted" title="${u.email||''}">${u.email||'-'}</div>
          <div><span class="badge ${pill(u.role)}">${u.role}</span></div>
          <div><span class="pill">branch: ${u.branch_code||'-'}</span> &nbsp; ${statusPill}</div>
          <div class="actions">
            <button class="btn btn-ghost" data-edit="${u.id}">Edit</button>
            ${gRole==='owner' ? `<button class="btn btn-ghost" data-reset="${u.id}">Reset PW</button>` : ``}
            ${toggleBtn}
          </div>
        </div>`
    }).join('')
    $('noUser').style.display = list.length ? 'none' : 'block'
  }

  function fillBranchFilters(){
    const sel = $('fltBranch'); const selAdd = $('u_branch'); const selEdit = $('e_branch')
    sel.innerHTML = ['<option value="">Semua cabang</option>']
      .concat((branches||[]).map(b=> `<option value="${b.code}">${b.name} (${b.code})</option>`)).join('')
    const opts = (branches||[]).map(b=> `<option value="${b.code}">${b.name} (${b.code})</option>`).join('')
    selAdd.innerHTML = opts
    selEdit.innerHTML = opts
    selAdd.value = gBranch || ''

    applyBranchFieldByRole('u_role','wrap_u_branch','u_branch')
    applyBranchFieldByRole('e_role','wrap_e_branch','e_branch')
  }

  // ===== Events =====
  $('qBranch').addEventListener('input', renderBranches)
  $('qUser').addEventListener('input', renderUsers)
  $('fltBranch').addEventListener('change', renderUsers)
  $('fltRole').addEventListener('change', renderUsers)

  // Cabang: Tambah
  $('btnAddBranch').addEventListener('click', function(){
    $('titleBranch').textContent = 'Tambah Cabang'
    $('b_id').value = ''
    $('b_name').value=''; $('b_code').value='';
    $('msgErrBranch').style.display='none'; $('msgOkBranch').style.display='none';
    openModal('modalBranch')
  })
  $('btnCloseBranch').onclick = ()=> closeModal('modalBranch')
  $('btnCancelBranch').onclick = ()=> closeModal('modalBranch')

  // Cabang: Simpan (tambah / edit)
  $('btnSaveBranch').addEventListener('click', async function(){
    const id = $('b_id').value
    const name = $('b_name').value.trim()
    const code = $('b_code').value.trim()
    if(!name || !code){ showErr($('msgErrBranch'),'Nama & Kode wajib'); return }
    if(/\s/.test(code)){ showErr($('msgErrBranch'),'Kode tanpa spasi'); return }

    const exist = await supabase.from('branches').select('id,code').eq('code', code).maybeSingle()
    if(exist.error && exist.error.code!=='PGRST116'){ showErr($('msgErrBranch'),'Cek kode: '+exist.error.message); return }
    if(exist.data && (!id || exist.data.id!==id)){ showErr($('msgErrBranch'),'Kode sudah dipakai'); return }

    let res
    if(id){ res = await supabase.from('branches').update({ name, code }).eq('id', id) }
    else  { res = await supabase.from('branches').insert({ name, code }) }
    if(res.error){ showErr($('msgErrBranch'), (id?'Gagal menyimpan: ':'Gagal tambah cabang: ')+res.error.message); return }
    showOk($('msgOkBranch'), id?'Perubahan disimpan':'Cabang ditambahkan')
    await loadBranches(); renderBranches(); fillBranchFilters()
    setTimeout(()=> closeModal('modalBranch'), 700)
  })

  // Cabang: Edit & Hapus
  $('branchesList').addEventListener('click', function(e){
    const t = e.target.closest('[data-bedit],[data-bdel]')
    if(!t) return
    if(t.hasAttribute('data-bedit')){
      const id = t.getAttribute('data-bedit')
      const b = (branches||[]).find(x=> x.id===id)
      if(!b) return
      $('titleBranch').textContent = 'Edit Cabang'
      $('b_id').value = b.id
      $('b_name').value = b.name || ''
      $('b_code').value = b.code || ''
      $('msgErrBranch').style.display='none'; $('msgOkBranch').style.display='none';
      openModal('modalBranch')
    }else if(t.hasAttribute('data-bdel')){
      const id = t.getAttribute('data-bdel')
      const nm = t.getAttribute('data-bname') || ''
      $('del_id').value = id
      $('msgErrDelBranch').style.display='none'
      $('delText').innerHTML = `Yakin ingin menghapus cabang <strong>${nm}</strong>?<br/>Data terkait (user/akun) bisa menghalangi penghapusan.`
      openModal('modalDelBranch')
    }
  })

  // Cabang: Konfirmasi Hapus
  $('btnCloseDelBranch').onclick = ()=> closeModal('modalDelBranch')
  $('btnCancelDelBranch').onclick = ()=> closeModal('modalDelBranch')
  $('btnDoDelBranch').addEventListener('click', async function(){
    const id = $('del_id').value
    if(!id) return
    const del = await supabase.from('branches').delete().eq('id', id)
    if(del.error){
      const box = $('msgErrDelBranch')
      box.textContent = 'Gagal hapus: '+ del.error.message + ' (Pastikan tidak ada user/akun yang masih pakai kode cabang ini)'
      box.style.display='block'
      return
    }
    await loadBranches(); renderBranches(); fillBranchFilters()
    closeModal('modalDelBranch')
  })

  // Tambah User
  $('btnAddUser').addEventListener('click', function(){
    $('u_name').value=''; $('u_email').value='';
    $('u_role').value='kasir';
    $('u_branch').value = gBranch || (branches[0]?.code || '');
    $('u_password').value='';
    $('msgErrUser').style.display='none'; $('msgOkUser').style.display='none';
    applyBranchFieldByRole('u_role','wrap_u_branch','u_branch')
    openModal('modalUser')
  })
  $('btnCloseUser').onclick = ()=> closeModal('modalUser')
  $('btnCancelUser').onclick = ()=> closeModal('modalUser')

  // Simpan Tambah User
  $('btnSaveUser').addEventListener('click', async function(){
    const full_name = $('u_name').value.trim()
    const email = $('u_email').value.trim().toLowerCase()
    const role = $('u_role').value
    let branch_code = $('u_branch').value
    const password = $('u_password').value.trim()
    const errBox=$('msgErrUser'), okBox=$('msgOkUser')

    function showErrUser(t){ errBox.textContent=t; errBox.style.display='block'; okBox.style.display='none' }
    function showOkUser(t){ okBox.textContent=t; okBox.style.display='block'; errBox.style.display='none' }

    if(!email){ showErrUser('Email wajib'); return }
    if(role!=='owner' && !branch_code){ showErrUser('Cabang wajib untuk role non-owner'); return }
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){ showErrUser('Format email tidak valid'); return }
    if(password && password.length < 6){ showErrUser('Password minimal 6 karakter'); return }

    if(role==='owner') branch_code = null

    const sess = await supabase.auth.getSession()
    const session = sess?.data?.session
    if(!session){ showErrUser('Session habis, login ulang'); return }

    try{
      const payload = { email, full_name, role }
      if(branch_code !== null) payload.branch_code = branch_code
      if(password) payload.password = password

      const res = await fetch(FUNC_CREATE_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization': 'Bearer '+session.access_token },
        body: JSON.stringify(payload)
      })
      const out = await res.json()
      if(!res.ok){ showErrUser(out.error || 'Gagal membuat user'); return }
      let msg = 'User berhasil dibuat.'
      if(out.temp_password){ msg += ' Password sementara: '+out.temp_password }
      if(out.reset_link){ msg += ' | Reset link: '+out.reset_link }
      showOkUser(msg)
      await loadUsers(); renderUsers()
      setTimeout(()=> closeModal('modalUser'), 1200)
    }catch(e){
      showErrUser('Network error: '+ e.message)
    }
  })

  // Edit / Reset / Toggle User
  $('usersList').addEventListener('click', async function(e){
    const btnEdit = e.target.closest('[data-edit]')
    const btnReset= e.target.closest('[data-reset]')
    const btnTog  = e.target.closest('[data-toggle]')

    if(btnEdit){
      const id = btnEdit.getAttribute('data-edit');
      const u = (users||[]).find(x=> x.id === id);
      if(!u) return;
      $('e_id').value = u.id;
      $('e_name').value = u.full_name || '';
      $('e_email').value = u.email || '';
      $('e_role').value = u.role || 'kasir';
      $('e_branch').value = u.branch_code || '';
      $('msgErrEdit').style.display='none'; $('msgOkEdit').style.display='none';
      applyBranchFieldByRole('e_role','wrap_e_branch','e_branch')
      openModal('modalEdit');
      return;
    }

    if(btnReset){
      if(gRole!=='owner'){ alert('Hanya owner'); return }
      const id = btnReset.getAttribute('data-reset');

      const sess = await supabase.auth.getSession()
      const session = sess?.data?.session
      if(!session){ alert('Session habis, login ulang'); return }

      try{
        const res = await fetch(FUNC_RESET_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization': 'Bearer '+session.access_token },
          body: JSON.stringify({ user_id:id })
        })
        const out = await res.json()
        if(!res.ok){ alert(out.error || 'Gagal membuat link reset'); return }
        try { await navigator.clipboard.writeText(out.reset_link || '') } catch(_e){}
        alert('Link reset dibuat & disalin ke clipboard:\n\n'+ (out.reset_link || '(kosong)'))
      }catch(err){
        alert('Network error: '+ err.message)
      }
      return;
    }

    if(btnTog){
      if(gRole!=='owner'){ alert('Hanya owner'); return }
      const id = btnTog.getAttribute('data-toggle');
      const enable = btnTog.getAttribute('data-enabled') === '1';

      const sess = await supabase.auth.getSession()
      const session = sess?.data?.session
      if(!session){ alert('Session habis, login ulang'); return }

      try{
        const res = await fetch(FUNC_TOGGLE_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+session.access_token },
          body: JSON.stringify({ user_id: id, enable })
        })
        const out = await res.json()
        if(!res.ok){ alert(out.error || 'Gagal mengubah status'); return }
        await loadUsers(); renderUsers()
      }catch(err){
        alert('Network error: '+err.message)
      }
      return;
    }
  })

  // Simpan Edit User
  $('btnSaveEdit').addEventListener('click', async function(){
    const id = $('e_id').value;
    const full_name = $('e_name').value.trim();
    const role = $('e_role').value;
    let branch_code = $('e_branch').value;
    const errBox=$('msgErrEdit'), okBox=$('msgOkEdit')

    function showErrEdit(t){ errBox.textContent=t; errBox.style.display='block'; okBox.style.display='none' }
    function showOkEdit(t){ okBox.textContent=t; okBox.style.display='block'; errBox.style.display='none' }

    if(!id){ showErrEdit('User tidak ditemukan'); return }
    if(role!=='owner' && !branch_code){ showErrEdit('Cabang wajib untuk role non-owner'); return }
    if(role==='owner') branch_code = null

    const sess = await supabase.auth.getSession()
    const session = sess?.data?.session
    if(!session){ showErrEdit('Session habis, login ulang'); return }

    try{
      const payload = { user_id:id, full_name, role }
      if(branch_code !== null) payload.branch_code = branch_code

      const res = await fetch(FUNC_UPDATE_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization': 'Bearer '+session.access_token },
        body: JSON.stringify(payload)
      })
      const out = await res.json()
      if(!res.ok){ showErrEdit(out.error || 'Gagal menyimpan perubahan'); return }
      showOkEdit('Perubahan disimpan')
      await loadUsers(); renderUsers()
      setTimeout(()=> closeModal('modalEdit'), 900)
    }catch(e){
      showErrEdit('Network error: '+ e.message)
    }
  })

  // Tutup modal Edit
  $('btnCloseEdit').onclick = ()=> closeModal('modalEdit')
  $('btnCancelEdit').onclick = ()=> closeModal('modalEdit')

  // Logout
  $('lnk-logout').addEventListener('click', async function(e){
    e.preventDefault();
    await supabase.auth.signOut(); location.href="login.html"
  })

  /* ===== Sidebar: toggler + collapse state ===== */
  const sidebarEl = document.getElementById('sidebar');
  const overlayEl = document.getElementById('overlay');
  const btnHamb   = document.getElementById('toggleSidebar');

  function toggleSidebar(open){
    const willOpen = (typeof open==='boolean') ? open : !sidebarEl.classList.contains('open');
    sidebarEl.classList.toggle('open', willOpen);
    overlayEl.classList.toggle('show', willOpen);
    document.body.classList.toggle('noscroll', willOpen);
    if(btnHamb) btnHamb.setAttribute('aria-expanded', String(willOpen));
  }
  btnHamb?.addEventListener('click', ()=> toggleSidebar());
  overlayEl?.addEventListener('click', ()=> toggleSidebar(false));
  window.addEventListener('keyup', (e)=>{ if(e.key==='Escape') toggleSidebar(false); });
  document.querySelectorAll('.sidebar .nav a').forEach(a=>{
    a.addEventListener('click', ()=> toggleSidebar(false));
  });

  // Simpan/baca state group di localStorage
  function getGroupState(k){
    const st = JSON.parse(localStorage.getItem("sidebar_groups_state") || "{}");
    return st[k] !== false; // default: terbuka
  }
  function setGroupState(k, open){
    const st = JSON.parse(localStorage.getItem("sidebar_groups_state") || "{}");
    st[k] = !!open;
    localStorage.setItem("sidebar_groups_state", JSON.stringify(st));
  }
  function initSidebarGroups(){
    document.querySelectorAll('.sidebar .group').forEach(g=>{
      const key = g.getAttribute('data-key')||'';
      if(key && !getGroupState(key)) g.classList.add('collapsed');
      const hd = g.querySelector('.group-hd');
      hd?.addEventListener('click', ()=>{
        const open = !g.classList.contains('collapsed');
        if(open) g.classList.add('collapsed'); else g.classList.remove('collapsed');
        if(key) setGroupState(key, !open);
      });
    });
  }

  // Start
  boot()
</script>
</body>
</html>
