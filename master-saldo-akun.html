<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Master Akun Saldo | AMKO</title>
  <style>
    :root{
      --bg:#f6f8fb; --sb:#0d1b2a; --sbfg:#cbd5e1; --pri:#0b63f3;
      --card:#fff; --bd:#e5e7eb; --muted:#64748b; --txt:#0f172a;
      --blue:#1d4ed8; --amber:#d97706; --yellow:#f59e0b; --red:#be123c;
      --shadow:0 6px 18px rgba(15,23,42,.08);
      --touch:48px; --radius:16px; --safe-bottom: env(safe-area-inset-bottom, 0);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);-webkit-tap-highlight-color: transparent}
    button,input,select,textarea{font-family:inherit}

    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}

    /* ===== Sidebar (disesuaikan) ===== */
    .sidebar{background:var(--sb);color:var(--sbfg);padding:16px 14px;display:flex;flex-direction:column}
    .brand{color:#fff;font-weight:800;font-size:20px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--sbfg);text-decoration:none;padding:10px 12px;border-radius:10px;line-height:1.2;display:block}
    .nav a:hover{background:rgba(255,255,255,.10)}
    .nav a.active{background:var(--pri);color:#fff}

    /* Grup sidebar */
    .group{margin-top:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .group-hd{padding:8px 10px;background:#0f2238;color:#cfe0f3;font-size:12px;font-weight:800;display:flex;justify-content:space-between;align-items:center;letter-spacing:.2px;text-transform:uppercase}
    .group-bd{padding:6px;background:#0f253f}

    /* Footer sidebar */
    .sidebar-footer{margin-top:auto;padding-top:10px;font-size:11px;color:#93a3b8}
    .logout{display:block;margin-top:8px;background:#fecdd3;color:#7f1d1d;text-align:center;border-radius:10px;padding:9px 10px;font-weight:800;text-decoration:none}

    /* ===== Header / konten (ori) ===== */
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--bd);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .content{padding:16px;max-width:1100px;margin:0 auto}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f9fafb;font-size:12px}

    .topbar{position:sticky;top:54px;z-index:9;background:linear-gradient(#fff,#fff 75%,transparent);padding:12px 16px;border-bottom:1px solid var(--bd)}
    .searchbar{display:grid;grid-template-columns:1fr auto auto;gap:8px}
    .input{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:12px 12px;font-size:16px;height:var(--touch);outline:none}

    .btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;height:var(--touch)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-blue{background:#2563eb;color:#fff}
    .btn-gray{background:#eef2f6}
    .btn-ghost{background:#f1f5f9}
    .btn-danger{background:#fee2e2;color:#991b1b}

    .grid{display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:16px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:22px;box-shadow:var(--shadow);padding:16px}
    .row-head{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .avatar{width:44px;height:44px;border-radius:50%;background:#22c55e;color:#fff;display:grid;place-items:center;font-weight:800}
    .card h3{margin:0 0 4px 0;font-size:18px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;color:#fff}
    .badge-bank{background:var(--blue)}
    .badge-laci{background:var(--amber)}
    .badge-server{background:var(--yellow);color:#1f2937}
    .kv{margin:6px 0;font-size:15px}
    .kv b{color:#991b1b}
    .muted{color:var(--muted);font-size:12px}
    .actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}

    .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
    .modal.show{display:flex}
    .dialog{width:min(760px,100%);background:#fff;border-radius:16px;border:1px solid var(--bd);overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:92vh}
    .dlg-hd{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:14px;display:grid;gap:12px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    .icon-input{display:flex;gap:8px;align-items:center;border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff;min-height:var(--touch)}
    .icon-input input,.icon-input select,.icon-input textarea{border:none;outline:none;flex:1;font-size:16px;background:transparent}
    .icon-input textarea{min-height:96px;resize:vertical}
    .dlg-ft{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--bd);padding:12px 16px;display:flex;gap:8px;justify-content:flex-end}

    .error{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px;display:none}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;display:none}

    @media (max-width: 840px){
      .layout{grid-template-columns:1fr}
      .sidebar{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:11}
      .brand{margin:0}
      .content{padding:12px}
      .grid{grid-template-columns:1fr}
      .topbar{top:56px;padding:10px 12px}
      header{padding:10px}
      .dialog{width:100%;height:100%;max-height:none;border-radius:0}
      .dlg-hd{padding:12px 14px}
      .dlg-bd{padding:12px;gap:10px}
      .row{grid-template-columns:1fr}
      .dlg-ft{padding-bottom:calc(12px + var(--safe-bottom))}
      .fab{display:flex}
    }

    .fab{
      position:fixed;right:14px;bottom:calc(14px + var(--safe-bottom));
      width:56px;height:56px;border-radius:999px;background:var(--pri);color:#fff;
      display:none;align-items:center;justify-content:center;
      box-shadow:0 10px 24px rgba(11,99,243,.35);z-index:15;font-size:26px;font-weight:900
    }
    .fab:active{transform:translateY(1px)}
  </style>
</head>
<body>

<div class="layout">
  <aside class="sidebar">
    <div class="brand">Amko MiniLink</div>

    <!-- ===== NAV: sesuai struktur yang kamu minta ===== -->
    <nav class="nav">
      <!-- Menu utama -->
      <a href="dashboard.html">📊 Dashboard</a>
      <a href="transaksi-mini-atm.html">🧮 Transaksi Mini ATM</a>

      <!-- Grup MASTER DATA -->
      <div class="group">
        <div class="group-hd"><span>MASTER DATA</span><span>▾</span></div>
        <div class="group-bd">
          <a class="active" href="master-saldo-akun.html">💰 Master Saldo Akun</a>
          <a href="mutasi-saldo.html">🔄 Mutasi Saldo</a>
          <a href="saldo-real.html">📑 Saldo Real</a>
        </div>
      </div>

      <!-- Grup LAPORAN -->
      <div class="group">
        <div class="group-hd"><span>LAPORAN</span><span>▾</span></div>
        <div class="group-bd">
          <a href="laporan.html">📘 Laporan MiniLink</a>
        </div>
      </div>

      <!-- Grup PENGATURAN -->
      <div class="group">
        <div class="group-hd"><span>PENGATURAN</span><span>▾</span></div>
        <div class="group-bd">
          <a href="manajemen-pengguna.html">👥 Manajemen Pengguna</a>
          <a href="hak-akses.html">🔑 Hak Akses</a>
          <a href="absensi.html">🕒 Absensi</a>
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      © Amko MiniLink • v1
      <a href="#" id="lnk-logout" class="logout">🚪 Logout</a>
    </div>
  </aside>

  <!-- ====== BAGIAN LAIN TETAP ORI (TIDAK DIUBAH) ====== -->
  <div>
    <header>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Master Akun Saldo</h2>
        <span class="pill" style="font-size:11px">Owner: CRUD • Non-owner: edit Saldo/Saldo Awal/Keterangan</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <div id="me" class="pill">memuat…</div>
        <div id="roleBadge" class="pill">role: …</div>
        <div id="branchBadge" class="pill">branch: …</div>
      </div>
    </header>

    <div class="topbar">
      <!-- Owner only -->
      <div id="branchRow" style="display:none; margin-bottom:10px; gap:8px; align-items:center; flex-wrap:wrap">
        <span style="font-size:12px;color:#475569;">Cabang</span>
        <select id="branchSelect" class="input" style="width:260px;max-width:100%">
          <option value="">Memuat cabang…</option>
        </select>
      </div>

      <!-- 🔔 Badge info owner -->
      <div id="ownerNotice" class="pill" style="display:none; margin:6px 0 12px 0; background:#ecfeff; border-color:#a5f3fc; color:#0c4a6e;">
        Mode Owner: aksi <b>Tambah / Edit / Hapus</b> hanya untuk cabang <b id="ownerNoticeBranch">-</b>.
      </div>

      <div class="searchbar">
        <input id="q" class="input" placeholder="Cari Bank / Ewallet / Server Pulsa…">
        <button id="btnCari" class="btn btn-blue">Cari</button>
        <button id="btnClear" class="btn btn-gray">Clear</button>
      </div>
      <div style="margin-top:10px">
        <button id="btnAdd" class="btn btn-primary">+ Tambah Data</button>
      </div>
    </div>

    <div class="content">
      <div id="grid" class="grid"></div>
    </div>
  </div>
</div>

<button id="fabAdd" class="fab" title="Tambah">+</button>

<div class="modal" id="modal">
  <div class="dialog">
    <div class="dlg-hd">
      <span id="dlgTitle">Tambah / Edit Akun Saldo</span>
      <button class="btn btn-ghost" id="btnClose" style="height:40px">✖</button>
    </div>
    <div class="dlg-bd">
      <div id="msgErr" class="error"></div>
      <div id="msgOk" class="ok"></div>

      <div class="row">
        <div>
          <label>Jenis Saldo</label>
          <div class="icon-input">
            <span>📂</span>
            <select id="m_type" required>
              <option value="">Pilih Jenis Saldo</option>
              <option value="rekening">REKENING</option>
              <option value="cash">CASH</option>
              <option value="server_pulsa">SERVER PULSA</option>
            </select>
          </div>
        </div>
        <div>
          <label>Nama Platform</label>
          <div class="icon-input">
            <span>🏦</span>
            <input id="m_name" placeholder="Contoh: BRI (538) / LACI TUNAI / ORDER KUOTA" required />
          </div>
        </div>
      </div>

      <div class="row" style="grid-template-columns:1fr">
        <div>
          <label>Saldo</label>
          <div class="icon-input">
            <span>Rp</span>
            <input id="m_saldo" inputmode="numeric" placeholder="0" />
          </div>
        </div>
        <div>
          <label>&nbsp;</label>
          <label class="icon-input" style="gap:10px">
            <input id="m_is_opening" type="checkbox" />
            Jadikan Saldo Awal (saldo_awal = Saldo)
          </label>
        </div>
      </div>

      <div>
        <label>Keterangan</label>
        <div class="icon-input">
          <textarea id="m_note" rows="3" placeholder="Catatan jika perlu..."></textarea>
        </div>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn btn-gray" id="btnCancel">Batal</button>
      <button class="btn btn-primary" id="btnSave">Simpan</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  const supabaseUrl = "https://kfqcdcvcnyhisbmwftzb.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWNkY3ZjbnloaXNibXdmdHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MTY0ODIsImV4cCI6MjA3NDA5MjQ4Mn0.EMp1XoHvi7CcN91lQW8mhfLQnaZHpCGkVo93Q3Ty03Y";
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  const $ = (id)=>document.getElementById(id)
  const fmtRp = n => "Rp " + new Intl.NumberFormat('id-ID').format(Number(n||0))
  const TYPE_BADGE = t => t==='rekening' ? 'badge-bank' : t==='cash' ? 'badge-laci' : 'badge-server'
  const TYPE_LABEL = { rekening:'BANK', cash:'CASH', server_pulsa:'SERVER PULSA' }

  let gRole=null, gBranch=null
  let viewBranch=null
  let editId=null
  let cacheRows=[]

  const isOwner = ()=> gRole === 'owner'  // setelah normalisasi

  // ✅ Hanya boleh mutasi pada cabang yang sedang dipilih (owner)
  const canMutateBranch = (accBranch) => {
    if (!isOwner()) return false;
    const current = (viewBranch || gBranch || '').trim();
    return (accBranch || '').trim() === current;
  };

  const showErr = (t)=>{ const el=$('msgErr'); el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none';},3500); }
  const showOk  = (t)=>{ const el=$('msgOk');  el.textContent=t; el.style.display='block'; setTimeout(()=>{el.style.display='none';},2000); }

  function openModal(title){ $('dlgTitle').textContent = title; $('modal').classList.add('show') }
  function closeModal(){
    $('modal').classList.remove('show')
    editId=null
    $('m_type').value=''
    $('m_name').value=''
    $('m_saldo').value=''
    $('m_is_opening').checked=false
    $('m_note').value=''
    $('m_type').disabled=false
    $('m_name').disabled=false
  }

  ;(()=>{ // format ribuan
    const el = $('m_saldo')
    el.addEventListener('input', e=>{
      const raw = e.target.value.replace(/\D/g,'')
      e.target.value = raw ? new Intl.NumberFormat('id-ID').format(Number(raw)) : ''
    })
    el.addEventListener('paste', e=>{
      e.preventDefault()
      const text = (e.clipboardData || window.clipboardData).getData('text')
      const digits = (text||'').replace(/\D/g,'')
      el.value = digits ? new Intl.NumberFormat('id-ID').format(Number(digits)) : ''
    })
  })();

  async function boot(){
    const { data:{ session } } = await supabase.auth.getSession()
    if(!session){ location.href="login.html"; return }

    const { data: prof, error } = await supabase
      .from('profiles').select('role,branch_code,full_name,email')
      .eq('id', session.user.id).single()
    if(error){ alert("Gagal ambil profil: "+error.message); return }

    // 🔧 NORMALISASI ROLE
    gRole   = (prof.role || '').toString().trim().toLowerCase()
    gBranch = (prof.branch_code || '').toString().trim()
    viewBranch = gBranch

    $('me').textContent = `${prof.full_name || prof.email}`
    $('roleBadge').textContent = `role: ${gRole}`
    $('branchBadge').textContent = `branch: ${viewBranch || '-'}`

    if(isOwner()){
      $('fabAdd').style.display='flex'
      $('branchRow').style.display='flex'
      $('ownerNotice').style.display='inline-block'
      $('ownerNoticeBranch').textContent = viewBranch || '-'
      await loadBranches()
    }else{
      $('fabAdd').style.display='none'
      $('branchRow').style.display='none'
      $('ownerNotice').style.display='none'
    }

    await loadAccounts()
  }

  async function loadBranches(){
    const sel = $('branchSelect')
    sel.innerHTML = `<option value="">Memuat cabang…</option>`
    let list = []

    // Coba dari tabel branches
    const { data: br, error: ebr } = await supabase.from('branches').select('code,name').order('name')
    if(!ebr && br && br.length){
      list = br.map(b=>({code:(b.code||'').trim(), name:b.name || b.code}))
    }else{
      // Fallback: distinct dari accounts.branch_code
      const { data: accs, error: ea } = await supabase.from('accounts').select('branch_code').order('branch_code')
      const set = new Set((accs||[]).map(a=>(a.branch_code||'').trim()).filter(Boolean))
      list = Array.from(set).map(code=>({code, name: code}))
      if(list.length===0 && gBranch){ list = [{code:gBranch, name:gBranch}] }
    }

    if(list.length===0){
      sel.innerHTML = `<option value="">(Belum ada cabang)</option>`
      return
    }

    sel.innerHTML = list.map(b=>`<option value="${b.code}">${b.code} — ${b.name}</option>`).join('')
    sel.value = viewBranch || list[0].code
    if(!viewBranch) viewBranch = sel.value

    sel.onchange = ()=>{
      viewBranch = sel.value
      $('branchBadge').textContent = `branch: ${viewBranch}`
      if (isOwner()){
        $('ownerNoticeBranch').textContent = viewBranch || '-'
      }
      loadAccounts()
    }
  }

  async function loadAccounts(){
    const cab = viewBranch || gBranch
    const { data, error } = await supabase
      .from('accounts')
      .select('id,name,account_type,saldo,saldo_awal,note,updated_at,branch_code')
      .eq('branch_code', cab)
      .order('name')
    if(error){ alert("Gagal ambil akun: "+error.message); return }
    cacheRows = data || []

    // PIN Laci Tunai ke atas
    cacheRows.sort((a,b)=>{
      const aLaci = a.account_type==='cash' && (a.name||'').toLowerCase().includes('laci')
      const bLaci = b.account_type==='cash' && (b.name||'').toLowerCase().includes('laci')
      if(aLaci && !bLaci) return -1
      if(!aLaci && bLaci) return 1
      return (a.name||'').localeCompare(b.name||'')
    })

    renderCards(cacheRows)
  }

  function renderCards(rows){
    const q = $('q').value.trim().toLowerCase()
    const list = rows.filter(a => !q || a.name.toLowerCase().includes(q))

    $('grid').innerHTML = list.map(a=>{
      const inisial = (a.name||'?').trim().charAt(0).toUpperCase()
      const badgeCls = TYPE_BADGE(a.account_type)
      const badgeTxt = TYPE_LABEL[a.account_type] || a.account_type
      const updated  = a.updated_at ? new Date(a.updated_at).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}) : '-'
      const isLaci   = a.account_type==='cash' && (a.name||'').toLowerCase().includes('laci')

      // 🔒 Kontrol aksi berdasarkan cabang & role
      const canEdit = isOwner() ? canMutateBranch(a.branch_code) : true;
      const editBtn = canEdit
        ? `<button class="btn btn-ghost" onclick="editAccount('${a.id}')">Edit</button>`
        : `<button class="btn btn-ghost" disabled title="Pilih cabang ini untuk mengubah">Edit</button>`;

      const delBtn = (isOwner() && canMutateBranch(a.branch_code) && !isLaci)
        ? `<button class="btn btn-danger" onclick="delAccount('${a.id}')">Hapus</button>`
        : ``;

      return `
        <div class="card">
          <div class="row-head">
            <div class="avatar">${inisial}</div>
            <div style="flex:1">
              <h3>${a.name}</h3>
              <span class="badge ${badgeCls}">${badgeTxt}</span>
            </div>
          </div>

          <div class="kv">Saldo : <b>${fmtRp(a.saldo)}</b></div>
          <div class="kv">Saldo Awal : <b>${fmtRp(a.saldo_awal)}</b></div>

          <div class="muted" style="margin-top:8px">Update: ${updated}</div>
          <div class="muted">Keterangan : ${a.note ? a.note : '-'}</div>

          <div class="actions">
            ${editBtn}
            ${delBtn}
          </div>
        </div>
      `
    }).join('')
  }

  $('btnCari').onclick = ()=> renderCards(cacheRows)
  $('btnClear').onclick = ()=> { $('q').value=''; renderCards(cacheRows) }
  $('q').addEventListener('keydown', e => { if(e.key==='Enter') renderCards(cacheRows) })

  function openAdd(){
    if(!isOwner()){ alert('Hanya Owner yang boleh menambah akun'); return }
    if (isOwner() && !viewBranch){
      alert('Pilih cabang terlebih dahulu sebelum menambah akun.')
      return
    }
    openModal('Tambah Master Saldo')
  }
  $('btnAdd').onclick = openAdd
  $('fabAdd').onclick = openAdd

  $('btnClose').onclick = $('btnCancel').onclick = closeModal

  window.editAccount = async (id)=>{
    const { data, error } = await supabase.from('accounts').select('*').eq('id', id).single()
    if(error){ alert(error.message); return }

    // 🔒 Guard menurut role & cabang
    if (isOwner()){
      if (!canMutateBranch(data.branch_code)) { alert('Hanya bisa mengedit akun pada cabang yang sedang dipilih.'); return }
    } else {
      const myBranch = (gBranch || '').trim()
      if ((data.branch_code || '').trim() !== myBranch){ alert('Tidak bisa mengedit akun di cabang lain.'); return }
    }

    editId = id
    $('m_type').value  = data.account_type
    $('m_name').value  = data.name
    $('m_saldo').value = new Intl.NumberFormat('id-ID').format(Number(data.saldo||0))
    $('m_is_opening').checked = false
    $('m_note').value  = data.note||''

    const nonOwner = !isOwner();
    $('m_type').disabled = nonOwner
    $('m_name').disabled = nonOwner

    openModal('Edit Akun Saldo')
  }

  window.delAccount = async (id)=>{
    const { data, error } = await supabase.from('accounts')
      .select('id,name,account_type,branch_code').eq('id', id).single()
    if(error){ alert(error.message); return }

    const isLaci = data && data.account_type==='cash' && (data.name||'').toLowerCase().includes('laci')
    if(isLaci){ alert("Akun LACI TUNAI tidak dapat dihapus."); return }
    if(!isOwner()){ alert('Hanya Owner yang boleh menghapus akun'); return }
    if (!canMutateBranch(data.branch_code)){ alert('Hanya bisa menghapus akun pada cabang yang sedang dipilih.'); return }

    if(!confirm('Yakin hapus akun ini?')) return
    const { error:errDel } = await supabase.from('accounts').delete().eq('id', id)
    if(errDel){ alert(errDel.message); return }
    loadAccounts()
  }

  $('btnSave').onclick = async ()=>{
    const type = $('m_type').value
    const name = $('m_name').value.trim()
    const saldo = Number(String($('m_saldo').value).replace(/[^0-9]/g,'')) || 0
    const makeOpening = $('m_is_opening').checked
    const note = $('m_note').value.trim()
    const cab = viewBranch || gBranch

    if(editId){
      const nonOwner = !isOwner();
      let patch = { account_type:type, name, saldo, note, updated_at:new Date().toISOString() }
      if(makeOpening) patch.saldo_awal = saldo
      if(nonOwner){
        patch = { saldo, note, updated_at:new Date().toISOString() }
        if(makeOpening) patch.saldo_awal = saldo
      }
      const { error } = await supabase.from('accounts').update(patch).eq('id', editId)
      if(error){ showErr('Simpan gagal: '+error.message); return }
      showOk('Berhasil diperbarui.')
    }else{
      if(!isOwner()){ alert('Hanya Owner yang boleh menambah akun'); return }
      if (!viewBranch){ showErr('Pilih cabang terlebih dahulu sebelum menambah akun.'); return }

      const isLaciCandidate = type==='cash' && /laci/i.test(name)
      if(isLaciCandidate){
        const { data: exist, error: errExist } = await supabase
          .from('accounts').select('id')
          .eq('branch_code', cab).eq('account_type','cash').ilike('name','%laci%')
        if(errExist){ showErr('Cek duplikasi gagal: '+errExist.message); return }
        if((exist||[]).length>0){ showErr('Akun LACI TUNAI sudah ada.'); return }
      }
      const row = { account_type:type, name, saldo, saldo_awal:(makeOpening?saldo:0), branch_code:cab, note }
      const { error } = await supabase.from('accounts').insert(row)
      iferror:{}
      if(error){ showErr('Simpan gagal: '+error.message); return }
      showOk('Berhasil ditambahkan.')
    }
    closeModal()
    loadAccounts()
  }

  document.getElementById('lnk-logout').addEventListener('click', async ()=>{
    await supabase.auth.signOut(); location.href="login.html"
  })

  boot()
</script>
</body>
</html>
